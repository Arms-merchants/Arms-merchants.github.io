<html>
  <head>
    <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Kotlinå…³é”®å­—by lazyä¸­çš„Modeåˆ†æ | Arms-merchants</title>
<link rel="shortcut icon" href="https://arms-merchants.github.io//favicon.ico?v=1704441990587">
<link href="https://cdn.jsdelivr.net/npm/remixicon@2.3.0/fonts/remixicon.css" rel="stylesheet">
<link rel="stylesheet" href="https://arms-merchants.github.io//styles/main.css">
<link rel="alternate" type="application/atom+xml" title="Kotlinå…³é”®å­—by lazyä¸­çš„Modeåˆ†æ | Arms-merchants - Atom Feed" href="https://arms-merchants.github.io//atom.xml">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Droid+Serif:400,700">



    <meta name="description" content="    class TestManager private constructor(){
        companion object{
            val instance by lazy(LazyThreadSafety..." />
    <meta name="keywords" content="kotlin" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">
    <script src="https://cdn.bootcss.com/highlight.js/9.12.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="main">
      <div class="main-content">
        <div class="site-header">
  <a href="https://arms-merchants.github.io/">
  <img class="avatar" src="https://arms-merchants.github.io//images/avatar.png?v=1704441990587" alt="">
  </a>
  <h1 class="site-title">
    Arms-merchants
  </h1>
  <p class="site-description">
    æ¸©æ•…è€ŒçŸ¥æ–°
  </p>
  <div class="menu-container">
    
      
        <a href="/" class="menu">
          é¦–é¡µ
        </a>
      
    
      
        <a href="/archives" class="menu">
          å½’æ¡£
        </a>
      
    
      
        <a href="/tags" class="menu">
          æ ‡ç­¾
        </a>
      
    
      
        <a href="/post/about" class="menu">
          å…³äº
        </a>
      
    
  </div>
  <div class="social-container">
    
      
    
      
    
      
    
      
    
      
    
  </div>
</div>

        <div class="post-detail">
          <article class="post">
            <h2 class="post-title">
              Kotlinå…³é”®å­—by lazyä¸­çš„Modeåˆ†æ
            </h2>
            <div class="post-info">
              <span>
                2023-05-16
              </span>
              <span>
                5 min read
              </span>
              
                <a href="https://arms-merchants.github.io/tag/kotlin/" class="post-tag">
                  # kotlin
                </a>
              
            </div>
            
              <img class="post-feature-image" src="https://images.unsplash.com/photo-1684162485237-bda5fab36be0?ixlib=rb-4.0.3&amp;ixid=MnwxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8&amp;auto=format&amp;fit=crop&amp;w=774&amp;q=80" alt="">
            
            <div class="post-content-wrapper">
              <div class="post-content">
                <pre><code class="language-java">    class TestManager private constructor(){
        companion object{
            val instance by lazy(LazyThreadSafetyMode.SYNCHRONIZED){
                TestManager()
            }
        }
    }
</code></pre>
<p>ä¸Šé¢ä»£ç æ˜¯å¸¸è§çš„Kotlinä¸­é€šè¿‡byå…³é”®å­—æ¥åˆ›å»ºå•ä¾‹å¯¹è±¡çš„å®ç°ï¼Œä½†lazyä¸­çš„Modeæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>
äº†è§£è¿™äº›ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€å•åˆ†åˆ«è¯´ä¸‹lazyå’Œbyï¼Œå…¶ä¸­byæ˜¯Kotlinä¸­ç”¨äºå§”æ‰˜çš„å…³é”®å­—ï¼Œè€Œlazyæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå…¶è¿”å›å€¼æ˜¯å§”æ‰˜çš„å…·ä½“å¯¹è±¡ã€‚by lazyç”¨äºå®ç°æ•°æ®çš„æƒ°æ€§åŠ è½½ï¼Œåœ¨åˆå§‹åŒ–ä¸€ä¸ªå¸¸é‡æ—¶ç¡®ä¿å…¶ä¸ä¼šè¢«å¤šæ¬¡åˆå§‹åŒ–ã€‚<br>
LazyThreadSafetyModeçš„å€¼æœ‰ä¸‰ä¸ªï¼Œé€šè¿‡å®ƒæ¥ç¡®å®šå¯¹è±¡çš„åˆ›å»ºæ¨¡å¼ï¼š</p>
<ul>
<li>LazyThreadSafetyMode.SYNCHRONIZED</li>
<li>LazyThreadSafetyMode.PUBLICATION</li>
<li>LazyThreadSafetyMode.NONE</li>
</ul>
<p>lazyæ–¹æ³•é»˜è®¤æ˜¯ä½¿ç”¨SynchronizedLazyImplæ¥è¿”å›å§”æ‰˜çš„å…·ä½“å¯¹è±¡çš„ã€‚<br>
Lazyå®ç°äº†by lazyçš„æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@kotlin.internal.InlineOnly
public inline operator fun &lt;T&gt; Lazy&lt;T&gt;.getValue(thisRef: Any?, property: KProperty&lt;*&gt;): T = value
</code></pre>
<p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è·å–åˆ°çš„å€¼å°±æ˜¯è¿™ä¸ªvalueï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦æ¥çœ‹è¿™ä¸ªvalueæ˜¯æ€ä¹ˆè·å–åˆ°çš„ã€‚åˆ†æä¸‰ç§Modeä¸‹valueä¸åŒå–å€¼ï¼Œå¯ä»¥ç¡®å®šåç»­æˆ‘ä»¬åœ¨ä½¿ç”¨by lazyæ—¶åº”è¯¥ä½¿ç”¨é‚£ç§Modeï¼Œé¦–å…ˆå…ˆçœ‹SynchronizedLazyImplçš„å®ç°ï¼š</p>
<pre><code class="language-java">private class SynchronizedLazyImpl&lt;out T&gt;(initializer: () -&gt; T, lock: Any? = null) : Lazy&lt;T&gt;, Serializable {
    //lazyåçš„æ–¹æ³•ä½“ï¼Œè¿”å›å½“å‰éœ€è¦åˆ›å»ºçš„å¯¹è±¡
    private var initializer: (() -&gt; T)? = initializer
    //é»˜è®¤å€¼ï¼Œå®šä¹‰äº†ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å€¼ï¼Œä¸ºäº†è§£å†³DCLå¸¦æ¥æŒ‡ä»¤é‡æ’åºå¯¼è‡´ä¸»å­˜å’Œå·¥ä½œå†…å­˜æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè¿™é‡Œä½¿ç”¨VolatileåŸè¯­æ³¨è§£ï¼Œçº¿ç¨‹å®‰å…¨
    @Volatile private var _value: Any? = UNINITIALIZED_VALUE
    //é”
    // final field is required to enable safe publication of constructed instance
    private val lock = lock ?: this

    override val value: T
        //è·å–valueçš„å€¼å°±æ˜¯é€šè¿‡getæ–¹æ³•
        get() {
            val _v1 = _value
            //å¦‚æœå½“å‰çš„å€¼å·²ç»ä¸æ˜¯æœªåˆå§‹åŒ–çš„äº†é‚£ä¹ˆç›´æ¥è¿”å›
            if (_v1 !== UNINITIALIZED_VALUE) {
                @Suppress(&quot;UNCHECKED_CAST&quot;)
                return _v1 as T
            }

            return synchronized(lock) {
                //åŒé‡æ£€æµ‹
                val _v2 = _value
                if (_v2 !== UNINITIALIZED_VALUE) {
                    @Suppress(&quot;UNCHECKED_CAST&quot;) (_v2 as T)
                } else {
                    //å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œé‚£ä¹ˆé€šè¿‡initializeræ¥è¿›è¡Œåˆå§‹åŒ–æ“ä½œ
                    val typedValue = initializer!!()
                    //å¹¶å°†è¿™ä¸ªå€¼ä¿å­˜åœ¨_valueä¸­
                    _value = typedValue
                    initializer = null
                    typedValue
                }
            }
        }

    override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE

    override fun toString(): String = if (isInitialized()) value.toString() else &quot;Lazy value not initialized yet.&quot;

    private fun writeReplace(): Any = InitializedLazyImpl(value)
}
</code></pre>
<p>SafePublicationLazyImplçš„å®ç°ï¼š</p>
<pre><code class="language-java">private class SafePublicationLazyImpl&lt;out T&gt;(initializer: () -&gt; T) : Lazy&lt;T&gt;, Serializable {
    @Volatile private var initializer: (() -&gt; T)? = initializer
    @Volatile private var _value: Any? = UNINITIALIZED_VALUE
    // this final field is required to enable safe initialization of the constructed instance
    private val final: Any = UNINITIALIZED_VALUE

    override val value: T
        get() {
            val value = _value
            if (value !== UNINITIALIZED_VALUE) {
                @Suppress(&quot;UNCHECKED_CAST&quot;)
                return value as T
            }
            val initializerValue = initializer
            // if we see null in initializer here, it means that the value is already set by another thread
            if (initializerValue != null) {
                   //å¦‚æœæ˜¯å¤šçº¿ç¨‹çš„è¯ï¼Œåˆå§‹åŒ–æ–¹æ³•ä¼šè°ƒç”¨å¤šæ¬¡
                val newValue = initializerValue()
                //é€šè¿‡CASä¿è¯åªæœ‰åœ¨åŸå§‹å€¼ä¸ºUNINITIALIZED_VALUEæ—¶èµ‹å€¼
                if (valueUpdater.compareAndSet(this, UNINITIALIZED_VALUE, newValue)) {
                    initializer = null
                    return newValue
                }
            }
            @Suppress(&quot;UNCHECKED_CAST&quot;)
            return _value as T
        }

    override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE

    override fun toString(): String = if (isInitialized()) value.toString() else &quot;Lazy value not initialized yet.&quot;

    private fun writeReplace(): Any = InitializedLazyImpl(value)

    companion object {
        private val valueUpdater = 
        //javaä¸­çš„åŸå­æ“ä½œ
        java.util.concurrent.atomic.AtomicReferenceFieldUpdater.newUpdater(
            SafePublicationLazyImpl::class.java,
            Any::class.java,
            &quot;_value&quot;
        )
    }
}
</code></pre>
<p>UnsafeLazyImplçš„å®ç°ï¼š</p>
<pre><code class="language-java">internal class UnsafeLazyImpl&lt;out T&gt;(initializer: () -&gt; T) : Lazy&lt;T&gt;, Serializable {
    private var initializer: (() -&gt; T)? = initializer
    private var _value: Any? = UNINITIALIZED_VALUE

    override val value: T
        get() {
            //åªæ˜¯æ˜¯æœªåˆå§‹åŒ–é‚£ä¹ˆå°±è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•
            //å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå®ƒçš„å€¼ä¸ºæœ€åçš„èµ‹å€¼æ–¹æ³•ï¼Œçº¿ç¨‹ä¸å®‰å…¨
            if (_value === UNINITIALIZED_VALUE) {
                _value = initializer!!()
                initializer = null
            }
            @Suppress(&quot;UNCHECKED_CAST&quot;)
            return _value as T
        }

    override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE

    override fun toString(): String = if (isInitialized()) value.toString() else &quot;Lazy value not initialized yet.&quot;

    private fun writeReplace(): Any = InitializedLazyImpl(value)
}
</code></pre>
<p>ç»è¿‡ä¸Šé¢çš„æºç åˆ†æï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡ºä¸‰ç§Modeçš„åŒºåˆ«ï¼š</p>
<ul>
<li>LazyThreadSafetyMode.SYNCHRONIZED é€šè¿‡synchronizedå…³é”®å€¼åˆ›å»ºåŒæ­¥é”æ¥å®ç°çº¿ç¨‹å®‰å…¨</li>
<li>LazyThreadSafetyMode.PUBLICATION é€šè¿‡CASæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¤šçº¿ç¨‹çš„æƒ…å†µä¸‹åˆå§‹åŒ–æ–¹æ³•ä¼šè°ƒç”¨ï¼Œä½†åªæœ‰ä¸€ä¸ªç”Ÿæ•ˆã€‚</li>
<li>LazyThreadSafetyMode.NONEï¼Œåªè¦æ ‡è¯†ä¸ºæœªåˆå§‹åŒ–å°±è°ƒç”¨åˆå§‹åŒ–æ¥èµ‹å€¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨ã€‚</li>
</ul>
<p>æ‰€ä»¥ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œåœ¨ç¡®å®šå½“å‰å±æ€§ä¸ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„æ—¶å€™ï¼Œåˆ™å¯ä»¥ä½¿ç”¨NONEæ¨¡å¼ï¼Œè¿™æ˜¯æœ€å¿«çš„æ¨¡å¼ï¼Œä½†ä¹Ÿæ˜¯æœ€ä¸å®‰å…¨çš„æ¨¡å¼ã€‚<br>
å¦‚æœå±æ€§æ˜¯è¦åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ï¼Œé‚£ä¹ˆä½¿ç”¨SYNCHRONIZEDå’ŒPUBLICATIONï¼Œä½†å› ä¸ºSYNCHRONIZEDå¼•å…¥äº†é”çš„æœºåˆ¶ï¼Œå®ƒæ˜¯æœ€å®‰å…¨çš„ï¼Œä½†ä¹Ÿæ˜¯æœ€æ…¢çš„æ¨¡å¼ã€‚æŠ˜ä¸­çš„è¯åˆ™å¯ä»¥ä½¿ç”¨PUBLICATIONã€‚</p>

              </div>
              <div class="toc-container">
                
              </div>
            </div>
          </article>
        </div>

        
          <div class="next-post">
            <div class="next">ä¸‹ä¸€ç¯‡</div>
            <a href="https://arms-merchants.github.io/post/dui-closeable-de-zi-dong-guan-bi-chu-li-yu-fa/">
              <h3 class="post-title">
                å¯¹Closeableçš„è‡ªåŠ¨å…³é—­å¤„ç†ï¼Œè¯­æ³•ğŸ¬
              </h3>
            </a>
          </div>
        

        

        <div class="site-footer">
  Powered by <a href="https://github.com/Arms-merchants" target="_blank">Arms-merchants</a>
  <a class="rss" href="https://arms-merchants.github.io//atom.xml" target="_blank">
    <i class="ri-rss-line"></i> RSS
  </a>
</div>

      </div>
    </div>

    <script>
      hljs.initHighlightingOnLoad()

      let mainNavLinks = document.querySelectorAll(".markdownIt-TOC a");

      // This should probably be throttled.
      // Especially because it triggers during smooth scrolling.
      // https://lodash.com/docs/4.17.10#throttle
      // You could do like...
      // window.addEventListener("scroll", () => {
      //    _.throttle(doThatStuff, 100);
      // });
      // Only not doing it here to keep this Pen dependency-free.

      window.addEventListener("scroll", event => {
        let fromTop = window.scrollY;

        mainNavLinks.forEach((link, index) => {
          let section = document.getElementById(decodeURI(link.hash).substring(1));
          let nextSection = null
          if (mainNavLinks[index + 1]) {
            nextSection = document.getElementById(decodeURI(mainNavLinks[index + 1].hash).substring(1));
          }
          if (section.offsetTop <= fromTop) {
            if (nextSection) {
              if (nextSection.offsetTop > fromTop) {
                link.classList.add("current");
              } else {
                link.classList.remove("current");    
              }
            } else {
              link.classList.add("current");
            }
          } else {
            link.classList.remove("current");
          }
        });
      });

    </script>
  </body>
</html>
