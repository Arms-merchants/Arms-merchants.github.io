<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://arms-merchants.github.io/</id>
    <title>Arms-merchants</title>
    <updated>2023-05-17T01:08:48.881Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://arms-merchants.github.io/"/>
    <link rel="self" href="https://arms-merchants.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://arms-merchants.github.io/images/avatar.png</logo>
    <icon>https://arms-merchants.github.io/favicon.ico</icon>
    <rights>All rights reserved 2023, Arms-merchants</rights>
    <entry>
        <title type="html"><![CDATA[Kotlinå…³é”®å­—by lazyä¸­çš„Modeåˆ†æ]]></title>
        <id>https://arms-merchants.github.io/post/kotlin-guan-jian-zi-by-lazy-zhong-de-mode-fen-xi/</id>
        <link href="https://arms-merchants.github.io/post/kotlin-guan-jian-zi-by-lazy-zhong-de-mode-fen-xi/">
        </link>
        <updated>2023-05-16T08:42:58.000Z</updated>
        <content type="html"><![CDATA[<pre><code class="language-java">    class TestManager private constructor(){
        companion object{
            val instance by lazy(LazyThreadSafetyMode.SYNCHRONIZED){
                TestManager()
            }
        }
    }
</code></pre>
<p>ä¸Šé¢ä»£ç æ˜¯å¸¸è§çš„Kotlinä¸­é€šè¿‡byå…³é”®å­—æ¥åˆ›å»ºå•ä¾‹å¯¹è±¡çš„å®ç°ï¼Œä½†lazyä¸­çš„Modeæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>
äº†è§£è¿™äº›ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€å•åˆ†åˆ«è¯´ä¸‹lazyå’Œbyï¼Œå…¶ä¸­byæ˜¯Kotlinä¸­ç”¨äºå§”æ‰˜çš„å…³é”®å­—ï¼Œè€Œlazyæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå…¶è¿”å›å€¼æ˜¯å§”æ‰˜çš„å…·ä½“å¯¹è±¡ã€‚by lazyç”¨äºå®ç°æ•°æ®çš„æƒ°æ€§åŠ è½½ï¼Œåœ¨åˆå§‹åŒ–ä¸€ä¸ªå¸¸é‡æ—¶ç¡®ä¿å…¶ä¸ä¼šè¢«å¤šæ¬¡åˆå§‹åŒ–ã€‚<br>
LazyThreadSafetyModeçš„å€¼æœ‰ä¸‰ä¸ªï¼Œé€šè¿‡å®ƒæ¥ç¡®å®šå¯¹è±¡çš„åˆ›å»ºæ¨¡å¼ï¼š</p>
<ul>
<li>LazyThreadSafetyMode.SYNCHRONIZED</li>
<li>LazyThreadSafetyMode.PUBLICATION</li>
<li>LazyThreadSafetyMode.NONE</li>
</ul>
<p>lazyæ–¹æ³•é»˜è®¤æ˜¯ä½¿ç”¨SynchronizedLazyImplæ¥è¿”å›å§”æ‰˜çš„å…·ä½“å¯¹è±¡çš„ã€‚<br>
Lazyå®ç°äº†by lazyçš„æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@kotlin.internal.InlineOnly
public inline operator fun &lt;T&gt; Lazy&lt;T&gt;.getValue(thisRef: Any?, property: KProperty&lt;*&gt;): T = value
</code></pre>
<p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è·å–åˆ°çš„å€¼å°±æ˜¯è¿™ä¸ªvalueï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦æ¥çœ‹è¿™ä¸ªvalueæ˜¯æ€ä¹ˆè·å–åˆ°çš„ã€‚åˆ†æä¸‰ç§Modeä¸‹valueä¸åŒå–å€¼ï¼Œå¯ä»¥ç¡®å®šåç»­æˆ‘ä»¬åœ¨ä½¿ç”¨by lazyæ—¶åº”è¯¥ä½¿ç”¨é‚£ç§Modeï¼Œé¦–å…ˆå…ˆçœ‹SynchronizedLazyImplçš„å®ç°ï¼š</p>
<pre><code class="language-java">private class SynchronizedLazyImpl&lt;out T&gt;(initializer: () -&gt; T, lock: Any? = null) : Lazy&lt;T&gt;, Serializable {
    //lazyåçš„æ–¹æ³•ä½“ï¼Œè¿”å›å½“å‰éœ€è¦åˆ›å»ºçš„å¯¹è±¡
    private var initializer: (() -&gt; T)? = initializer
    //é»˜è®¤å€¼ï¼Œå®šä¹‰äº†ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å€¼ï¼Œä¸ºäº†è§£å†³DCLå¸¦æ¥æŒ‡ä»¤é‡æ’åºå¯¼è‡´ä¸»å­˜å’Œå·¥ä½œå†…å­˜æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè¿™é‡Œä½¿ç”¨VolatileåŸè¯­æ³¨è§£ï¼Œçº¿ç¨‹å®‰å…¨
    @Volatile private var _value: Any? = UNINITIALIZED_VALUE
    //é”
    // final field is required to enable safe publication of constructed instance
    private val lock = lock ?: this

    override val value: T
        //è·å–valueçš„å€¼å°±æ˜¯é€šè¿‡getæ–¹æ³•
        get() {
            val _v1 = _value
            //å¦‚æœå½“å‰çš„å€¼å·²ç»ä¸æ˜¯æœªåˆå§‹åŒ–çš„äº†é‚£ä¹ˆç›´æ¥è¿”å›
            if (_v1 !== UNINITIALIZED_VALUE) {
                @Suppress(&quot;UNCHECKED_CAST&quot;)
                return _v1 as T
            }

            return synchronized(lock) {
                //åŒé‡æ£€æµ‹
                val _v2 = _value
                if (_v2 !== UNINITIALIZED_VALUE) {
                    @Suppress(&quot;UNCHECKED_CAST&quot;) (_v2 as T)
                } else {
                    //å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œé‚£ä¹ˆé€šè¿‡initializeræ¥è¿›è¡Œåˆå§‹åŒ–æ“ä½œ
                    val typedValue = initializer!!()
                    //å¹¶å°†è¿™ä¸ªå€¼ä¿å­˜åœ¨_valueä¸­
                    _value = typedValue
                    initializer = null
                    typedValue
                }
            }
        }

    override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE

    override fun toString(): String = if (isInitialized()) value.toString() else &quot;Lazy value not initialized yet.&quot;

    private fun writeReplace(): Any = InitializedLazyImpl(value)
}
</code></pre>
<p>SafePublicationLazyImplçš„å®ç°ï¼š</p>
<pre><code class="language-java">private class SafePublicationLazyImpl&lt;out T&gt;(initializer: () -&gt; T) : Lazy&lt;T&gt;, Serializable {
    @Volatile private var initializer: (() -&gt; T)? = initializer
    @Volatile private var _value: Any? = UNINITIALIZED_VALUE
    // this final field is required to enable safe initialization of the constructed instance
    private val final: Any = UNINITIALIZED_VALUE

    override val value: T
        get() {
            val value = _value
            if (value !== UNINITIALIZED_VALUE) {
                @Suppress(&quot;UNCHECKED_CAST&quot;)
                return value as T
            }
            val initializerValue = initializer
            // if we see null in initializer here, it means that the value is already set by another thread
            if (initializerValue != null) {
                   //å¦‚æœæ˜¯å¤šçº¿ç¨‹çš„è¯ï¼Œåˆå§‹åŒ–æ–¹æ³•ä¼šè°ƒç”¨å¤šæ¬¡
                val newValue = initializerValue()
                //é€šè¿‡CASä¿è¯åªæœ‰åœ¨åŸå§‹å€¼ä¸ºUNINITIALIZED_VALUEæ—¶èµ‹å€¼
                if (valueUpdater.compareAndSet(this, UNINITIALIZED_VALUE, newValue)) {
                    initializer = null
                    return newValue
                }
            }
            @Suppress(&quot;UNCHECKED_CAST&quot;)
            return _value as T
        }

    override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE

    override fun toString(): String = if (isInitialized()) value.toString() else &quot;Lazy value not initialized yet.&quot;

    private fun writeReplace(): Any = InitializedLazyImpl(value)

    companion object {
        private val valueUpdater = 
        //javaä¸­çš„åŸå­æ“ä½œ
        java.util.concurrent.atomic.AtomicReferenceFieldUpdater.newUpdater(
            SafePublicationLazyImpl::class.java,
            Any::class.java,
            &quot;_value&quot;
        )
    }
}
</code></pre>
<p>UnsafeLazyImplçš„å®ç°ï¼š</p>
<pre><code class="language-java">internal class UnsafeLazyImpl&lt;out T&gt;(initializer: () -&gt; T) : Lazy&lt;T&gt;, Serializable {
    private var initializer: (() -&gt; T)? = initializer
    private var _value: Any? = UNINITIALIZED_VALUE

    override val value: T
        get() {
            //åªæ˜¯æ˜¯æœªåˆå§‹åŒ–é‚£ä¹ˆå°±è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•
            //å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå®ƒçš„å€¼ä¸ºæœ€åçš„èµ‹å€¼æ–¹æ³•ï¼Œçº¿ç¨‹ä¸å®‰å…¨
            if (_value === UNINITIALIZED_VALUE) {
                _value = initializer!!()
                initializer = null
            }
            @Suppress(&quot;UNCHECKED_CAST&quot;)
            return _value as T
        }

    override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE

    override fun toString(): String = if (isInitialized()) value.toString() else &quot;Lazy value not initialized yet.&quot;

    private fun writeReplace(): Any = InitializedLazyImpl(value)
}
</code></pre>
<p>ç»è¿‡ä¸Šé¢çš„æºç åˆ†æï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡ºä¸‰ç§Modeçš„åŒºåˆ«ï¼š</p>
<ul>
<li>LazyThreadSafetyMode.SYNCHRONIZED é€šè¿‡synchronizedå…³é”®å€¼åˆ›å»ºåŒæ­¥é”æ¥å®ç°çº¿ç¨‹å®‰å…¨</li>
<li>LazyThreadSafetyMode.PUBLICATION é€šè¿‡CASæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¤šçº¿ç¨‹çš„æƒ…å†µä¸‹åˆå§‹åŒ–æ–¹æ³•ä¼šè°ƒç”¨ï¼Œä½†åªæœ‰ä¸€ä¸ªç”Ÿæ•ˆã€‚</li>
<li>LazyThreadSafetyMode.NONEï¼Œåªè¦æ ‡è¯†ä¸ºæœªåˆå§‹åŒ–å°±è°ƒç”¨åˆå§‹åŒ–æ¥èµ‹å€¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨ã€‚</li>
</ul>
<p>æ‰€ä»¥ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œåœ¨ç¡®å®šå½“å‰å±æ€§ä¸ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„æ—¶å€™ï¼Œåˆ™å¯ä»¥ä½¿ç”¨NONEæ¨¡å¼ï¼Œè¿™æ˜¯æœ€å¿«çš„æ¨¡å¼ï¼Œä½†ä¹Ÿæ˜¯æœ€ä¸å®‰å…¨çš„æ¨¡å¼ã€‚<br>
å¦‚æœå±æ€§æ˜¯è¦åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ï¼Œé‚£ä¹ˆä½¿ç”¨SYNCHRONIZEDå’ŒPUBLICATIONï¼Œä½†å› ä¸ºSYNCHRONIZEDå¼•å…¥äº†é”çš„æœºåˆ¶ï¼Œå®ƒæ˜¯æœ€å®‰å…¨çš„ï¼Œä½†ä¹Ÿæ˜¯æœ€æ…¢çš„æ¨¡å¼ã€‚æŠ˜ä¸­çš„è¯åˆ™å¯ä»¥ä½¿ç”¨PUBLICATIONã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¯¹Closeableçš„è‡ªåŠ¨å…³é—­å¤„ç†ï¼Œè¯­æ³•ğŸ¬]]></title>
        <id>https://arms-merchants.github.io/post/dui-closeable-de-zi-dong-guan-bi-chu-li-yu-fa/</id>
        <link href="https://arms-merchants.github.io/post/dui-closeable-de-zi-dong-guan-bi-chu-li-yu-fa/">
        </link>
        <updated>2022-06-14T01:30:07.000Z</updated>
        <content type="html"><![CDATA[<p>é¦–å…ˆçœ‹ä¸€æ®µç¤ºä¾‹ä»£ç ï¼š</p>
<pre><code class="language-java"> FileInputStream fis = null;
        try {
            fis = new FileInputStream(&quot;&quot;);
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } finally {
            try {
                fis.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
</code></pre>
<p>ä¸€æ®µåŸºæœ¬æ“ä½œï¼Œå¯¹æ–‡ä»¶æµè¿›è¡Œæ“ä½œé‚£ä¹ˆä¸è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥æœ€å¥½éƒ½è¦è¿›è¡Œæ–‡ä»¶æµçš„å…³é—­ã€‚ä¸è¿‡è¿™æ ·çš„ä»£ç ç¡®å®æŒºæ ·æ¿çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹javaå’Œkotlinå¯¹è¿™ä¸­æ ·æœ¬ä»£ç æ¶ˆé™¤çš„è¯­æ³•ç³–å®ç°ã€‚</p>
<h2 id="1javaçš„å®ç°">1.javaçš„å®ç°</h2>
<pre><code class="language-java">     try (FileInputStream fis = new FileInputStream(&quot;file_path&quot;);
             FileOutputStream fos = new FileOutputStream(&quot;file_path&quot;)) {
            byte[] bytes = new byte[1024];
            while ( fis.read(bytes) != -1) {
                fos.write(bytes);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
</code></pre>
<p>è·ŸåŸæ¥çš„å†™æ³•å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯å°†Closeableå¯¹è±¡çš„å£°æ˜æ˜¯åœ¨tryåçš„æ‹¬å·å†…,å¹¶ä¸”å¯ä»¥é€šè¿‡ï¼›æ¥è¿›è¡Œåˆ†å‰²å£°æ˜å¤šä¸ªCloseableå¯¹è±¡ï¼Œåœ¨tryåŒ…è£¹å†…çš„ä»£ç æ‰§è¡Œå®Œåéƒ½ä¼šè¢«è‡ªåŠ¨closeæ‰ã€‚</p>
<h2 id="2kotlinçš„å®ç°">2.kotlinçš„å®ç°</h2>
<pre><code class="language-java">   val fis = FileInputStream(&quot;file_path&quot;)
    fis.use { 
        fis.read()
    }
</code></pre>
<p>é€šè¿‡ä½¿ç”¨useæ“ä½œç¬¦æ¥å®ç°è‡ªåŠ¨å…³é—­Closeableå¯¹è±¡ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹useçš„æºç ï¼š</p>
<pre><code class="language-java">@InlineOnly
@RequireKotlin(&quot;1.2&quot;, versionKind = RequireKotlinVersionKind.COMPILER_VERSION, message = &quot;Requires newer compiler version to be inlined correctly.&quot;)
public inline fun &lt;T : Closeable?, R&gt; T.use(block: (T) -&gt; R): R {
    contract {
        callsInPlace(block, InvocationKind.EXACTLY_ONCE)
    }
    var exception: Throwable? = null
    try {
        return block(this)
    } catch (e: Throwable) {
        exception = e
        throw e
    } finally {
        when {
            apiVersionIsAtLeast(1, 1, 0) -&gt; this.closeFinally(exception)
            this == null -&gt; {}
            exception == null -&gt; close()
            else -&gt;
                try {
                    close()
                } catch (closeException: Throwable) {
                    // cause.addSuppressed(closeException) // ignored here
                }
        }
    }
}
</code></pre>
<p>ä¸€ä¸ªé«˜é˜¶çš„å†…è”å‡½æ•°ï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡finallyä¸­è¿›è¡Œå…³é—­æ“ä½œã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[NDKå¼€å‘-ä½¿ç”¨FMODè¿›è¡Œå˜å£°]]></title>
        <id>https://arms-merchants.github.io/post/ndk-kai-fa-shi-yong-fmod-jin-xing-bian-sheng/</id>
        <link href="https://arms-merchants.github.io/post/ndk-kai-fa-shi-yong-fmod-jin-xing-bian-sheng/">
        </link>
        <updated>2022-04-28T03:30:02.000Z</updated>
        <content type="html"><![CDATA[<p>FMODä¸€æ¬¾å¼ºå¤§çš„è¯­éŸ³å¼•æ“ï¼Œç­‰åŒäºè§†é¢‘å±Šçš„FFMPEG.å¯ä»¥è¿›è¡ŒéŸ³é¢‘çš„å¤šç§ä¿®æ”¹å’Œè®¾ç½®ï¼Œå®ƒæœ‰æä¾›å®¢æˆ·ç«¯æ¥è¿›è¡Œç›´æ¥ä½¿ç”¨ï¼Œä¸è¿‡ä»Šå¤©æˆ‘ä»¬é€šè¿‡é›†æˆAPIæ¥å®ç°å‡ ä¸ªç®€å•çš„å˜éŸ³æ•ˆæœã€‚</p>
<h2 id="1ndké…ç½®">1.NDKé…ç½®</h2>
<p>ç°åœ¨éœ€è¦æ³¨æ„çš„æ˜¯åœ¨æ–°ç‰ˆæœ¬çš„AndroidStudioä¸­å·²ç»ä¸æ”¯æŒåœ¨local.propertiesè®¾ç½®ä¸­è®¾ç½®ndk.dirçš„é…ç½®æ¥è®¾ç½®ä½¿ç”¨çš„NDKç‰ˆæœ¬ï¼Œå¦‚æœéœ€è¦é…ç½®çš„è¯é€šè¿‡ä¸‹é¢çš„æ–¹å¼ï¼š</p>
<pre><code class="language-java">android{
    ndkVersion &quot;major.minor.build&quot; //ndkVersion &quot;21.3.6528147&quot;
}
</code></pre>
<p>å¦‚æœä¸æŒ‡å®šçš„è¯é‚£ä¹ˆé»˜è®¤é‡‡ç”¨å½“å‰AGPæ”¯æŒçš„æœ€é«˜ç‰ˆæœ¬ã€‚<br>
å¯¼å…¥fmodçš„æ–‡ä»¶ï¼Œè¿™é‡ŒåŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯åŠ¨æ€åº“ï¼ˆsoåº“ï¼‰ï¼Œä¸€ä¸ªæ˜¯å¤´æ–‡ä»¶<br>
é€šè¿‡å¤´æ–‡ä»¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å¯¹åº”çš„fmodçš„æ–¹æ³•äº†ã€‚<br>
å°†fmodçš„incå¤´æ–‡ä»¶æ‹·è´åˆ°cppç›®å½•ä¸‹ï¼Œå°†soåº“æ‹·è´åˆ°jinLibsï¼ˆé»˜è®¤ï¼Œä¹Ÿå¯ä»¥æ˜¯æŒ‡å®šçš„soåº“ç›®å½•ï¼‰<br>
ä¿®æ”¹é»˜è®¤çš„CMakeLists.txtæ–‡ä»¶ï¼š</p>
<pre><code class="language-java">#æ‰¹é‡å¯¼å…¥æºæ–‡ä»¶ï¼Œé¿å…è¿˜éœ€è¦ä¸€ä¸ªä¸ªçš„å¯¼å…¥æºæ–‡ä»¶
file(GLOB allCPP *.c *.h *.cpp)

add_library( # Sets the name of the library.
        native-lib

        # Sets the library as a shared library.
         #SHARED è¡¨ç¤ºè¿™ä¸ªåº“æ˜¯ä¸€ä¸ªåŠ¨æ€åº“ STATICè¡¨ç¤ºè¿™ä¸ªåº“æ˜¯ä¸€ä¸ªé™æ€åº“ï¼ŒåŠ¨æ€åº“æ˜¯ä»¥.soæ–‡ä»¶ç»“å°¾ é™æ€åº“æ˜¯ä»¥.aç»“å°¾ï¼Œå¹¶ä¸”Androidçš„è¯
        #åœ¨æ‰“åŒ…çš„æœ€ååªä¼šåŒ…å«æœ‰åŠ¨æ€åº“ï¼Œå› ä¸ºå¦‚æœæ˜¯é™æ€åº“çš„è¯é‚£ä¹ˆä¼šå°†å¯¹åº”çš„ä»£ç æ‹·è´åˆ°å¯¹åº”çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™ä¸éœ€è¦é™æ€åº“äº†ï¼Œè€ŒåŠ¨æ€åº“å¯¹åº”çš„éƒ½æ˜¯é€šè¿‡åœ°å€
        #æ¥è¿›è¡Œé“¾æ¥çš„ï¼Œé‚£ä¹ˆåº“æ–‡ä»¶è¿˜æ˜¯éœ€è¦çš„
        SHARED

        # Provides a relative path to your source file(s).
        //æ³¨æ„è¿™é‡Œçš„åç§°è¦å’Œä¸Šé¢æ‰¹é‡å¯¼å…¥çš„åç§°ä¸€è‡´
        ${allCPP}
        )

#å¯¼å…¥åº“æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸‰æ–¹çš„soï¼Œä¸è¿‡éœ€è¦æ³¨æ„è¿™ä¸ªæ˜¯éœ€è¦åœ¨jniLibsä¸­æœ‰å¯¹åº”æ–‡ä»¶å¤¹åæ‰èƒ½ç”Ÿæ•ˆï¼Œä¸ç„¶ä¼šåœ¨ç¼–è¯‘é˜¶æ®µæŠ¥é”™
set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -L${CMAKE_SOURCE_DIR}/../jniLibs/${CMAKE_ANDROID_ARCH_ABI}&quot;)
</code></pre>
<h2 id="2æ·»åŠ fmodçš„å¤´æ–‡ä»¶å’Œåº“">2.æ·»åŠ FMODçš„å¤´æ–‡ä»¶å’Œåº“</h2>
<p>å°†ä¸‹è½½çš„FMODä¸­å¯¹åº”çš„å¤´æ–‡ä»¶æ–‡ä»¶å¤¹incæ‹·è´åˆ°cppç›®å½•ä¸‹ï¼Œåœ¨jniLibsä¸­æ‹·è´éœ€è¦ä½¿ç”¨åˆ°çš„çš„æ¶æ„ç›®å½•ã€‚<br>
åœ¨CMakeLists.txtä¸­æ·»åŠ é…ç½®ä¿¡æ¯ï¼š</p>
<pre><code class="language-java">#æ‰¹é‡å¯¼å…¥å¤´æ–‡ä»¶,æ³¨æ„å¯¹åº”çš„ç›®å½•ï¼Œå½“å‰çš„æ ¹ç›®å½•æ˜¯CMakeLists.txtæ‰€åœ¨çš„ç›®å½•
include_directories(&quot;inc&quot;)
#é“¾æ¥å¯¹åº”çš„åº“æ–‡ä»¶
target_link_libraries( # Specifies the target library.
        native-lib

        # Links the target library to the log library
        # included in the NDK.
        ${log-lib}
        fmod
        fmodL
        )
</code></pre>
<p>å®Œæ•´çš„CMakeLists.txtæ–‡ä»¶ï¼š</p>
<pre><code class="language-java"># For more information about using CMake with Android Studio, read the
# documentation: https://d.android.com/studio/projects/add-native-code.html

# Sets the minimum version of CMake required to build the native library.

cmake_minimum_required(VERSION 3.10.2)

# Declares and names the project.

project(&quot;ndktest&quot;)

# Creates and names a library, sets it as either STATIC
# or SHARED, and provides the relative paths to its source code.
# You can define multiple libraries, and CMake builds them for you.
# Gradle automatically packages shared libraries with your APK.

#æ‰¹é‡å¯¼å…¥å¤´æ–‡ä»¶
include_directories(&quot;inc&quot;)
#æ‰¹é‡å¯¼å…¥æºæ–‡ä»¶
file(GLOB allCPP *.c *.h *.cpp)

add_library( # Sets the name of the library.
        native-lib

        # Sets the library as a shared library.
        SHARED

        # Provides a relative path to your source file(s).
        ${allCPP}
        )
#å¯¼å…¥åº“æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸‰æ–¹çš„so
set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -L${CMAKE_SOURCE_DIR}/../jniLibs/${CMAKE_ANDROID_ARCH_ABI}&quot;)

# Searches for a specified prebuilt library and stores the path as a
# variable. Because CMake includes system libraries in the search path by
# default, you only need to specify the name of the public NDK library
# you want to add. CMake verifies that the library exists before
# completing its build.

find_library( # Sets the name of the path variable.
        log-lib

        # Specifies the name of the NDK library that
        # you want CMake to locate.
        log)

# Specifies libraries CMake should link to your target library. You
# can link multiple libraries, such as libraries you define in this
# build script, prebuilt third-party libraries, or system libraries.

target_link_libraries( # Specifies the target library.
        native-lib

        # Links the target library to the log library
        # included in the NDK.
        ${log-lib}
        fmod
        fmodL
        )
</code></pre>
<h2 id="3å‡†å¤‡éœ€è¦ç¼–è¾‘çš„éŸ³é¢‘æ–‡ä»¶">3.å‡†å¤‡éœ€è¦ç¼–è¾‘çš„éŸ³é¢‘æ–‡ä»¶</h2>
<p>è¿™é‡Œæˆ‘ç›´æ¥å‡†å¤‡äº†ä¸€ä¸ªmp3æ–‡ä»¶æ¥è¿›è¡Œç¼–è¾‘ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è¿›è¡Œå½•åˆ¶åç¼–è¾‘ã€‚åœ¨assetsç›®å½•ä¸­æ”¾å…¥mp3æ–‡ä»¶ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œä½¿ç”¨okioå°†æ–‡ä»¶æ‹·è´åˆ°cacheç›®å½•æ“ä½œï¼Œè¿™æ ·ä¹Ÿä¸éœ€è¦è¿›è¡Œæƒé™çš„ç”³è¯·ã€‚</p>
<pre><code class="language-java">    implementation 'com.squareup.okio:okio:2.10.0'
</code></pre>
<p>æ‹·è´æ–‡ä»¶ï¼š</p>
<pre><code class="language-java">    private fun copyFile(): String {
        //å°†assetsç›®å½•ä¸‹çš„æ–‡ä»¶æ‹·è´åˆ°åº”ç”¨çš„cacheç›®å½•ä¸‹ï¼Œè¿™é‡Œçš„sourceæ˜¯okioçš„æ‰©å±•æ–¹æ³•
        val targetFile = File(this.cacheDir, &quot;test.mp3&quot;)
        //ä½¿ç”¨useæ¥è‡ªåŠ¨å…³é—­å®ç°Closeableçš„å¯¹è±¡
        this.assets.open(&quot;test.mp3&quot;).source().use { source -&gt;
            targetFile.sink().buffer().use {
                it.writeAll(source)
            }
        }
        return targetFile.path;
    }
</code></pre>
<h2 id="4ä½¿ç”¨ndkå®ç°å¯¹åº”çš„æ–¹æ³•è°ƒç”¨">4.ä½¿ç”¨NDKå®ç°å¯¹åº”çš„æ–¹æ³•è°ƒç”¨</h2>
<pre><code class="language-c++">#include &lt;jni.h&gt;
#include &lt;string&gt;

#include &lt;fmod.hpp&gt;

#include &quot;Student.h&quot;

using namespace std;
using namespace FMOD;

//androidçš„logæ‰“å°éœ€è¦å¯¼å…¥çš„å¤´æ–‡ä»¶P
#include &lt;android/log.h&gt;
#include &lt;unistd.h&gt;
#include &lt;pthread.h&gt;
//å®å®šä¹‰
#define LOG_TAG &quot;ARM_NDK&quot;
//...çš„å‚æ•°ç”±__VA_ARGS__æ¥è¿›è¡Œç¡®è®¤
#define LOGE(...) __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__);
#define LOGI(...) __android_log_print(ANDROID_LOG_INFO,LOG_TAG,__VA_ARGS__);

#undef MODE_NORMAL
#define MODE_NORMAL 0
#undef MODE_FUNNY
#define MODE_FUNNY 1
#undef MODE_UNCLE
#define MODE_UNCLE 2
#undef MODE_LOLITA
#define MODE_LOLITA 3
#undef MODE_ROBOT
#define MODE_ROBOT 4
#undef MODE_ETHEREAL
#define MODE_ETHEREAL 5
#undef MODE_CHORUS
#define MODE_CHORUS 6
#undef MODE_HORROR
#define MODE_HORROR 7

extern &quot;C&quot; {
//å› ä¸ºcppæ˜¯C++ï¼Œå¦‚æœè¦å¯¼å…¥cçš„ä»£ç ï¼Œéœ€è¦ä½¿ç”¨cçš„è¯­è¨€ç¯å¢ƒ
};

extern &quot;C&quot; JNIEXPORT
jstring JNICALL
Java_com_arms_ndktest_MainActivity_stringFromJNI(
        JNIEnv
        *env,
        jobject /* this */) {
    string hello = &quot;Hello from C++&quot;;
    LOGE(&quot;æµ‹è¯•æ‰“å°&quot;);
    auto *student = new Student(&quot;haha&quot;, 21);
    const char *str = student-&gt;getName().c_str();
    LOGE(&quot;%s&quot;, str);
    delete student;
    return env-&gt;
            NewStringUTF(hello.c_str());
}

//æ²¡æœ‰è¿”å›å€¼çš„JNIæ–¹æ³•,éé™æ€æ–¹æ³•ï¼Œéé™æ€æ–¹æ³•çš„è¯è¿™é‡Œæ˜¯jobject
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_MainActivity_testNoReturnFromJNI(JNIEnv
                                                       *env,
                                                       jobject thiz
) {
    //å¦‚æœæ˜¯ä»javaå±‚ä¼ å…¥çš„æ•°ç»„ï¼Œé‚£ä¹ˆç›´æ¥ä¿®æ”¹æ“ä½œåªä¼šåœ¨c++å±‚ç”Ÿæ•ˆï¼Œä¸ä¼šæ”¹å˜javaå±‚çš„æ•°æ®
    jintArray jintArray1;
    int length = env-&gt;GetArrayLength(jintArray1);

    int *pInt = env-&gt;GetIntArrayElements(jintArray1, NULL);
    for (int i = 0; i &lt; length; i++) {
        *(pInt + i) += 100;
    }
    //é€šè¿‡ä¸‹é¢çš„æ“ä½œæ†æ¥è¾¾åˆ°ä¿®æ”¹å¯¹åº”javaçš„æ•°æ®ï¼Œmodeçš„æ¨¡å¼0 åˆ·æ–°javaæ•°ç»„ï¼Œé‡Šæ”¾C++å±‚æ•°ç»„ JNI_COMMIT:åªæäº¤åªåˆ·æ–°Javaæ•°ç»„ï¼Œä¸é‡Šæ”¾C++,JNI_ABORT:åªé‡Šæ”¾C++å±‚æ•°æ®
    env-&gt;ReleaseIntArrayElements(jintArray1, pInt, 0);
}
//ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œä½¿ç”¨c++æ¥æ„å»ºä¸€ä¸ªjavaçš„å¯¹è±¡ï¼Œå¹¶è®¾ç½®å…¶ä¸­çš„å‚æ•°
void test(JNIEnv *env) {

    const char *className = &quot;com/arms/ndktest/PeopleBean&quot;;

    jclass pJclass = env-&gt;FindClass(className);
    //è¿™ç§æ–¹å¼ä¸ä¼šè°ƒç”¨æ„é€ æ–¹æ³•
    jobject pJobject = env-&gt;AllocObject(pJclass);
    //è¿™ç§æ–¹å¼ï¼Œè¯´ç™½äº†å°±æ˜¯è¦ä¼ å…¥ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ„é€ æ–¹æ³•ä»è€Œæ¥æ‰§è¡ŒæŒ‡å®šçš„æ„é€ æ–¹æ³•
    jmethodID pJmethodId = env-&gt;GetMethodID(pJclass, &quot;&lt;init&gt;&quot;, &quot;()V&quot;);
    jobject object = env-&gt;NewObject(pJclass, pJmethodId);

    jmethodID setNameMethod = env-&gt;GetMethodID(pJclass, &quot;setName&quot;, &quot;(Ljava/lang/String;)V&quot;);
    jmethodID setAageMethod = env-&gt;GetMethodID(pJclass, &quot;setAge&quot;, &quot;(I)V&quot;);

    jstring nameValue = env-&gt;NewStringUTF(&quot;123&quot;);

    env-&gt;CallVoidMethod(pJobject, setNameMethod, nameValue);
    env-&gt;CallVoidMethod(pJobject, setAageMethod, 11);

    env-&gt;DeleteLocalRef(pJclass);
    env-&gt;DeleteLocalRef(pJobject);
}

/**
æœ€å¼€å§‹åœ¨MainActivityä¸­æ¥å®ç°å¯¹åº”çš„æ–¹æ³•ï¼Œå‡ºå…¥å‚æ•°ä¸ºæ’­æ”¾çš„æ¨¡å¼ä»¥åŠå¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶è·¯å¾„
*/
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_MainActivity_voiceChangeNative(JNIEnv *env, jobject thiz, jint mode,
                                                     jstring path) {
    char *content_ = &quot;æ’­æ”¾å®Œæ¯•&quot;;
    const char *path_ = env-&gt;GetStringUTFChars(path, NULL);
    LOGE(&quot;mode:%d&quot;, mode);
    System *system = 0;
    Sound *sound = 0;
    Channel *channel = 0;
    DSP *dsp = 0;
    System_Create(&amp;system);
    system-&gt;init(32, FMOD_INIT_NORMAL, 0);
    system-&gt;createSound(path_, FMOD_DEFAULT, 0, &amp;sound);
    system-&gt;playSound(sound, 0, false, &amp;channel);
    switch (mode) {
        case 1:
            content_ = &quot;åŸå£°æ’­æ”¾&quot;;
            break;
        case 2:
            content_ = &quot;èè‰æ’­æ”¾&quot;;
            system-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
            dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 2.0f);
            channel-&gt;addDSP(0, dsp);
            break;
        case 3:
            content_ = &quot;å¤§å”æ’­æ”¾&quot;;
            // éŸ³è°ƒä½ -- å¤§å” 0.7
            // 1.åˆ›å»ºDSPç±»å‹çš„Pitch éŸ³è°ƒæ¡ä»¶
            system-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
            // 2.è®¾ç½®PitchéŸ³è°ƒè°ƒèŠ‚2.0
            dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 0.7f);
            // 3.æ·»åŠ éŸ³æ•ˆè¿›å» éŸ³è½¨
            channel-&gt;addDSP(0, dsp);
            break;
        case 4:
            content_ = &quot;ææ€ªæ’­æ”¾&quot;;
            // å°é»„äººå£°éŸ³ é¢‘ç‡å¿«

            // ä»éŸ³è½¨æ‹¿ å½“å‰ é¢‘ç‡
            float mFrequency;
            channel-&gt;getFrequency(&amp;mFrequency);

            // ä¿®æ”¹é¢‘ç‡
            channel-&gt;setFrequency(mFrequency * 1.5f); // é¢‘ç‡åŠ å¿«  å°é»„äººçš„å£°éŸ³
            break;
        case 5:
            content_ = &quot;æƒŠæ‚šæ’­æ”¾&quot;;
            // TODO éŸ³è°ƒä½
            // éŸ³è°ƒä½ -- å¤§å” 0.7
            // 1.åˆ›å»ºDSPç±»å‹çš„Pitch éŸ³è°ƒæ¡ä»¶
            system-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
            // 2.è®¾ç½®PitchéŸ³è°ƒè°ƒèŠ‚2.0
            dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 0.7f);
            // 3.æ·»åŠ éŸ³æ•ˆè¿›å» éŸ³è½¨
            channel-&gt;addDSP(0, dsp); // ç¬¬ä¸€ä¸ªéŸ³è½¨

            // TODO æç‚¹å›å£°
            // å›éŸ³ ECHO
            system-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
            dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 200); // å›éŸ³ å»¶æ—¶    to 5000.  Default = 500.
            dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 10); // å›éŸ³ è¡°å‡åº¦ Default = 50   0 å®Œå…¨è¡°å‡äº†
            channel-&gt;addDSP(1, dsp); // ç¬¬äºŒä¸ªéŸ³è½¨

            // TODO é¢¤æŠ–
            // Tremolo é¢¤æŠ–éŸ³ æ­£å¸¸5    éå¸¸é¢¤æŠ–  20
            system-&gt;createDSPByType(FMOD_DSP_TYPE_TREMOLO, &amp;dsp);
            dsp-&gt;setParameterFloat(FMOD_DSP_TREMOLO_FREQUENCY, 20); // éå¸¸é¢¤æŠ–
            dsp-&gt;setParameterFloat(FMOD_DSP_TREMOLO_SKEW, 0.8f); // ï¼Ÿï¼Ÿï¼Ÿ
            channel-&gt;addDSP(2, dsp); // ç¬¬ä¸‰ä¸ªéŸ³è½¨
            break;
        case 6:
            content_ = &quot;ç©ºçµæ’­æ”¾&quot;;
            // å›éŸ³ ECHO
            system-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
            dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 200); // å›éŸ³ å»¶æ—¶    to 5000.  Default = 500.
            dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 10); // å›éŸ³ è¡°å‡åº¦ Default = 50   0 å®Œå…¨è¡°å‡äº†
            channel-&gt;addDSP(0, dsp);
            break;
    }
    bool isPlayer = true;
    while (isPlayer) {
        channel-&gt;isPlaying(&amp;isPlayer);
        usleep(1000 * 1000);
    }
    sound-&gt;release();
    system-&gt;close();
    system-&gt;release();
    env-&gt;ReleaseStringUTFChars(path, path_);
}

Channel *channel = 0;

extern &quot;C&quot;
JNIEXPORT jint JNICALL
Java_com_arms_ndktest_FmodSound_saveSound(JNIEnv *env, jobject cls, jstring path_jstr, jint type,
                                          jstring save_jstr) {
    Sound *sound;
    DSP *dsp;
    bool playing = true;
    float frequency = 0;
    System *mSystem;
    JNIEnv *mEnv = env;
    int code = 0;
    System_Create(&amp;mSystem);
    const char *path_cstr = mEnv-&gt;GetStringUTFChars(path_jstr, NULL);
    LOGI(&quot;saveAiSound-%s&quot;, path_cstr);
    const char *save_cstr;
    if (save_jstr != NULL) {
        save_cstr = mEnv-&gt;GetStringUTFChars(save_jstr, NULL);
        LOGI(&quot;saveAiSound-save_path=%s&quot;, save_cstr)
    }
    try {
        if (save_jstr != NULL) {
            char cDest[200];
            strcpy(cDest, save_cstr);
            mSystem-&gt;setSoftwareFormat(8000, FMOD_SPEAKERMODE_MONO, 0); //è®¾ç½®é‡‡æ ·ç‡ä¸º8000ï¼Œchannelä¸º1
            mSystem-&gt;setOutput(FMOD_OUTPUTTYPE_WAVWRITER); //ä¿å­˜æ–‡ä»¶æ ¼å¼ä¸ºWAV
            mSystem-&gt;init(32, FMOD_INIT_NORMAL, cDest);
            mSystem-&gt;recordStart(0, sound, true);
        }
        //åˆ›å»ºå£°éŸ³
        mSystem-&gt;createSound(path_cstr, FMOD_DEFAULT, NULL, &amp;sound);
        mSystem-&gt;playSound(sound, 0, false, &amp;channel);
        LOGI(&quot;saveAiSound-%s&quot;, &quot;save_start&quot;)
        switch (type) {
            case MODE_NORMAL:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_NORMAL&quot;);
                break;
            case MODE_FUNNY:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_FUNNY&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_NORMALIZE, &amp;dsp);
                channel-&gt;getFrequency(&amp;frequency);
                frequency = frequency * 1.6;
                channel-&gt;setFrequency(frequency);
                break;
            case MODE_UNCLE:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_UNCLE&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 0.8);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_LOLITA:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_LOLITA&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 1.8);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_ROBOT:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_ROBOT&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 50);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 60);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_ETHEREAL:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_ETHEREAL&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 300);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 20);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_CHORUS:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_CHORUS&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 100);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 50);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_HORROR:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_HORROR&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_TREMOLO, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_TREMOLO_SKEW, 0.8);
                channel-&gt;addDSP(0, dsp);
                break;
            default:
                break;
        }
        mSystem-&gt;update();
    } catch (...) {
        LOGE(&quot;saveAiSound-%s&quot;, &quot;save error!&quot;)
        code = 1;
        goto end;
    }
    while (playing) {
        usleep(1000);
        channel-&gt;isPlaying(&amp;playing);
    }
    LOGI(&quot;saveAiSound-%s&quot;, &quot;save over!&quot;)
    goto end;
    end:
    if (path_jstr != NULL) {
        mEnv-&gt;ReleaseStringUTFChars(path_jstr, path_cstr);
    }
    if (save_jstr != NULL) {
        mEnv-&gt;ReleaseStringUTFChars(save_jstr, save_cstr);
    }
    sound-&gt;release();
    mSystem-&gt;close();
    mSystem-&gt;release();
    return code;
}

extern &quot;C&quot;
JNIEXPORT jint JNICALL
Java_com_arms_ndktest_FmodSound_playSound(JNIEnv *env, jobject thiz, jstring path, jint type) {
}
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_FmodSound_stopPlay(JNIEnv *env, jobject thiz) {
    channel-&gt;stop();
}
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_FmodSound_resumePlay(JNIEnv *env, jobject thiz) {
    channel-&gt;stop();
    //æ£€æµ‹å½“å‰çš„envæ‰§è¡Œè¿‡ç¨‹æ˜¯å¦æœ‰å¼‚å¸¸å‘ç”Ÿ
    jthrowable pJthrowable = env-&gt;ExceptionOccurred();
    if (pJthrowable) {
        //ä¸»åŠ¨æ¸…é™¤å¼‚å¸¸
        env-&gt;ExceptionClear();
        //JNIä¸­ä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸
        jclass throwClass = env-&gt;FindClass(&quot;java/lang/NoSuchFieldError&quot;);
        env-&gt;ThrowNew(throwClass, &quot;dfsdf&quot;);
    }
}
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_FmodSound_pausePlay(JNIEnv *env, jobject thiz) {
    channel-&gt;stop();
}
extern &quot;C&quot;
JNIEXPORT jboolean JNICALL
Java_com_arms_ndktest_FmodSound_isPlaying(JNIEnv *env, jobject thiz) {
    bool isPlaying = false;
    channel-&gt;isPlaying(&amp;isPlaying);
    return isPlaying;
}

JavaVM *javaVm = nullptr;

/**
 * JNIEnv *env ä¸èƒ½è·¨è¶Šçº¿ç¨‹ï¼Œå¯ä»¥è·¨è¶Šå‡½æ•°  è§£å†³æ–¹æ¡ˆé€šè¿‡JavaVM.attchCurrentThreadè·å–å­çº¿ç¨‹çš„JNIEnv
 * jobject thiz ä¸èƒ½è·¨è¶Šçº¿ç¨‹å’Œå‡½æ•°  è¿™ä¸ªé€šè¿‡æå‡ä¸ºå…¨å±€å˜é‡æ¥è§£å†³
 * JavaVM *javaVm å¯ä»¥è·¨è¶Šçº¿ç¨‹å’Œå‡½æ•°
 *
 * åŠ¨æ€æ³¨å†Œçš„ä»£ç 
 * @param javaVm
 * @return
 */
JNIEXPORT jint JNI_OnLoad(JavaVM *javaVm, void *) {
    //::javaVm = javaVm;
    JNIEnv *jniEnv = nullptr;
    int result = javaVm-&gt;GetEnv(reinterpret_cast&lt;void **&gt;(&amp;jniEnv), JNI_VERSION_1_6);
    if (result != JNI_OK) {
        return -1;
    }
    return JNI_VERSION_1_6;
}

class MyContext {
public:
    JNIEnv *jniEnv = nullptr;
    jobject instance = nullptr;
};

void *myThreadTaskAction(void *pVoid) {
    //è¿™ä¸ªå‡½æ•°ä¸­æŒ‡é’ˆè¿è¡Œåœ¨å­çº¿ç¨‹ä¸­
    MyContext *myContext = static_cast&lt;MyContext *&gt;(pVoid);
    JNIEnv *jniEnv = nullptr;
    //é€šè¿‡JavaVM.attchCurrentThreadè·å–å­çº¿ç¨‹çš„JNIEnv
    jint result = ::javaVm-&gt;AttachCurrentThread(&amp;jniEnv, nullptr);
    if (result != JNI_OK) {
        return 0;
    }
    jclass activityClass = jniEnv-&gt;GetObjectClass(myContext-&gt;instance);

    jmethodID methodId = jniEnv-&gt;GetMethodID(activityClass, &quot;showAlter&quot;, &quot;()V&quot;);

    jniEnv-&gt;CallVoidMethod(myContext-&gt;instance, methodId);

    ::javaVm-&gt;DetachCurrentThread();
    return nullptr;
}


/**
 * åœ¨C++çš„å­çº¿ç¨‹ä¸­å›æ‰Javaå±‚ä»£ç 
 */
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_MainActivity_callJNIAsync(JNIEnv *env, jobject thiz) {
    env-&gt;GetJavaVM(&amp;::javaVm);
    auto *myContext = new MyContext;
    myContext-&gt;jniEnv = env;
    //jobject thiz ä¸èƒ½è·¨è¶Šçº¿ç¨‹å’Œå‡½æ•°  è¿™ä¸ªé€šè¿‡æå‡ä¸ºå…¨å±€å˜é‡æ¥è§£å†³
    myContext-&gt;instance = env-&gt;NewGlobalRef(thiz);
    pthread_t pid;
    //cä¸­çš„åˆ›å»ºå­çº¿ç¨‹
    pthread_create(&amp;pid, nullptr, myThreadTaskAction, myContext);
    pthread_join(pid, nullptr);
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åœ¨ä¸åŒç‰ˆæœ¬ä¸‹é€šè¿‡Hookæ¥å¯åŠ¨æ’ä»¶activityçš„æµç¨‹]]></title>
        <id>https://arms-merchants.github.io/post/zai-bu-tong-ban-ben-xia-tong-guo-hook-lai-qi-dong-cha-jian-activity-de-liu-cheng/</id>
        <link href="https://arms-merchants.github.io/post/zai-bu-tong-ban-ben-xia-tong-guo-hook-lai-qi-dong-cha-jian-activity-de-liu-cheng/">
        </link>
        <updated>2022-03-21T01:16:29.000Z</updated>
        <content type="html"><![CDATA[<p>ä¸è®ºå“ªä¸ªç‰ˆæœ¬åœ¨å¯åŠ¨æ’ä»¶Activityä¹‹å‰éƒ½éœ€è¦é€šè¿‡DexPathLoaderæ¥è¿›è¡Œç›¸åº”çš„åŠ è½½ï¼Œè¿™ä¸ªéƒ¨åˆ†ä¸åœ¨æ­¤æ¬¡å†…å®¹ä¸­ã€‚<br>
ç‰ˆæœ¬åŒºåˆ†çš„è¯è¿™é‡Œæ˜¯æ ¹æ®Activityçš„å¯åŠ¨æµç¨‹å·®å¼‚æ¥è¿›è¡Œç›¸åº”çš„æ›¿æ¢ï¼ŒåŸºæœ¬æ€è·¯ä¸€è‡´ï¼Œç‰ˆæœ¬åˆ’åˆ†çš„è¯ä¸»è¦æ˜¯8.0ä»¥ä¸‹ï¼Œ10.0ä»¥ä¸‹ï¼Œ10.0åŠä»¥ä¸Šç‰ˆæœ¬ã€‚</p>
<h2 id="1hookæ›¿æ¢intent">1.Hookæ›¿æ¢Intent</h2>
<pre><code class="language-java">    private const val TARGET_INTENT = &quot;target_intent&quot;
    fun hookAMS() {
        try {
            LogE(Build.VERSION.SDK_INT.toString())
            //1ã€‚è·å–Singletonå¯¹è±¡
            val singletonFieldParams =
                when {
                    (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) -&gt; {
                        //8.0ä»¥ä¸‹
                        &quot;android.app.ActivityManagerNative&quot; to &quot;gDefault&quot;
                    }
                    (Build.VERSION.SDK_INT&lt;Build.VERSION_CODES.Q)-&gt;{
                        //10.0ä»¥ä¸‹
                        &quot;android.app.ActivityManager&quot; to &quot;IActivityManagerSingleton&quot;
                    }
                    else -&gt; {
                        //10.0åŠä»¥ä¸Š
                        &quot;android.app.ActivityTaskManager&quot; to &quot;IActivityTaskManagerSingleton&quot;
                    }
                }
            val aClass = Class.forName(singletonFieldParams.first)
            val singletonField = aClass.getDeclaredField(singletonFieldParams.second)
            singletonField.isAccessible = true
            val singleton = singletonField[null]
            val singletonClazz = Class.forName(&quot;android.util.Singleton&quot;)
            val mInstanceFiled = singletonClazz.getDeclaredField(&quot;mInstance&quot;)
            mInstanceFiled.isAccessible = true
            val mInstance = mInstanceFiled[singleton]

            //2ã€‚è·å–Singletonä¸­çš„IActivityTaskManagerå¯¹è±¡,åŒºåˆ†ç‰ˆæœ¬10ä»¥ä¸‹
            val proxyClass =
                if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.Q) {
                    Class.forName(&quot;android.app.IActivityManager&quot;)
                } else {
                    Class.forName(&quot;android.app.IActivityTaskManager&quot;)
                }
            //3.åˆ›å»ºåŠ¨æ€ä»£ç†
            val newProxyInstance = Proxy.newProxyInstance(
                Thread.currentThread().contextClassLoader,
                arrayOf(proxyClass)
            ) { proxy, method, args -&gt; //è¿™é‡Œå·²ç»ä»£ç†äº†IActivityTaskManagerSingleton
                // å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒçš„æ–¹æ³•æ‰§è¡Œéƒ½ä¼šåˆ°è¿™é‡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦è¦è·å–è·å–å¯¹åº”çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å–æ–¹æ³•ä¸­çš„å‚æ•°
                //å‚æ•°å½“ä¸­æ˜¯æœ‰Intentï¼Œé‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥ä¿®æ”¹ä¸ºå®¿ä¸»ä¸­Activityæ¥æ‰§è¡Œ
                //åªéœ€è¦å¤„ç†startActivitiesçš„æ–¹æ³•
                //è¿™é‡Œä»£ç†çš„å¯¹è±¡æ–¹æ³•æ˜¯åœ¨android8ä»¥åçš„ç‰ˆæœ¬
                try {
                    var index = -1
                    if (&quot;startActivity&quot; == method.name) {
                        index = args.indexOfFirst { it is Intent }
                        val defIntent = args[index] as Intent
                        val proxyIntent = Intent()
                        proxyIntent.setClassName(
                            &quot;com.arm.arount&quot;, &quot;com&quot; +
                                    &quot;.arm.arount.ProxyActivity&quot;
                        )
                        proxyIntent.putExtra(TARGET_INTENT, defIntent)
                        args[index] = proxyIntent
                    }
                    method.invoke(mInstance, *args.orEmpty())
                } catch (e: Exception) {
                    e.printStackTrace()
                }
            }
            //4.ä¿®æ”¹singletonçš„ä»£ç†å¯¹è±¡
            mInstanceFiled[singleton] = newProxyInstance
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
</code></pre>
<p>åˆ°ä¸Šé¢ä¸€æ­¥æˆ‘ä»¬å·²ç»å®Œæˆäº†hook startActivityçš„æµç¨‹ï¼Œå¹¶ä¸”å°†å¯åŠ¨æ’ä»¶çš„Intentæ›¿æ¢ä¸ºäº†å®¿ä¸»ä»£ç†çš„Intentï¼Œå¹¶åœ¨å…¶ä¸­ä¿å­˜äº†åŸå§‹çš„Intentã€‚é‚£ä¹ˆä¸‹ä¸€æ­¥æˆ‘ä»¬å°±éœ€è¦åœ¨åˆé€‚çš„å®é™…æ›¿æ¢å›åŸå§‹çš„Intentã€‚</p>
<h2 id="2æ›¿æ¢å›åŸå§‹intent">2.æ›¿æ¢å›åŸå§‹Intent</h2>
<p>å…ˆä¸Šä»£ç ï¼š</p>
<pre><code class="language-java">fun hookHandleIntent() {
        try {
            //è·å–ActivityThread
            val aClass = Class.forName(&quot;android.app.ActivityThread&quot;)
            //è·å–å®ƒçš„é™æ€å®ä¾‹å¯¹è±¡
            val sCurrentActivityThread = aClass.getDeclaredField(&quot;sCurrentActivityThread&quot;)
            sCurrentActivityThread.isAccessible = true
            val activityThread = sCurrentActivityThread[null]
            val mHField = aClass.getDeclaredField(&quot;mH&quot;)
            mHField.isAccessible = true
            val handler = mHField[activityThread] as Handler
            val mCallbackField = Handler::class.java.getDeclaredField(&quot;mCallback&quot;)
            mCallbackField.isAccessible = true
            val callback = Handler.Callback { msg -&gt;
                try {
                    when (msg.what) {
                        //Android8.0ä»¥ä¸‹çš„å¤„ç†çš„LaunchActivity
                        100 -&gt; {
                            val intentField = msg.obj.javaClass.getDeclaredField(&quot;intent&quot;)
                            intentField.isAccessible = true
                            val proxyIntent: Intent = intentField.get(msg.obj) as Intent
                            val intent = proxyIntent.getParcelableExtra&lt;Intent?&gt;(TARGET_INTENT)
                            intent?.let {
                                intentField.set(msg.obj, it)
                            }
                        }
                        //8.0ä»¥ä¸Šçš„ç”Ÿå‘½å‘¨æœŸå…¥å£
                        159 -&gt; {
                            val mActivityCallbacksField = msg.obj.javaClass.getDeclaredField(
                                &quot;mActivityCallbacks&quot;
                            )
                            mActivityCallbacksField.isAccessible = true
                            val mActivityCallbacks = mActivityCallbacksField[msg.obj] as List&lt;*&gt;
                            val launchActivityItem = mActivityCallbacks.firstOrNull {
                                &quot;android.app.servertransaction.LaunchActivityItem&quot; == it?.javaClass?.name
                            }
                            launchActivityItem?.let {
                                val mIntentField = it.javaClass.getDeclaredField(&quot;mIntent&quot;)
                                mIntentField.isAccessible = true
                                val proxyIntent = mIntentField[launchActivityItem] as Intent
                                val intent =
                                    proxyIntent.getParcelableExtra&lt;Intent&gt;(TARGET_INTENT)
                                if (intent != null) {
                                    mIntentField[launchActivityItem] = intent
                                }
                            }
                        }
                    }
                } catch (e: Exception) {
                    e.printStackTrace()
                }
                //è¿™é‡Œä¸€å®šè¦è¿”å›falseä¸ç„¶æ­£å¸¸æµç¨‹çš„handleMessageå°±æ‰§è¡Œä¸åˆ°äº†
                false
            }
            mCallbackField[handler] = callback
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
</code></pre>
<p>å±æ€§activityå¯åŠ¨æµç¨‹çš„å› ä¸ºéƒ½å‘ç°æˆ‘ä»¬æ˜¯åœ¨ActivityThreadçš„mhçš„Handlerä¸­æ‹¦æˆªæ¶ˆæ¯çš„ï¼ŒHandlerä¸­æœ‰ä¸€ä¸ªCallBackå¯¹è±¡ï¼Œå¯ä»¥åœ¨handleMessageä¹‹å‰æ‹¿åˆ°msg</p>
<pre><code class="language-java">    public void dispatchMessage(@NonNull Message msg) {
        if (msg.callback != null) {
            handleCallback(msg);
        } else {
            if (mCallback != null) {
                //è¿™é‡Œå°±æ˜¯ä¸€å®šè¦è¿”å›falseçš„åŸå› 
                if (mCallback.handleMessage(msg)) {
                    return;
                }
            }
            handleMessage(msg);
        }
    }
</code></pre>
<p>åœ¨æ‹¿åˆ°msgä¹‹åæˆ‘ä»¬éœ€è¦å¤„ç†ä»¥ä¸‹8.0ä»¥ä¸‹ä»¥åŠ8.0ä»¥ä¸Šçš„åŒºåˆ†ï¼š<br>
Â· åœ¨Android8.0ä»¥ä¸‹æ—¶ï¼Œæ˜¯åœ¨ActivityThreadçš„Handlerä¸­å¤„ç†<br>
100-109è¿™å‡ ä¸ªå€¼æ¥å¤„ç†ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œå¹¶ä¸”åœ¨msgä¸­å¯ä»¥ç›´æ¥è·å–åˆ°Intentå¯¹è±¡ã€‚<br>
Â· è€Œåœ¨Android8.0ä»¥åï¼Œè¿™å‡ ä¸ªå€¼æ²¡æœ‰äº†ï¼Œç»Ÿä¸€ä¸º159çš„å…¥å£ï¼Œå¹¶é€šè¿‡çŠ¶æ€æ¨¡å¼æ¥å¤„ç†ï¼Œå¹¶ä¸”ç›¸åº”çš„å‚æ•°æœ‰å°è£…ï¼Œæˆ‘ä»¬éœ€è¦è·å–ä¸€äº›åŒ…è£…å‚æ•°ä¹‹åæ‰èƒ½è·å–åˆ°Intentã€‚</p>
<p>åˆ°è¿™é‡Œæ’ä»¶çš„Activityå°±å¯ä»¥å¯åŠ¨äº†ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°èµ„æºå¸ƒå±€éƒ½æ²¡æ³•åŠ è½½ï¼Œä¸‹é¢å†è¯´æ’ä»¶èµ„æºçš„åŠ è½½ã€‚</p>
<hr>
<p>Hookçš„æ–¹å¼æ¥è¿›è¡Œæ’ä»¶åŒ–å¼€å‘ï¼Œå¾ˆå—ç³»ç»Ÿç‰ˆæœ¬çš„é™åˆ¶ï¼Œå¹¶ä¸”éšç€Androidç³»ç»Ÿç‰ˆæœ¬çš„å‡çº§è¦åšä¸åŒçš„é€‚é…ã€‚æ‰€ä»¥è¿˜æœ‰å¦å¤–ä¸€ç§æ’ä»¶æ–¹æ¡ˆå°±æ˜¯é€šè¿‡å®¹å™¨æ¥å®ç°æ’ä»¶åŒ–ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦hookå¤ªå¤šçš„ç³»ç»Ÿä»£ç ï¼Œè…¾è®¯çš„Shadowæ’ä»¶å°±æ˜¯è¿™ä¸ªæ¥å®ç°çš„ï¼Œå®¿ä¸»çš„appä¸­æœ‰çš„æ˜¯å®¹å™¨çš„activity,ç¼–å†™çš„ä¸šåŠ¡æ’ä»¶æŒ‰åŸæ¥çš„é€»è¾‘ç»§æ‰¿Activityï¼Œä½†æ˜¯åœ¨ç¼–è¯‘æ‰“åŒ…çš„æ—¶å€™é€šè¿‡æ’ä»¶å°†å…¶ç»§æ‰¿æ”¹ä¸ºShadowActivityï¼Œè¿™é‡Œå…¶å®æ˜¯æ”¹ä¸ºäº†æ™®é€šç±»ï¼Œè€Œåœ¨ä»£ç†ç±»ä¸­é€šè¿‡è°ƒç”¨è¿™äº›æ–¹æ³•ï¼Œä»è€Œå®ç°äº†ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„è°ƒç”¨ï¼Œä¸è¿‡è¿™é‡Œéƒ½é¿å…ä¸äº†åŠ è½½æ’ä»¶çš„è¿‡ç¨‹ï¼Œæ‰€æœ‰DexClassLoaderè¿˜æ˜¯å¿…é¡»è¦åŠ è½½ä½¿ç”¨çš„ï¼Œè¿™ä¹Ÿæ˜¯çƒ­ä¿®å¤çš„åŸºç¡€ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kotlinåå°„]]></title>
        <id>https://arms-merchants.github.io/post/kotlin-fan-she/</id>
        <link href="https://arms-merchants.github.io/post/kotlin-fan-she/">
        </link>
        <updated>2022-03-15T07:26:22.000Z</updated>
        <content type="html"><![CDATA[<p>kotlinå¯ä»¥ç›´æ¥ä½¿ç”¨javaçš„åå°„ï¼Œå¦‚æœè¦ä½¿ç”¨kotlinçš„åå°„ï¼Œé‚£ä¹ˆéœ€è¦å•ç‹¬å¼•å…¥kotlinçš„åå°„åº“</p>
<pre><code class="language-java">implementation &quot;org.jetbrains.kotlin:kotlin-reflect&quot;  
</code></pre>
<p>é‚£ä¹ˆè¿™å’ŒJavaå¯¹æ¯”çš„è¯æœ‰ä»€ä¹ˆåŒºåˆ«</p>
<h2 id="java">Java</h2>
<ul>
<li>
<p>ä¼˜ç‚¹ï¼šæ— éœ€å¼•å…¥é¢å¤–ä¾èµ–ï¼Œé¦–æ¬¡ä½¿ç”¨é€Ÿåº¦ç›¸å¯¹è¾ƒå¿«(è¿™æ˜¯å› ä¸ºå®ƒçš„ä¿¡æ¯éƒ½åœ¨è™šæ‹Ÿæœºå†…)ã€‚</p>
</li>
<li>
<p>ç¼ºç‚¹ï¼šæ— æ³•è®¿é—®Kotlinè¯­æ³•ç‰¹æ€§ï¼Œéœ€è¦å¯¹Kotlinç”Ÿæˆçš„å­—èŠ‚ç è¶³å¤Ÿäº†è§£(è¿™æ˜¯å› ä¸ºKotlinç¨‹åºç¼–è¯‘å®Œä¹‹åä¹Ÿæ˜¯ä¸ªJavaç±»ï¼Œæ‰€ä»¥åœ¨Javaåå°„è§†è§’ä¸‹çœ‹åˆ°çš„Kotlinç¼–è¯‘çš„çŠ¶æ€å’Œä¸€èˆ¬Javaç±»æ— å¼‚ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¦é€šè¿‡åå°„è®¿é—®Kotlinç±»çš„ä¸€äº›æ–¹æ³•å±æ€§ï¼Œå¿…é¡»è¦çŸ¥é“å®ƒç¼–è¯‘ä»€ä¹ˆæ ·çš„å­—èŠ‚ç )</p>
</li>
</ul>
<h2 id="kotlin">kotlin</h2>
<ul>
<li>
<p>ä¼˜ç‚¹ï¼šæ”¯æŒè®¿é—®Kotlinå‡ ä¹æ‰€æœ‰ç‰¹æ€§ï¼ŒAPIè®¾è®¡å…¼å®¹æ€§æ›´å¥½ã€‚</p>
</li>
<li>
<p>ç¼ºç‚¹ï¼šé¢å¤–å¼•å…¥äº†ä¸€ä¸ªKotlinåå°„åº“(è¿™ä¸ªåº“2.5Må·¦å³ï¼Œç¼–è¯‘å400KB)ï¼Œé¦–æ¬¡è°ƒç”¨ä¼šæ…¢ä¸€äº›ï¼Œè¿™æ˜¯å› ä¸ºKotlinçš„åå°„ä¿¡æ¯æ˜¯å†™åˆ°Metadataè¿™ä¸ªæ³¨è§£é‡Œé¢çš„(é€šè¿‡æŸ¥çœ‹å­—èŠ‚ç å¯ä»¥çœ‹åˆ°ï¼Œå¦‚ä¸‹)ï¼Œé‡Œé¢çš„æ•°æ®é€šè¿‡Protobufçš„æ•°æ®æ ¼å¼åºåˆ—åŒ–äºŒè¿›åˆ¶å†™å…¥ï¼Œæ‰€ä»¥é¦–æ¬¡åå°„è°ƒç”¨æœ‰ä¸€ä¸ªè·å–æ³¨è§£å¹¶ååºåˆ—åŒ–çš„è¿‡ç¨‹)ã€‚</p>
</li>
</ul>
<pre><code class="language-kotlin">
@Metadata(
   mv = {1, 6, 0},
   k = 1,
   d1 = {&quot;\u0000\u001a\n\u0002\u0018\u0002\n\u0000\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0002\b\u0003\u0018\u0000*\n\b\u0000\u0010\u0001 \u0000*\u00020\u00022\u00020\u0003B\u0005Â¢\u0006\u0002\u0010\u0004J\u0013\u0010\u0005\u001a\u00020\u00062\u0006\u0010\u0007\u001a\u00028\u0000Â¢\u0006\u0002\u0010\bÂ¨\u0006\t&quot;},
   d2 = {&quot;Lcom/qisan/kotlinstu/Dustbin;&quot;, &quot;T&quot;, &quot;Lcom/qisan/kotlinstu/Waste;&quot;, &quot;&quot;, &quot;()V&quot;, &quot;put&quot;, &quot;&quot;, &quot;t&quot;, &quot;(Lcom/qisan/kotlinstu/Waste;)V&quot;, &quot;KotlinStu.app&quot;}
)
</code></pre>
<h2 id="ä¸€äº›åœ¨kotlinåå°„ä¸­çš„å¸¸ç”¨api">ä¸€äº›åœ¨Kotlinåå°„ä¸­çš„å¸¸ç”¨Api:</h2>
<pre><code class="language-java">        var cls: KClass&lt;String&gt; = String::class
        //KClassè½¬ä¸ºjavaçš„Class&lt;String&gt;
        var clsJava: Class&lt;String&gt; = cls.java
        //javaçš„Class&lt;String&gt;è½¬ä¸ºKClass
        cls = clsJava.kotlin
        //è·å–å®šä¹‰åœ¨Stringç±»çš„å±æ€§ï¼Œè¿”å›çš„æ˜¯Collections
        val properties = cls.declaredMemberProperties
        //è¿”å›è¿™ä¸ªç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•
        cls.declaredFunctions
        //è¿”å›è¿™ä¸ªç±»ä¸­çš„æ‰€æœ‰éé™æ€éæ‰©å±•çš„å‡½æ•°
        cls.declaredMemberFunctions
        //è¿”å›è¿™ä¸ªç±»ä¸­ä¸­çš„æ‰©å±•å‡½æ•°,æ³¨æ„çœ‹ä¸‹é¢çš„ç±»A
        cls.declaredMemberExtensionFunctions

        cls.isAbstract//æ˜¯å¦æ˜¯æŠ½è±¡ç±»
        cls.isCompanion//æ˜¯å¦æ˜¯ä¼´ç”Ÿå¯¹è±¡
        cls.nestedClasses//è·å–å½“å‰ç±»çš„å†…éƒ¨ç±»
        cls.objectInstance//å¦‚æœæ˜¯objectï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•è·å–
</code></pre>
<h3 id="1declaredmemberextensionfunctionsçš„å¼ä¾‹">1.declaredMemberExtensionFunctionsçš„å¼ä¾‹</h3>
<pre><code class="language-java">class A {

    fun test(){
        //è¿™é‡Œçš„åå°„å±æ€§é€šè¿‡è¿™ä¸ªæ˜¯å¯ä»¥è·å–åˆ°è¿™ä¸ªString.passçš„æ‰©å±•æ–¹æ³•
        A::class.declaredMemberExtensionFunctions
        //ä½†æ˜¯é€šè¿‡Stringæ˜¯è·å–ä¸åˆ°
        String::class.declaredMemberExtensionFunctions
        &quot;&quot;.pass()
    }

    fun String.pass(){
    }
}
</code></pre>
<p>åœ¨Açš„æ‰©å±•å‡½æ•°ä¸­èƒ½å¤Ÿè·å–åˆ°String.passçš„æ‰©å±•æ–¹æ³•ï¼Œä½†æ˜¯String::class.declaredMemberExtensionFunctionsæ˜¯æ²¡æœ‰çš„ï¼Œè€Œåœ¨é¡¶çº§çš„æ‰©å±•å‡½æ•°ä¸­æ˜¯æ„å»ºæˆé™æ€æ–¹æ³•çš„.</p>
<pre><code class="language-java">fun String.pass() {
    println(&quot;test&quot;)
}
//ktx.kt å¯¹åº”åˆ°çš„javaä»£ç 
@Metadata(
   mv = {1, 6, 0},
   k = 2,
   d1 = {&quot;\u0000\f\n\u0000\n\u0002\u0010\u0002\n\u0002\u0010\u000e\n\u0000\u001a\n\u0010\u0000\u001a\u00020\u0001*\u00020\u0002Â¨\u0006\u0003&quot;},
   d2 = {&quot;pass&quot;, &quot;&quot;, &quot;&quot;, &quot;Arount.app&quot;}
)
public final class KtxKt {
   public static final void pass(@NotNull String $this$pass) {
      Intrinsics.checkNotNullParameter($this$pass, &quot;$this$pass&quot;);
      String var1 = &quot;test&quot;;
      System.out.println(var1);
   }
}
</code></pre>
<h3 id="2ktypeçš„è·å–">2.KTypeçš„è·å–</h3>
<pre><code class="language-java">   fun testKType(){
        val mapType = typeOf&lt;Map&lt;String,Int&gt;&gt;()
        mapType.arguments.forEach {
            print(it)
        }
        /**
         * è¾“å‡ºç»“æœï¼š
         * kotlin.String
         * kotlin.Int
         * KTypeå¯ä»¥æ‰¾åˆ°æ³›å‹å®å‚
         */
    }
</code></pre>
<h3 id="3è·å–æ¥å£æ–¹æ³•çš„è¿”å›çš„æ³›å‹å®ä¾‹å‚æ•°ç±»å‹">3.è·å–æ¥å£æ–¹æ³•çš„è¿”å›çš„æ³›å‹å®ä¾‹å‚æ•°ç±»å‹</h3>
<pre><code class="language-java">interface Api{
    fun getUsers():List&lt;UserModel&gt;
}

data class UserModel(var id:Int,var name:String)

fun testGetFunParamsType(){
        Api::class.declaredFunctions.first { it.name == &quot;getUsers&quot; }
            .returnType.arguments.forEach {
                print(it)
            }
        //ä¸¤è€…ç›¸åŒ
        Api::getUsers.returnType.arguments.forEach {
            print(it)
        }
    }
</code></pre>
<h3 id="4è·å–å®ä¾‹å¯¹è±¡ä¸Šçš„æ³›å‹çº¦æŸç±»å‹">4.è·å–å®ä¾‹å¯¹è±¡ä¸Šçš„æ³›å‹çº¦æŸç±»å‹</h3>
<pre><code class="language-java">abstract class SuperType&lt;T&gt;{
    val typeParameter by lazy {
        //thisè¡¨ç¤ºçš„æ˜¯å­ç±»çš„å®ä¾‹ï¼Œå› ä¸ºæŠ½è±¡ç±»ä¸èƒ½ç”¨äºåˆ›å»ºå®ä¾‹ï¼Œåªèƒ½èƒŒå½“åšçˆ¶ç±»è¢«å­ç±»ç»§æ‰¿
        this::class.supertypes.first().arguments.first().type
        //å¦‚æœæœ‰å¤šä¸ªå­ç±»ç»§æ‰¿ æ¯”å¦‚class SubType2:SubType(){} 
        //è¿™ä¸ªæ—¶å€™this::class.supertypeä¼šç©ºï¼Œå› ä¸ºSubTypeæ²¡æœ‰æ³›å‹å®å‚è¿™æ—¶å€™è¦ä½¿ç”¨ï¼š
        this::class.allSupertypes.first().arguments.first().type
    }
}

open class SubType:SuperType&lt;String&gt;()

class SubType2:SubType()

fun testGetParentType(){
    val subType = SubType()
    subType.typeParameter.let {
        print(it)
        //kotlin.String
    }
}
</code></pre>
<h2 id="åœºæ™¯å¼•ç”¨-æ·±å±‚æ‹·è´">åœºæ™¯å¼•ç”¨-æ·±å±‚æ‹·è´</h2>
<pre><code class="language-java">    data class Person(val id: Int, val name: String, val group: Group)
    data class Group(val id: Int, val name: String)

/**
 * æ·±å±‚æ•°æ®æ‹·è´
 */
fun &lt;T:Any&gt; T.deepCopy():T{
    if(!this::class.isData){
        return this
    }
    return this::class.primaryConstructor!!.let { primaryConstructor-&gt;
        primaryConstructor.parameters.associate { parameter -&gt;
            val value =
                (this::class as KClass&lt;T&gt;).memberProperties.first { it.name == parameter.name }
                    .get(this)
            if ((parameter.type.classifier as? KClass&lt;*&gt;)?.isData == true) {
                parameter to value?.deepCopy()
            } else {
                parameter to value
            }
        }
            .let {
                primaryConstructor.callBy(it)
                //primaryConstructoræ˜¯KFunction&lt;T&gt;ç±»å‹ KFunction&lt;T&gt;é‡Œé¢æœ‰callByæ–¹æ³• åªè¦ä¼ ä¸€ä¸ªmapï¼Œè¿”å›è°ƒç”¨è€…çš„å‚æ•°ç±»å‹T
            }
    }
}

    private fun testCopy() {
        val group = Group(1, &quot;11111&quot;)
        val person = Person(1, &quot;haha&quot;, group)
        //æµ…å±‚æ‹·è´å®é™…ä¸Šå°±æ˜¯newäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶å°†å½“å‰ç±»çš„å±æ€§ä¼ å…¥ï¼Œé‚£ä¹ˆgroupå°±ä¼ å…¥çš„æ˜¯åŒä¸€ä¸ªäº†
        val copyPerson = person.copy()
        //ä¹Ÿå°±æ˜¯è¯´é€šè¿‡copyçš„æ–¹æ³•ï¼Œå®ç°çš„æ‹·è´ä¸­groupè¿˜æ˜¯æŒ‡å‘çš„åŒä¸€ä¸ªï¼Œé‚£ä¹ˆç›¸åº”çš„ä¿®æ”¹å°±ä¼šé€ æˆåŒæ­¥çš„ä¿®æ”¹
        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, (person === copyPerson).toString()) //false
        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, (person.group === copyPerson.group).toString()) //true

        //æ·±å±‚æ‹·è´çš„ç¬¬ä¸€æ¬¡æ˜¯çœŸçš„æ…¢
        val startTime = System.currentTimeMillis()
        val deepCope = person.deepCopy()
        val endTime = System.currentTimeMillis()

        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, &quot;cost time:${endTime - startTime}&quot;)
        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, (person === deepCope).toString()) //false
        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, (person.group === deepCope.group).toString()) //false
    }
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ANRä»¥åŠç”µé‡ä¼˜åŒ–]]></title>
        <id>https://arms-merchants.github.io/post/anr-yi-ji-dian-liang-you-hua/</id>
        <link href="https://arms-merchants.github.io/post/anr-yi-ji-dian-liang-you-hua/">
        </link>
        <updated>2022-03-01T01:07:44.000Z</updated>
        <content type="html"><![CDATA[<h1 id="appå¯åŠ¨ä¼˜åŒ–åˆ†æ"><a href="https://mp.weixin.qq.com/s/_8ZzgmmP4Ov66f42sBHslA">Appå¯åŠ¨ä¼˜åŒ–åˆ†æ</a></h1>
<h2 id="1anræ˜¯ä»€ä¹ˆ">1.ANRæ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>ANR(Application Not Responding)ç¨‹åºæœªå“åº”ï¼ŒAndroidç³»ç»Ÿä¸­å¦‚æœåœ¨é¢„å®šçš„æ—¶é—´å†…æœªå¾—åˆ°æœ‰æ•ˆçš„å“åº”æˆ–å“åº”æ—¶é—´è¿‡é•¿ï¼Œéƒ½ä¼šäº§ç”ŸANRï¼Œç¨‹åºçš„å“åº”æ€§ç”±ActivityManagerå’ŒWindowManagerç³»ç»ŸæœåŠ¡ç›‘è§†ã€‚</p>
<h2 id="2anrçš„äº§ç”ŸåŸå› ">2.ANRçš„äº§ç”ŸåŸå› ï¼Ÿ</h2>
<ul>
<li>å¯¹äºå‰å°æœåŠ¡ï¼Œåˆ™è¶…æ—¶ä¸ºSERVICE_TIMEOUT = 20sï¼›</li>
<li>å¯¹äºåå°æœåŠ¡ï¼Œåˆ™è¶…æ—¶ä¸ºSERVICE_BACKGROUND_TIMEOUT = 200s</li>
<li>å¯¹äºå‰å°å¹¿æ’­ï¼Œåˆ™è¶…æ—¶ä¸ºBROADCAST_FG_TIMEOUT = 10sï¼›</li>
<li>å¯¹äºåå°å¹¿æ’­ï¼Œåˆ™è¶…æ—¶ä¸ºBROADCAST_BG_TIMEOUT = 60s;</li>
<li>ContentProviderè¶…æ—¶ä¸ºCONTENT_PROVIDER_PUBLISH_TIMEOUT = 10s;</li>
<li>InputDispatching Timeout: è¾“å…¥äº‹ä»¶åˆ†å‘è¶…æ—¶5sï¼ŒåŒ…æ‹¬æŒ‰é”®å’Œè§¦æ‘¸äº‹ä»¶ã€‚</li>
</ul>
<p><code>æ³¨æ„äº‹é¡¹: Inputçš„è¶…æ—¶æœºåˆ¶ä¸å…¶ä»–çš„ä¸åŒï¼Œå¯¹äºinputæ¥è¯´å³ä¾¿æŸæ¬¡äº‹ä»¶æ‰§è¡Œæ—¶é—´è¶…è¿‡timeoutæ—¶é•¿ï¼Œåªè¦ç”¨æˆ·åç»­åœ¨æ²¡æœ‰å†ç”Ÿæˆè¾“å…¥äº‹ä»¶ï¼Œåˆ™ä¸ä¼šè§¦å‘ANR</code></p>
<ul>
<li>
<p>Serviceè¶…æ—¶æ£€æµ‹æœºåˆ¶ï¼š</p>
<ul>
<li>è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰æ‰§è¡Œå®Œç›¸åº”æ“ä½œæ¥è§¦å‘ç§»é™¤å»¶æ—¶æ¶ˆæ¯ï¼Œåˆ™ä¼šè§¦å‘anr;</li>
</ul>
</li>
<li>
<p>BroadcastReceiverè¶…æ—¶æ£€æµ‹æœºåˆ¶ï¼š</p>
<ul>
<li>æœ‰åºå¹¿æ’­çš„æ€»æ‰§è¡Œæ—¶é—´è¶…è¿‡ 2* receiverä¸ªæ•° * timeoutæ—¶é•¿ï¼Œåˆ™ä¼šè§¦å‘anr;<br>
æœ‰åºå¹¿æ’­çš„æŸä¸€ä¸ªreceiveræ‰§è¡Œè¿‡ç¨‹è¶…è¿‡ timeoutæ—¶é•¿ï¼Œåˆ™ä¼šè§¦å‘anr;</li>
</ul>
</li>
<li>
<p>å¦å¤–:</p>
<ul>
<li>å¯¹äºService, Broadcast, Inputå‘ç”ŸANRä¹‹å,æœ€ç»ˆéƒ½ä¼šè°ƒç”¨AMS.appNotResponding;</li>
<li>å¯¹äºprovider,åœ¨å…¶è¿›ç¨‹å¯åŠ¨æ—¶publishè¿‡ç¨‹å¯èƒ½ä¼šå‡ºç°ANR, åˆ™ä¼šç›´æ¥æ€è¿›ç¨‹ä»¥åŠæ¸…ç†ç›¸åº”ä¿¡æ¯,è€Œä¸ä¼šå¼¹å‡ºANRçš„å¯¹è¯æ¡†</li>
</ul>
</li>
</ul>
<h2 id="3anrçš„å®šä½åˆ†æ">3.ANRçš„å®šä½åˆ†æ</h2>
<ol>
<li>å‰å°ANRå‘ç”Ÿåï¼Œç³»ç»Ÿä¼šé©¬ä¸Šå»æŠ“å–ç°åœºçš„ä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•åˆ†æï¼Œæ”¶é›†çš„ä¿¡æ¯å¦‚ä¸‹:</li>
</ol>
<ul>
<li>å°†am_anrä¿¡æ¯è¾“å‡ºåˆ°EventLogï¼Œä¹Ÿå°±æ˜¯è¯´ANRè§¦å‘çš„æ—¶é—´ç‚¹æœ€æ¥è¿‘çš„å°±æ˜¯EventLogä¸­è¾“å‡ºçš„am_anrä¿¡æ¯</li>
<li>æ”¶é›†ä»¥ä¸‹é‡è¦è¿›ç¨‹çš„å„ä¸ªçº¿ç¨‹è°ƒç”¨æ ˆtraceä¿¡æ¯ï¼Œä¿å­˜åœ¨data/anr/traces.txtæ–‡ä»¶
<ul>
<li>å½“å‰å‘ç”ŸANRçš„è¿›ç¨‹ï¼Œsystem_serverè¿›ç¨‹ä»¥åŠæ‰€æœ‰persistentè¿›ç¨‹</li>
<li>audioserver, cameraserver, mediaserver, surfaceflingerç­‰é‡è¦çš„nativeè¿›ç¨‹</li>
<li>CPUä½¿ç”¨ç‡æ’åå‰5çš„è¿›ç¨‹</li>
</ul>
</li>
<li>å°†å‘ç”ŸANRçš„reasonä»¥åŠCPUä½¿ç”¨æƒ…å†µä¿¡æ¯è¾“å‡ºåˆ°main log</li>
<li>å°†tracesæ–‡ä»¶å’ŒCPUä½¿ç”¨æƒ…å†µä¿¡æ¯ä¿å­˜åˆ°dropboxï¼Œå³data/system/dropboxç›®å½•</li>
<li>å¯¹ç”¨æˆ·å¯æ„ŸçŸ¥çš„è¿›ç¨‹åˆ™å¼¹å‡ºANRå¯¹è¯æ¡†å‘ŠçŸ¥ç”¨æˆ·ï¼Œå¯¹ç”¨æˆ·ä¸å¯æ„ŸçŸ¥çš„è¿›ç¨‹å‘ç”ŸANRåˆ™ç›´æ¥æ€æ‰</li>
</ul>
<ol start="2">
<li>åˆ†ææ­¥éª¤
<ol>
<li>å®šä½å‘ç”ŸANRæ—¶é—´ç‚¹</li>
<li>æŸ¥çœ‹traceä¿¡æ¯</li>
<li>åˆ†ææ˜¯å¦æœ‰è€—æ—¶çš„message,binderè°ƒç”¨ï¼Œé”çš„ç«äº‰ï¼ŒCPUèµ„æºçš„æŠ¢å </li>
<li>ç»“åˆå…·ä½“çš„ä¸šåŠ¡åœºæ™¯çš„ä¸Šä¸‹æ–‡æ¥åˆ†æ</li>
</ol>
</li>
</ol>
<h2 id="4ç”µé‡ä¼˜åŒ–å·¥å…·">4.ç”µé‡ä¼˜åŒ–å·¥å…·</h2>
<pre><code>Profiler - NetWork(ç½‘ç»œåˆ†æ),CPUï¼ˆCPUä½¿ç”¨åˆ†æï¼ŒæŸ¥çœ‹å½“å‰CPUè¿è¡Œçš„çŠ¶æ€ï¼Œåˆ¤æ–­å¡é¡¿å‘ç”Ÿæ—¶çš„çŠ¶æ€ï¼‰,Memoryï¼ˆå†…å­˜ä½¿ç”¨åˆ†æï¼Œå†…å­˜æŠ–åŠ¨ï¼Œå†…å­˜æ³„æ¼ï¼ŒOOMçš„åˆ†æï¼‰
</code></pre>
<h2 id="5ç”µé‡ä¼˜åŒ–æ–¹æ¡ˆ">5.ç”µé‡ä¼˜åŒ–æ–¹æ¡ˆ</h2>
<p>å‡å°‘æ“ä½œï¼Œä¾‹å¦‚æ•°æ®ä¸‹è½½æ˜¯å¦æ¯æ¬¡éƒ½éœ€è¦å»æ›´æ–°æœ€æ–°çš„æ•°æ®ï¼Œæ˜¯å¦æœ‰ç¼“å­˜çš„å¿…è¦ã€‚<br>
æ¨è¿Ÿæ“ä½œï¼Œä¸€äº›è€—ç”µæ“ä½œæ˜¯å¦åœ¨ç‰¹å®šçš„çŠ¶æ€ä¸‹ï¼ˆç”µé‡æ»¡æˆ–è€…å……ç”µçŠ¶æ€ä¸‹ï¼‰è¿›è¡Œï¼Œä¾‹å¦‚æŒç»­çš„å®šä½<br>
åˆå¹¶æ“ä½œ<br>
DNSçš„ä¼˜åŒ–ï¼šHTTPDNSï¼Œå¯ä»¥æ¥å…¥ä¸‰æ–¹æä¾›çš„dnsè§£æï¼Œ<a href="https://help.aliyun.com/product/30100.html"><code>é˜¿é‡Œäº‘HTTPDNS</code></a><br>
æ•°æ®å‹ç¼©ï¼šPtotobuf</p>
<h3 id="é˜¿é‡Œmavne"><a href="https://developer.aliyun.com/mvn/view"><code>é˜¿é‡ŒMavne</code></a></h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¸¸ç”¨çš„æ•°æ®ç»“æ„åˆ†æ]]></title>
        <id>https://arms-merchants.github.io/post/chang-yong-de-shu-ju-jie-gou-fen-xi/</id>
        <link href="https://arms-merchants.github.io/post/chang-yong-de-shu-ju-jie-gou-fen-xi/">
        </link>
        <updated>2022-02-22T01:37:02.000Z</updated>
        <content type="html"><![CDATA[<p>å¸¸ç”¨çš„æ•°æ®ç»“æ„<br>
ArrayListï¼šåº•å±‚ç”±æ•°ç»„å®ç°ï¼Œæ‰€ä»¥å®ƒåœ¨å†…å­˜ä¸­æ˜¯ä¸€å—è¿ç»­çš„ç©ºé—´</p>
<pre><code class="language-java">/**
ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ç›´æ¥åœ¨æ·»åŠ ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ·»åŠ åœ¨æ•°ç»„çš„æœ€åï¼Œè¿™ä¸ªæ—¶å€™åªéœ€è¦è®©size++çš„å…ƒç´ å¡«å……ä¸ºe
*/
    public boolean add(E e) {
        ensureCapacityInternal(size + 1);  // Increments modCount!!
        elementData[size++] = e;
        return true;
    }
/**
åœ¨æŒ‡å®šçš„ä½ç½®æ’å…¥ï¼ŒSystem.arraycopyé¦–å…ˆä¼šå°†å½“å‰indexåˆ°æ•°ç»„æœ€åçš„å…ƒç´ åç§»æ‹·è´ä¸€ä»½ï¼Œå†å°†æ’å…¥çš„å…ƒç´ æ’å…¥index
*/
    public void add(int index, E element) {
        if (index &gt; size || index &lt; 0)
            throw new IndexOutOfBoundsException(outOfBoundsMsg(index));

        ensureCapacityInternal(size + 1);  // Increments modCount!!
        System.arraycopy(elementData, index, elementData, index + 1,
                         size - index);
        elementData[index] = element;
        size++;
    }
</code></pre>
<p>æ‰€ä»¥åœ¨addçš„æ—¶å€™å¦‚æœæ˜¯å‘ç”Ÿåœ¨ä¸­é—´çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆä¼šå‘ç”Ÿä¸€æ¬¡æ•°æ®æ‹·è´</p>
<pre><code class="language-java">  public E remove(int index) {
        if (index &gt;= size)
            throw new IndexOutOfBoundsException(outOfBoundsMsg(index));

        modCount++;
        E oldValue = (E) elementData[index];

        int numMoved = size - index - 1;
        if (numMoved &gt; 0)
            System.arraycopy(elementData, index+1, elementData, index,
                             numMoved);
        elementData[--size] = null; // clear to let GC do its work

        return oldValue;
    }
</code></pre>
<p>removeçš„æ“ä½œåŒç†ï¼Œå–å‡ºindexåæ ‡ä¸‹çš„å¯¹è±¡ï¼Œç„¶åé€šè¿‡æ•°æ®æ‹·è´å°†index+1åˆ°æœ«å°¾çš„æ•°æ®å‘å‰æ‹·è´ä¸€ä½ï¼Œå¹¶å°†æ•°ç»„ä¸­æœ€åä¸€ä½ç½®ä¸ºnullï¼Œç­‰å¾…GCã€‚</p>
<pre><code class="language-java">        public E get(int index) {
            if (index &lt; 0 || index &gt;= this.size)
              throw new IndexOutOfBoundsException(outOfBoundsMsg(index));
            if (ArrayList.this.modCount != this.modCount)
                throw new ConcurrentModificationException();
            return (E) ArrayList.this.elementData[offset + index];
        }
</code></pre>
<p>è€Œå› ä¸ºArrayListåœ¨å†…å­˜ä¸­æ˜¯ä¸€ä¸ªè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å½“å®ƒå£°æ˜åå®ƒçš„åœ°å€æ˜¯å·²çŸ¥çš„ï¼Œå¦‚æœåœ¨å†…éƒ¨å­˜å…¥ä¸€ä¸ªObjectçš„å¯¹è±¡ï¼ˆ4ä¸ªå­—èŠ‚ï¼‰é‚£ä¹ˆåªéœ€è¦åœ¨è¿™ä¸ªåœ°å€ä¸ŠåŠ 4å°±èƒ½æŸ¥è¯¢åˆ°å¯¹åº”çš„æ•°æ®ã€‚<br>
æ‰€ä»¥ArrayListåœ¨è¿›è¡ŒæŸ¥è¯¢ï¼Œå’Œç›´æ¥æ·»åŠ æ—¶æ•ˆç‡é«˜ï¼Œä½†æ˜¯åœ¨è¿›è¡Œä¸­é—´æ’å…¥ä»¥åŠåˆ é™¤æ—¶ä¼šå› ä¸ºè¦è¿›è¡Œä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œæ•ˆç‡ä¸é«˜ã€‚<br>
ä¸ArrayListé€šå¸¸è¿›è¡Œæ¯”è¾ƒçš„æ˜¯LinkedListï¼Œä¸€ä¸ªç”±é“¾è¡¨æœºæ„æ„æˆçš„æ•°æ®ç»“æ„ï¼Œå®ƒåœ¨å†…å­˜ä¸­ä¸æ˜¯ä¸€å—è¿ç»­çš„ç©ºé—´ï¼ŒåŒå‘é“¾è¡¨ã€‚</p>
<pre><code class="language-java">    private static class Node&lt;E&gt; {
        //å½“å‰èŠ‚ç‚¹
        E item;
        //å‰é©±
        Node&lt;E&gt; next;
        //åé©±
        Node&lt;E&gt; prev;

        Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) {
            this.item = element;
            this.next = next;
            this.prev = prev;
        }
    }
</code></pre>
<p>é“¾è¡¨ç»“æ„å¸¦æ¥çš„å¥½å¤„æ˜¯ï¼Œåœ¨è¿›è¡Œæ•°æ®æ’å…¥å’Œåˆ é™¤æ—¶ï¼Œåªéœ€è¦ä¿®æ”¹èŠ‚ç‚¹çš„å‰é©±å’Œåé©±æŒ‡å‘å°±å¯ä»¥å®ç°ï¼Œå¹¶ä¸éœ€è¦è¿›è¡Œæ•°æ®çš„æ‹·è´ï¼Œä½†æ˜¯å¦‚æœè¦è¿›è¡Œæ•°æ®æŸ¥è¯¢çš„è¯</p>
<pre><code class="language-java">    public void add(int index, E element) {
        checkPositionIndex(index);

        if (index == size)
            linkLast(element);
        else
            linkBefore(element, node(index));
    }
    //è¿”å›æŒ‡å®šä¸‹æ ‡çš„å¯¹è±¡,getçš„å®ç°ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥è¿›è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰åŠæ³•é€šè¿‡ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çŸ¥é“ç¬¬10èŠ‚ç‚¹çš„å¯¹è±¡ï¼Œå¿…é¡»è¦è¿›è¡Œå¾ªç¯æŸ¥è¯¢ã€‚
    Node&lt;E&gt; node(int index) {
        // assert isElementIndex(index);

        if (index &lt; (size &gt;&gt; 1)) {
            Node&lt;E&gt; x = first;
            for (int i = 0; i &lt; index; i++)
                x = x.next;
            return x;
        } else {
            Node&lt;E&gt; x = last;
            for (int i = size - 1; i &gt; index; i--)
                x = x.prev;
            return x;
        }
    }
    //åœ¨succä¹‹å‰æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå°±æ˜¯æŠŠsuccçš„å‰é©±èŠ‚ç‚¹è®¾ç½®ç»™eï¼Œpredçš„åé©±æŒ‡å‘eï¼Œsuccçš„å‰é©±æŒ‡å‘eï¼Œè¿™æ ·å°±å®Œæˆäº†æ•°æ®æ’å…¥çš„æ“ä½œã€‚åˆ é™¤åä¹‹ã€‚
    void linkBefore(E e, Node&lt;E&gt; succ) {
        // assert succ != null;
        final Node&lt;E&gt; pred = succ.prev;
        final Node&lt;E&gt; newNode = new Node&lt;&gt;(pred, e, succ);
        succ.prev = newNode;
        if (pred == null)
            first = newNode;
        else
            pred.next = newNode;
        size++;
        modCount++;
    }
</code></pre>
<p>æ‰€ä»¥LinkedListæ˜¯ä¸€ç§å¢åˆ æ•ˆç‡å¿«ï¼Œä½†æ˜¯æŸ¥è¯¢æ…¢çš„æ•°æ®ç»“æ„ã€‚<br>
é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ•°æ®ç»“æ„æ˜¯åŒæ—¶å…·æœ‰ä¸¤è€…ä¼˜ç‚¹çš„ï¼ŒHashMap<br>
HashMapåœ¨1.7ä¹‹å‰åä¹‹åçš„ç‰ˆæœ¬æ˜¯ä¸åŒçš„å®ç°<br>
ä¹‹å‰çš„HashMapç»“æ„æ˜¯ç”±æ•°ç»„â•é“¾è¡¨æ„æˆçš„<br>
ä¹‹åçš„HashMapæ˜¯ç”±æ•°ç»„â•é“¾è¡¨â•çº¢é»‘æ ‘æ„æˆçš„</p>
<p>hashç¢°æ’çš„å‡ºç°ï¼Œä»¥åŠè§£å†³æ–¹æ³•ï¼Ÿ<br>
HashMapçš„é»˜è®¤å¤§å°-ã€‹16</p>
<pre><code class="language-java">  static final int DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; // aka 16
</code></pre>
<p>HashMapä»€ä¹ˆæ—¶å€™æ‰©å®¹ï¼Ÿç”±ä»€ä¹ˆå†³å®šçš„ï¼Ÿ</p>
<p>é•¿åº¦ä¸º2çš„æ¬¡å¹‚çš„æ„ä¹‰ï¼Ÿ<br>
å‡å°ç¢°æ’çš„å¯èƒ½<br>
ä¾‹å­ï¼š<br>
Length1 =10<br>
Length2= 16</p>
<p>H1  110 = 6<br>
H2 111 = 7</p>
<p>L1 ï¼š9 = 1001<br>
L2 ï¼š15 = 1111</p>
<p>åˆ†åˆ«æ±‚æ¨¡<br>
110<br>
1001   0000</p>
<p>111<br>
1001 0001</p>
<p>110<br>
1111   0110</p>
<p>111<br>
1111 0111<br>
å¯ä»¥å‘ç°é2æ¬¡å¹‚çš„æƒ…å†µä¸‹ï¼Œä¸­é—´ä¸¤ä½ä¸º0ï¼Œé‚£ä¹ˆå®ƒå°±æ²¡æœ‰è®¡ç®—çš„æ„ä¹‰ï¼Œåªæœ‰é«˜ä½å’Œä½ä½æœ‰å†³å®šä½œç”¨ï¼Œè€Œåœ¨2æ¬¡å¹‚çš„æƒ…å†µä¸‹ï¼Œéƒ½ä¸º1é‚£ä¹ˆéƒ½å‚ä¸è¿ç®—ï¼Œå‡å°‘äº†hashcodeçš„å†²çªå¯èƒ½ã€‚</p>
<p>åŠ è½½å› å­ï¼š</p>
<pre><code class="language-java">    static final float DEFAULT_LOAD_FACTOR = 0.75f;
</code></pre>
<p>é˜™å€¼ï¼š0.75*16ï¼ˆlengthï¼‰ = 12ï¼Œå°±æ˜¯å¦‚æœæ˜¯é»˜è®¤é•¿åº¦çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ•°ç»„é•¿åº¦ã€‹=12çš„è¯ï¼Œé‚£ä¹ˆå°±æ‰©å®¹ã€‚</p>
<p>æ‰©å®¹çš„æ„ä¹‰ï¼šå‡åŒ€åˆ†å¸ƒï¼Œå‡å°å†²çª</p>
<p>Androidç‰¹æœ‰çš„æ•°æ®ç»“æ„ï¼š<br>
SparseArray:åŒæ•°ç»„åˆ†åˆ«å­˜å‚¨keyå’Œvalueï¼Œä½†keyå¿…é¡»ä¸ºintç±»å‹çš„æ•°æ®ï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾çš„æ–¹å¼å»æŸ¥è¯¢keyçš„ä½ç½®ã€‚<br>
ArrayMap:</p>
<pre><code class="language-java">        mHashes[index] = hash;
        mArray[index&lt;&lt;1] = key;
        mArray[(index&lt;&lt;1)+1] = value;
</code></pre>
<p>é€šè¿‡keyçš„hashå€¼æŸ¥æ‰¾åœ¨mHashesä¸­çš„ä¸‹æ ‡ä½ç½®ï¼Œå¹¶å°†keyå’Œvalueå­˜å…¥å¯¹åº”è§„åˆ™çš„indxä¸‹æ ‡å¯¹åº”çš„ä½ç½®ã€‚<br>
è¿™é‡Œè§£å†³äº†SparseArrayçš„keyåªèƒ½ä¸ºintç±»å‹çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯é€šè¿‡ä¸¤ä¸ªæ•°ç»„å®ç°ï¼Œä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜å‚¨çš„æ˜¯keyçš„Hashå€¼ï¼Œå¦å¤–ä¸€ä¸ªæ•°ç»„å­˜å‚¨çš„æ˜¯keyå’Œvalueï¼Œæ‰€ä»¥mArrayçš„é•¿åº¦æ˜¯mHashesçš„2å€ï¼Œåœ¨mArrayçš„ä¸‹æ ‡ä¹Ÿæ˜¯2å€ä¸ºkeyï¼Œ2å€åŠ 1ä¸ºvalueã€‚<br>
ArrayMapæ˜¯å¦‚ä½•è§£å†³Hashç¢°æ’çš„ï¼š</p>
<pre><code class="language-java">int indexOf(Object key, int hash) {
        final int N = mSize;

        // Important fast case: if nothing is in here, nothing to look for.
        if (N == 0) {
            return ~0;
        }

        int index = binarySearchHashes(mHashes, N, hash);

        // If the hash code wasn't found, then we have no entry for this key.
        if (index &lt; 0) {
            return index;
        }

        // If the key at the returned index matches, that's what we want.
        //é€šè¿‡hashè·å–ä¸€ä¸ªä¸‹æ ‡åï¼Œåœ¨å®é™…å­˜å‚¨keyå’Œvalueçš„æ•°ç»„ä¸­æ‹¿å‡ºæ¥è·Ÿå®é™…çš„keyæ¯”è¾ƒä¸€ä¸‹ï¼Œ
        //å¦‚æœä¸€æ ·è¯´æ˜å°±æ˜¯æˆ‘ä»¬éœ€è¦æŸ¥æ‰¾çš„ä¸‹æ ‡ä½ç½®
        if (key.equals(mArray[index&lt;&lt;1])) {
            return index;
        }

        // Search for a matching key after the index.
        int end;
        //å› ä¸ºå¦‚æœå‡ºç°hashç¢°æ’çš„æƒ…å†µä¸‹ï¼Œä¼šå°†mHashesä¸­å­˜å‚¨çš„indexåŠ 1ç›´åˆ°æ²¡æœ‰å†²çªä¸ºæ­¢
        //ä¸Šä¸€æ­¥è·å–åˆ°çš„keyå’Œå®é™…çš„keyä¸ä¸€æ ·ï¼Œå°±æ˜¯å‡ºç°äº†hashç¢°æ’ï¼Œé‚£ä¹ˆåœ¨ä»¥è¿™ä¸ªindex+1çš„èµ·ç‚¹å‘å³æŸ¥æ‰¾,å› ä¸ºhashå‘ç”Ÿäº†ç¢°æ’ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ªèŒƒå›´å†…å­˜å‚¨çš„hashæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¿™ä¸ªä¸€æ ·hashèŒƒå›´å†…æŸ¥æ‰¾
        for (end = index + 1; end &lt; N &amp;&amp; mHashes[end] == hash; end++) {
            if (key.equals(mArray[end &lt;&lt; 1])) return end;
        }
        //å‘å‰æŸ¥æ‰¾
        // Search for a matching key before the index.
        for (int i = index - 1; i &gt;= 0 &amp;&amp; mHashes[i] == hash; i--) {
            if (key.equals(mArray[i &lt;&lt; 1])) return i;
        }

        // Key not found -- return negative value indicating where a
        // new entry for this key should go.  We use the end of the
        // hash chain to reduce the number of array entries that will
        // need to be copied when inserting.
        return ~end;
    }
</code></pre>
<p>æ‰€ä»¥ç›¸å¯¹äºHashMapï¼Œè¿™ä¸¤è€…éƒ½æ˜¯ä¼˜åŒ–äº†å†…å­˜ç©ºé—´çš„ä½¿ç”¨ï¼Œå› ä¸ºHashMapæ˜¯é‡‡ç”¨ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ï¼Œåªè¦åˆ°è¾¾75%çš„å®¹é‡å°±ä¼šç¿»å€æ‰©å®¹ï¼Œå“ªæ€•æ˜¯åªå­˜å‚¨ä¸€ä¸ªæ•°æ®ã€‚</p>
<p>ä½è¿ç®—ï¼š</p>
<ul>
<li>&lt;&lt;: å·¦ç§»è¿ç®—ç¬¦å·ï¼š num&lt;&lt;1 ,ç›¸å½“äºnumä¹˜ä»¥2</li>
<li>
<blockquote>
<blockquote>
<p>: å³ç§»è¿ç®—ç¬¦å·ï¼š num&gt;&gt;1 ,ç›¸å½“äºnumé™¤ä»¥2</p>
</blockquote>
</blockquote>
</li>
<li>
<blockquote>
<blockquote>
<blockquote>
<p>:æ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½</p>
</blockquote>
</blockquote>
</blockquote>
</li>
</ul>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Handler]]></title>
        <id>https://arms-merchants.github.io/post/handle/</id>
        <link href="https://arms-merchants.github.io/post/handle/">
        </link>
        <updated>2022-01-05T06:11:07.000Z</updated>
        <content type="html"><![CDATA[<h2 id="ä¸€äº›é¢è¯•é—®é¢˜">ä¸€äº›é¢è¯•é—®é¢˜ï¼š</h2>
<ul>
<li>1.ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªHandlerï¼Ÿ</li>
<li>2.ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªlooperï¼Œå¦‚ä½•ä¿è¯çš„ï¼Ÿ</li>
<li>3.Handlerå†…å­˜æ³„æ¼åŸå› ï¼Ÿä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ</li>
<li>4.ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥new Handlerï¼Ÿå¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­new handlerè¦åšä»€ä¹ˆå‡†å¤‡</li>
<li>5.å­çº¿ç¨‹ä¸­ç»´æŠ¤çš„Looperï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯çš„æ—¶å€™å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</li>
<li>6.æ—¢ç„¶å¯ä»¥å­˜åœ¨å¤šä¸ªHandlerå¾€MessageQueueä¸­æ·»åŠ æ•°æ®ï¼ˆå‘æ¶ˆæ¯æ—¶å„ä¸ªHandlerå¯èƒ½å¤„äºä¸åŒçº¿ç¨‹ï¼‰ï¼Œé‚£å®ƒå†…éƒ¨æ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ</li>
<li>7.æˆ‘ä»¬ä½¿ç”¨Messageæ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒï¼Ÿ</li>
<li>8.Looperæ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ</li>
</ul>
<hr>
<p>é¦–å…ˆäº†è§£Handleæ˜¯ç”¨äºçº¿ç¨‹é—´é€šè®¯çš„ï¼Œæ˜¯æ•´ä¸ªAppä¸­çš„é€šä¿¡æ¡†æ¶ã€‚</p>
<p>æœ€å¸¸ç”¨çš„sendMessageçš„æµç¨‹<br>
handle.sendMessage() -&gt;messageQueue.enqueueMessage<br>
looper.loop()-&gt;messageQueue.next()-&gt;handler.dispatchMessage()-&gt;handle.handleMessage()<br>
å…¶ä¸­ä¼šæ¶‰åŠåˆ°ç±»åŒ…æ‹¬MessageQueueå’ŒLooperã€‚</p>
<h2 id="1androidå¯åŠ¨ä¸»çº¿ç¨‹ä¸­çš„handler">1.Androidå¯åŠ¨ä¸»çº¿ç¨‹ä¸­çš„Handler</h2>
<p>Handleå‘é€æ¶ˆæ¯åˆ°MessageQueueä¸­ï¼Œç„¶åLooperè¿›è¡Œä¸€ä¸ªæ­»å¾ªç¯æ¥ä»MessageQueueä¸­å–æ¶ˆæ¯ï¼Œç‰¹åˆ«æ˜¯æˆ‘ä»¬åœ¨å­çº¿ç¨‹ä¸­ä½¿ç”¨Handleæ—¶ï¼Œæˆ‘ä»¬è¦è‡ªå·±å»å¯åŠ¨Looperï¼Œä¸ç„¶Handleæ ¹æœ¬ä¸èµ·ä½œç”¨ã€‚ä½†æ˜¯åœ¨Androidçš„ä¸»çº¿ç¨‹ä¸­æˆ‘ä»¬å¹¶æ²¡æœ‰æ‰‹åŠ¨å»å¯åŠ¨looperï¼Œé‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿ<br>
æ¥çœ‹ä¸€ä¸‹Androidç¨‹åºçš„ä¸»å…¥å£ï¼ŒActivityThread.main()-&gt;</p>
<pre><code class="language-java"> public static void main(String[] args) {
        //çœç•¥éƒ¨åˆ†ä»£ç 
        //è¿™é‡Œå¯åŠ¨äº†Looper
        Looper.prepareMainLooper();

        // Find the value for {@link #PROC_START_SEQ_IDENT} if provided on the command line.
        // It will be in the format &quot;seq=114&quot;
        long startSeq = 0;
        if (args != null) {
            for (int i = args.length - 1; i &gt;= 0; --i) {
                if (args[i] != null &amp;&amp; args[i].startsWith(PROC_START_SEQ_IDENT)) {
                    startSeq = Long.parseLong(
                            args[i].substring(PROC_START_SEQ_IDENT.length()));
                }
            }
        }
        ActivityThread thread = new ActivityThread();
        thread.attach(false, startSeq);
        
        if (sMainThreadHandler == null) {
            sMainThreadHandler = thread.getHandler();
        }

        if (false) {
            Looper.myLooper().setMessageLogging(new
                    LogPrinter(Log.DEBUG, &quot;ActivityThread&quot;));
        }

        // End of event ActivityThreadMain.
        Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
        //Looperä¸­æ˜¯ä¸€ä¸ªè½®è¯¢æ“ä½œ
        Looper.loop();
        //æ‰§è¡Œåˆ°è¿™é‡Œè¯´æ˜ä¸»çº¿ç¨‹ä¸­çš„Looperæ„å¤–é€€å‡ºäº†ï¼Œé‚£ä¹ˆç¨‹åºä¹Ÿå°±æŒ‚æ‰äº†
        throw new RuntimeException(&quot;Main thread loop unexpectedly exited&quot;);
    }
</code></pre>
<p>Looperä¸­ç›¸å…³çš„æ–¹æ³•åˆ†æï¼š</p>
<pre><code class="language-java">    /**
    æ„å»ºä¸»çº¿ç¨‹çš„Looperå’ŒMessageQueue
    */
    @Deprecated
    public static void prepareMainLooper() {
        //è¿™é‡Œå°±æ˜¯æ„å»ºäº†ä¸€ä¸ªä¸å…è®¸é€€å‡ºçš„Looperå¹¶æ”¾åˆ°äº†sThreadLocalï¼ˆThreadLocalï¼‰ä¸­
        prepare(false);
        synchronized (Looper.class) {
            if (sMainLooper != null) {
                throw new IllegalStateException(&quot;The main Looper has already been prepared.&quot;);
            }
            //ä¸»çº¿ç¨‹çš„Looper
            sMainLooper = myLooper();
        }
    }
    /**
    quitAllowedæ˜¯å¦å…è®¸é€€å‡º
    */
     private static void prepare(boolean quitAllowed) {
        if (sThreadLocal.get() != null) {
            throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;);
        }
        sThreadLocal.set(new Looper(quitAllowed));
    }

    /**
    looperçš„è½®è¯¢æ“ä½œ
    */
    public static void loop() {
        //è·å–å½“å‰çº¿ç¨‹çš„Looper
        final Looper me = myLooper();
        //å¦‚æœä¸ºç©ºçš„è¯ï¼Œè¯´æ˜Looperè¿˜æ²¡æœ‰åˆ›å»º
        if (me == null) {
            throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn't called on this thread.&quot;);
        }
        if (me.mInLoop) {
            Slog.w(TAG, &quot;Loop again would have the queued messages be executed&quot;
                    + &quot; before this one completed.&quot;);
        }

        me.mInLoop = true;

        // ç¡®ä¿è¯¥çº¿ç¨‹çš„èº«ä»½æ˜¯æœ¬åœ°è¿›ç¨‹çš„èº«ä»½ï¼Œå¹¶è·Ÿè¸ªè¯¥èº«ä»½ä»¤ç‰Œå®é™…ä¸Šæ˜¯ä»€ä¹ˆã€‚
        Binder.clearCallingIdentity();
        final long ident = Binder.clearCallingIdentity();

        // å…è®¸ä½¿ç”¨ç³»ç»Ÿé“å…·è¦†ç›–é˜ˆå€¼ã€‚ä¾‹å¦‚adb shell 'setprop log.looper.1000.main.slow 1 &amp;&amp; åœæ­¢ &amp;&amp; å¼€å§‹'
        final int thresholdOverride =
                SystemProperties.getInt(&quot;log.looper.&quot;
                        + Process.myUid() + &quot;.&quot;
                        + Thread.currentThread().getName()
                        + &quot;.slow&quot;, 0);

        me.mSlowDeliveryDetected = false;

        for (;;) {
            //åœ¨å½“å‰Looperçš„MessageQueueä¸­å–Message
            if (!loopOnce(me, ident, thresholdOverride)) {
                return;
            }
        }
    }
</code></pre>
<h2 id="2ä¸»çº¿ç¨‹çš„handleréƒ½å¤„ç†äº†ä»€ä¹ˆ">2.ä¸»çº¿ç¨‹çš„Handleréƒ½å¤„ç†äº†ä»€ä¹ˆï¼Ÿ</h2>
<pre><code class="language-java">public void handleMessage(Message msg) {
            if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&gt;&gt;&gt; handling: &quot; + codeToString(msg.what));
            switch (msg.what) {
                //è¿™ä¸ªåº”è¯¥æ˜¯åˆå§‹åŒ–åº”ç”¨ä¿¡æ¯çš„,handleBindApplicationä¸­æœ‰è®¾ç½®åº”ç”¨çš„TargetVersionï¼Œæ—¶é—´æ ¼å¼ï¼ˆ12æˆ–è€…24ï¼‰ç­‰
                case BIND_APPLICATION:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;bindApplication&quot;);
                    AppBindData data = (AppBindData)msg.obj;
                    handleBindApplication(data);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //å¤„ç†åº”ç”¨é€€å‡ºï¼Œå¯ä»¥çœ‹åˆ°ä¸»çº¿ç¨‹çš„Looperè°ƒç”¨äº†quitåœæ­¢äº†
                case EXIT_APPLICATION:
                    if (mInitialApplication != null) {
                        mInitialApplication.onTerminate();
                    }
                    Looper.myLooper().quit();
                    break;
                    //è¿™é‡Œåº”è¯¥æ˜¯å¤„ç†å¹¿æ’­æ¥å—
                case RECEIVER:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;broadcastReceiveComp&quot;);
                    handleReceiver((ReceiverData)msg.obj);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //åˆ›å»ºæœåŠ¡
                case CREATE_SERVICE:
                    if (Trace.isTagEnabled(Trace.TRACE_TAG_ACTIVITY_MANAGER)) {
                        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,
                                (&quot;serviceCreate: &quot; + String.valueOf(msg.obj)));
                    }
                    handleCreateService((CreateServiceData)msg.obj);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //ç»‘å®šæœåŠ¡
                case BIND_SERVICE:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;serviceBind&quot;);
                    handleBindService((BindServiceData)msg.obj);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //è§£ç»‘æœåŠ¡
                case UNBIND_SERVICE:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;serviceUnbind&quot;);
                    handleUnbindService((BindServiceData)msg.obj);
                    schedulePurgeIdler();
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //åº”è¯¥æ˜¯å¯åŠ¨æœåŠ¡
                case SERVICE_ARGS:
                    if (Trace.isTagEnabled(Trace.TRACE_TAG_ACTIVITY_MANAGER)) {
                        Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER,
                                (&quot;serviceStart: &quot; + String.valueOf(msg.obj)));
                    }
                    handleServiceArgs((ServiceArgsData)msg.obj);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //åœæ­¢æœåŠ¡
                case STOP_SERVICE:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;serviceStop&quot;);
                    handleStopService((IBinder)msg.obj);
                    schedulePurgeIdler();
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //é…ç½®ä¿¡æ¯å‘ç”Ÿå˜åŒ–ï¼ˆä¸»é¢˜ç­‰ï¼‰
                case CONFIGURATION_CHANGED:
                    mConfigurationController.handleConfigurationChanged((Configuration) msg.obj);
                    break;
                    //ç§»é™¤ä¸Šä¸‹æ–‡ï¼Œçœ‹å†…éƒ¨ä»£ç å®ç°åº”è¯¥æ˜¯æ³¨é”€å¹¿æ’­çš„æ¥å—è€…å’ŒæœåŠ¡çš„Connection
                case CLEAN_UP_CONTEXT:
                    ContextCleanupInfo cci = (ContextCleanupInfo)msg.obj;
                    cci.context.performFinalCleanup(cci.who, cci.what);
                    break;
                    //ç©ºé—²æ—¶è°ƒç”¨GC
                case GC_WHEN_IDLE:
                    scheduleGcIdler();
                    break;
                    //è½¬å‚¨æœåŠ¡ -ä¸æ¸…æ¥šåšä»€ä¹ˆ
                case DUMP_SERVICE:
                    handleDumpService((DumpComponentInfo)msg.obj);
                    break;
                    //è½¬å‚¨ GFXINFO -ä¸æ¸…æ¥šåšä»€ä¹ˆ
                case DUMP_GFXINFO:
                    handleDumpGfxInfo((DumpComponentInfo) msg.obj);
                    break;
                    //å†…å­˜ä½
                case LOW_MEMORY:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;lowMemory&quot;);
                    handleLowMemory();
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //ä¼ æ„Ÿå™¨ï¼Ÿ
                case PROFILER_CONTROL:
                    handleProfilerControl(msg.arg1 != 0, (ProfilerInfo)msg.obj, msg.arg2);
                    break;
                    //åˆ›å»ºå¤‡ä»½--åº”è¯¥å°±æ˜¯activityä¸­åˆ›å»ºå¤‡ä»½çš„åœ°æ–¹
                case CREATE_BACKUP_AGENT:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;backupCreateAgent&quot;);
                    handleCreateBackupAgent((CreateBackupAgentData)msg.obj);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //é”€æ¯å¤‡ä»½
                case DESTROY_BACKUP_AGENT:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;backupDestroyAgent&quot;);
                    handleDestroyBackupAgent((CreateBackupAgentData)msg.obj);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //è‡ªæ€ï¼Œæ€è¿›ç¨‹
                case SUICIDE:
                    Process.killProcess(Process.myPid());
                    break;
                    //ç§»é™¤å†…å®¹æä¾›è€…
                case REMOVE_PROVIDER:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;providerRemove&quot;);
                    completeRemoveProvider((ProviderRefCount)msg.obj);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //åˆ†å‘å¹¿æ’­
                case DISPATCH_PACKAGE_BROADCAST:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;broadcastPackage&quot;);
                    handleDispatchPackageBroadcast(msg.arg1, (String[])msg.obj);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //æŠ›å‡ºè¿œç¨‹æœåŠ¡å¼‚å¸¸
                case SCHEDULE_CRASH:
                    throwRemoteServiceException((String) msg.obj, msg.arg1);
                    break;
                    //å¤„ç†è½¬å‚¨å †
                case DUMP_HEAP:
                    handleDumpHeap((DumpHeapData) msg.obj);
                    break;
                    //å°† Activity çš„çŠ¶æ€æ‰“å°åˆ°ç»™å®šçš„æµä¸­ã€‚ å¦‚æœæ‚¨è¿è¡Œâ€œadb shell dumpsys activity &lt;activity_component_name&gt;â€ï¼Œåˆ™ä¼šè°ƒç”¨å®ƒã€‚
                case DUMP_ACTIVITY:
                    handleDumpActivity((DumpComponentInfo)msg.obj);
                    break;
                    //å°†æä¾›è€…çš„çŠ¶æ€æ‰“å°åˆ°ç»™å®šçš„æµä¸­ã€‚ å¦‚æœæ‚¨è¿è¡Œâ€œadb shell dumpsys activity provider &lt;provider_component_name&gt;â€ï¼Œåˆ™ä¼šè°ƒç”¨æ­¤æ–¹æ³•ã€‚
                case DUMP_PROVIDER:
                    handleDumpProvider((DumpComponentInfo)msg.obj);
                    break;
                    //æ ¸å¿ƒè®¾ç½®ï¼ˆï¼Ÿï¼‰æ›´æ”¹åï¼Œé‡å¯æ‰€æœ‰çš„Activity
                case SET_CORE_SETTINGS:
                    Trace.traceBegin(Trace.TRACE_TAG_ACTIVITY_MANAGER, &quot;setCoreSettings&quot;);
                    handleSetCoreSettings((Bundle) msg.obj);
                    Trace.traceEnd(Trace.TRACE_TAG_ACTIVITY_MANAGER);
                    break;
                    //å¤„ç†æ›´æ–°åŒ…å…¼å®¹æ€§ä¿¡æ¯
                case UPDATE_PACKAGE_COMPATIBILITY_INFO:
                    handleUpdatePackageCompatibilityInfo((UpdateCompatibilityData)msg.obj);
                    break;
                    //å†…å®¹æä¾›è€…é”€æ¯æ—¶ï¼Ÿ
                case UNSTABLE_PROVIDER_DIED:
                    handleUnstableProviderDied((IBinder)msg.obj, false);
                    break;
                    //å¤„ç†è¯·æ±‚ååŠ©ä¸Šä¸‹æ–‡é™„åŠ 
                case REQUEST_ASSIST_CONTEXT_EXTRAS:
                    handleRequestAssistContextExtras((RequestAssistContextExtras)msg.obj);
                    break;
                    //åŠé€æ˜è½¬æ¢å®Œæˆ
                case TRANSLUCENT_CONVERSION_COMPLETE:
                    handleTranslucentConversionComplete((IBinder)msg.obj, msg.arg1 == 1);
                    break;
                    //å¤„ç†å®‰è£…æä¾›ç¨‹åº
                case INSTALL_PROVIDER:
                    handleInstallProvider((ProviderInfo) msg.obj);
                    break;
                    //ä¸€ä¸ªæ–°çš„Activityé€‰é¡¹ï¼Ÿ
                case ON_NEW_ACTIVITY_OPTIONS:
                    Pair&lt;IBinder, ActivityOptions&gt; pair = (Pair&lt;IBinder, ActivityOptions&gt;) msg.obj;
                    onNewActivityOptions(pair.first, pair.second);
                    break;
                    //è¿›å…¥åŠ¨ç”»å®Œæˆ
                case ENTER_ANIMATION_COMPLETE:
                    handleEnterAnimationComplete((IBinder) msg.obj);
                    break;
                    //å¯ç”¨ Binder IPC è·Ÿè¸ªã€‚
                case START_BINDER_TRACKING:
                    handleStartBinderTracking();
                    break;
                    //åº”è¯¥å°±æ˜¯åœæ­¢Binderå¹¶é”€æ¯
                case STOP_BINDER_TRACKING_AND_DUMP:
                    handleStopBinderTrackingAndDump((ParcelFileDescriptor) msg.obj);
                    break;
                    //æœ¬åœ°è¯­éŸ³äº¤äº’å¼€å§‹
                case LOCAL_VOICE_INTERACTION_STARTED:
                    handleLocalVoiceInteractionStarted((IBinder) ((SomeArgs) msg.obj).arg1,
                            (IVoiceInteractor) ((SomeArgs) msg.obj).arg2);
                    break;
                    //é™„åŠ ä»£ç†
                case ATTACH_AGENT: {
                    Application app = getApplication();
                    handleAttachAgent((String) msg.obj, app != null ? app.mLoadedApk : null);
                    break;
                }
                /**
                åŒ…å®‰è£…è§¦å‘çš„æ›´æ–°é€šè¿‡åŒ…æ›´æ–°æ¥æ”¶å™¨ã€‚åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬å°è¯•æ•è·ç”±å…¶ä»–æ¥æºï¼ˆä¾‹å¦‚è¦†ç›–ï¼‰å¼•èµ·çš„ ApplicationInfo æ›´æ”¹ã€‚è¿™æ„å‘³ç€æˆ‘ä»¬å¸Œæœ›å¯¹ä»£ç æ›´æ”¹å°½å¯èƒ½ä¿å®ˆã€‚è·å–æ—§ ApplicationInfo å’Œæ–° ApplicationInfo çš„å·®å¼‚ï¼Œçœ‹çœ‹æ˜¯å¦éœ€è¦æ›´æ”¹ä»»ä½•å†…å®¹ã€‚
                */
                case APPLICATION_INFO_CHANGED:
                    handleApplicationInfoChanged((ApplicationInfo) msg.obj);
                    break;
                    //è¿è¡Œéš”ç¦»å…¥å£ç‚¹
                case RUN_ISOLATED_ENTRY_POINT:
                    handleRunIsolatedEntryPoint((String) ((SomeArgs) msg.obj).arg1,
                            (String[]) ((SomeArgs) msg.obj).arg2);
                    break;
                    //è¿™é‡Œæ˜¯12ä¸­å¯¹ä¹‹å‰ç”Ÿå‘½å‘¨æœŸçš„ä¸€ä¸ªç»Ÿä¸€å…¥å£ï¼Œæ”¹ä¸ºçŠ¶æ€æ¨¡å¼
                case EXECUTE_TRANSACTION:
                    final ClientTransaction transaction = (ClientTransaction) msg.obj;
                    mTransactionExecutor.execute(transaction);
                    if (isSystem()) {
                        // Client transactions inside system process are recycled on the client side
                        // instead of ClientLifecycleManager to avoid being cleared before this
                        // message is handled.
                        transaction.recycle();
                    }
                    // TODO(lifecycler): Recycle locally scheduled transactions.
                    break;
                    //é‡æ–°å¯åŠ¨Activityï¼Œæ´»åŠ¨çŠ¶æ€å¿…é¡»åœ¨ [ON_START..ON_STOP] æ‰èƒ½é‡æ–°å¯åŠ¨
                case RELAUNCH_ACTIVITY:
                    handleRelaunchActivityLocally((IBinder) msg.obj);
                    break;
                    //æ¸…é™¤èµ„æº
                case PURGE_RESOURCES:
                    schedulePurgeIdler();
                    break;
                    //é™„åŠ å¯åŠ¨å‚æ•°
                case ATTACH_STARTUP_AGENTS:
                    handleAttachStartupAgents((String) msg.obj);
                    break;
                    //æ›´æ–°UIçŠ¶æ€
                case UPDATE_UI_TRANSLATION_STATE:
                    final SomeArgs args = (SomeArgs) msg.obj;
                    updateUiTranslationState((IBinder) args.arg1, (int) args.arg2,
                            (TranslationSpec) args.arg3, (TranslationSpec) args.arg4,
                            (List&lt;AutofillId&gt;) args.arg5, (UiTranslationSpec) args.arg6);
                    break;
                    //è¿™é‡Œåº”è¯¥æ˜¯å¯¹åº”å†…å®¹æä¾›è€…çš„ï¼Œå†…å®¹æ”¶é›†è€…
                case SET_CONTENT_CAPTURE_OPTIONS_CALLBACK:
                    handleSetContentCaptureOptionsCallback((String) msg.obj);
                    break;
                    /**
                    åœ¨æ£€æµ‹å¯åŠ¨æ—¶è°ƒç”¨ï¼Œåœ¨åŠ è½½ä»»ä½•åº”ç”¨ç¨‹åºä»£ç ä¹‹å‰ã€‚ é€šå¸¸è¿™å°†è¢«å®ç°ä¸ºç®€å•åœ°è°ƒç”¨startæ¥startæ£€æµ‹çº¿ç¨‹ï¼Œç„¶ååœ¨onStartç»§ç»­æ‰§è¡Œã€‚
å¦‚æœæ‚¨ä¸éœ€è¦è‡ªå·±çš„çº¿ç¨‹â€”â€”ä¹Ÿå°±æ˜¯è¯´ï¼Œæ‚¨æ­£åœ¨ç¼–å†™å®Œå…¨å¼‚æ­¥çš„æ£€æµ‹ï¼ˆè¿”å›åˆ°äº‹ä»¶å¾ªç¯ä»¥ä¾¿åº”ç”¨ç¨‹åºå¯ä»¥è¿è¡Œï¼‰ï¼Œæ‚¨å¯ä»¥ç®€å•åœ°åœ¨æ­¤å¤„å¼€å§‹æ£€æµ‹ï¼Œä¾‹å¦‚è°ƒç”¨Context.startActivityå¼€å§‹é€‚å½“çš„åº”ç”¨ç¨‹åºçš„ç¬¬ä¸€ä¸ªæ´»åŠ¨ã€‚
                    */
                case INSTRUMENT_WITHOUT_RESTART:
                    handleInstrumentWithoutRestart((AppBindData) msg.obj);
                    break;
                    //é”€æ¯ä¸Šé¢çš„æ£€æµ‹å¯¹è±¡
                case FINISH_INSTRUMENTATION_WITHOUT_RESTART:
                    handleFinishInstrumentationWithoutRestart();
                    break;
            }
            Object obj = msg.obj;
            if (obj instanceof SomeArgs) {
                ((SomeArgs) obj).recycle();
            }
            if (DEBUG_MESSAGES) Slog.v(TAG, &quot;&lt;&lt;&lt; done: &quot; + codeToString(msg.what));
        }
</code></pre>
<p>å¯ä»¥çœ‹åˆ°å’Œå››å¤§ç»„ä»¶ï¼ˆActivityï¼ŒServiceï¼ŒBroadcastï¼ŒContentProviderï¼‰ç›¸å…³çš„éƒ½æœ‰,è¿˜æœ‰åº”ç”¨ä¿¡æ¯çš„è®¾ç½®ï¼Œå¯åŠ¨å’Œå…³é—­åº”ç”¨ï¼ŒUIçš„æ›´æ–°</p>
<h2 id="3handlerçš„æ¶ˆæ¯å‘é€">3.Handlerçš„æ¶ˆæ¯å‘é€</h2>
<p>æœ€å¸¸ä½¿ç”¨çš„sendMessageï¼š</p>
<pre><code class="language-java"> public final boolean sendMessage(@NonNull Message msg) {
        return sendMessageDelayed(msg, 0);
}

public final boolean sendMessageDelayed(@NonNull Message msg, long delayMillis) {
     if (delayMillis &lt; 0) {
        delayMillis = 0;
    }
     return sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);
}

 public boolean sendMessageAtTime(@NonNull Message msg, long uptimeMillis) {
     //æ¶ˆæ¯é˜Ÿåˆ—
    MessageQueue queue = mQueue;
    if (queue == null) {
        RuntimeException e = new RuntimeException(
                this + &quot; sendMessageAtTime() called with no mQueue&quot;);
         Log.w(&quot;Looper&quot;, e.getMessage(), e);
         return false;
    }
     return enqueueMessage(queue, msg, uptimeMillis);
 }

private boolean enqueueMessage(@NonNull MessageQueue queue, @NonNull Message msg,
            long uptimeMillis) {
    //æ¶ˆæ¯è¿™é‡Œä¹Ÿå°±å’ŒHandlerè¿›è¡Œçš„ç»‘å®šï¼Œæ‰€ä»¥è¿™é‡Œä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆHandlerä¼šæœ‰å†…å­˜æº¢å‡ºçš„é—®é¢˜
    //handlerçš„å¤„ç†ä¸€èˆ¬éƒ½æ˜¯ä½œä¸ºå†…éƒ¨ç±»å»ä½¿ç”¨ï¼Œä½†æ˜¯å½“handleræŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨æ—¶ï¼Œè€Œæ¶ˆæ¯éœ€è¦ç­‰å¾…çš„æ—¶é—´æ¯”è¾ƒé•¿ï¼Œ
    //ä¾‹å¦‚20åˆ†é’Ÿï¼Œä½†æ˜¯å½“å‰çš„Activityå·²ç»é€€å‡ºè¦é”€æ¯ï¼Œæ ¹æ®GCçš„å¯è¾¾æ€§åˆ†æï¼ŒMessageæŒæœ‰Handlerï¼Œ
    //HandleråˆæŒæœ‰Activityçš„å¼•ç”¨ï¼Œæ‰€ä»¥è¿™é‡ŒGCå°±æ— æ³•è¿›è¡Œå›æ”¶ï¼Œä»è€Œå‘ç”Ÿå¼‚å¸¸ã€‚å†…å­˜æº¢å‡ºå¾ˆå¤§çš„å¯èƒ½
    //éƒ½æ˜¯å› ä¸ºç”Ÿå‘½å‘¨æœŸä¸ä¸€è‡´å¼•èµ·çš„ã€‚
    msg.target = this;
    msg.workSourceUid = ThreadLocalWorkSource.getUid();

    if (mAsynchronous) {
        msg.setAsynchronous(true);
    }
    //è§MessageQueueçš„æ–¹æ³•åˆ†æ
     return queue.enqueueMessage(msg, uptimeMillis);
}
</code></pre>
<p>MessageQueueç›¸å…³æ–¹æ³•åˆ†æï¼š</p>
<pre><code class="language-java">boolean enqueueMessage(Message msg, long when) {
    //msgçš„targetå°±æ˜¯handlerï¼Œå¦‚æœæ²¡æœ‰é‚£ä¹ˆè¿™å°±æ²¡æœ‰æ¶ˆè´¹è€…äº†
        if (msg.target == null) {
            throw new IllegalArgumentException(&quot;Message must have a target.&quot;);
        }
        //åŠ é”ä¿è¯åœ¨åŒä¸€æ—¶åˆ»åªæœ‰ä¸€ä¸ªæ’å…¥æ¶ˆæ¯é˜Ÿåˆ—çš„æ“ä½œï¼Œå¹¶ä¸”æ²¡æœ‰å…¶ä»–çš„æ“ä½œï¼ˆå–æ¶ˆæ¯å’Œæ¶ˆæ¯é€€å‡ºï¼‰
        synchronized (this) {
            if (msg.isInUse()) {
                throw new IllegalStateException(msg + &quot; This message is already in use.&quot;);
            }
            //Looperé€€å‡ºæ—¶ä¼šè°ƒç”¨MessageQueueçš„quitè®¾ç½®mQuittingä¸ºtrue
            if (mQuitting) {
                IllegalStateException e = new IllegalStateException(
                        msg.target + &quot; sending message to a Handler on a dead thread&quot;);
                Log.w(TAG, e.getMessage(), e);
                msg.recycle();
                return false;
            }

            msg.markInUse();
            msg.when = when;
            Message p = mMessages;
            boolean needWake;
            if (p == null || when == 0 || when &lt; p.when) {
                // New head, wake up the event queue if blocked.
                msg.next = p;
                mMessages = msg;
                needWake = mBlocked;
            } else {
                // æ’å…¥é˜Ÿåˆ—ä¸­é—´ã€‚é€šå¸¸æˆ‘ä»¬ä¸å¿…å”¤é†’äº‹ä»¶é˜Ÿåˆ—ï¼Œé™¤éé˜Ÿåˆ—çš„å¤´éƒ¨æœ‰ä¸€ä¸ªbarrierï¼ˆåŒæ­¥å±éšœï¼‰ï¼Œå¹¶ä¸”è¯¥æ¶ˆæ¯æ˜¯é˜Ÿåˆ—ä¸­æœ€æ—©çš„å¼‚æ­¥æ¶ˆæ¯ã€‚
                needWake = mBlocked &amp;&amp; p.target == null &amp;&amp; msg.isAsynchronous();
                Message prev;
                for (;;) {
                    prev = p;
                    p = p.next;
                    if (p == null || when &lt; p.when) {
                        break;
                    }
                    if (needWake &amp;&amp; p.isAsynchronous()) {
                        needWake = false;
                    }
                }
                msg.next = p; // invariant: p == prev.next
                prev.next = msg;
            }

            // We can assume mPtr != 0 because mQuitting is false.
            //åœ¨è¿™é‡Œå¦‚æœå½“å‰çš„Looperæ˜¯éœ€è¦å”¤é†’çš„ï¼Œè¿™é‡Œä¼šæ‰§è¡Œ
            if (needWake) {
                nativeWake(mPtr);
            }
        }
        return true;
    }
</code></pre>
<p>åˆ°è¿™é‡ŒMessageå·²ç»åˆ°æ”¾å…¥åˆ°MessageQueueä¸­äº†ï¼Œé‚£ä¹ˆåˆæ˜¯å¦‚ä½•æŠŠæ¶ˆæ¯å–å‡ºæ¥çš„å¹¶å›æ‰ç»™Handlerä¸­çš„handleMessage(Message msg)æ–¹æ³•çš„å‘¢ï¼Ÿ</p>
<h2 id="4handlehandlemessageçš„å›è°ƒ">4.Handle.handleMessage()çš„å›è°ƒ</h2>
<p>å‰é¢æˆ‘ä»¬å·²ç»çœ‹åˆ°ï¼ŒHandleréœ€è¦åœ¨å¿…é¡»åœ¨Looperçš„ç¯å¢ƒä¸­</p>
<pre><code class="language-java">public static void loop() {
        final Looper me = myLooper();
        //åˆ¤æ–­æ˜¯å¦è¿˜æ²¡æœ‰å¯åŠ¨Looper
        if (me == null) {
            throw new RuntimeException(&quot;No Looper; Looper.prepare() wasn't called on this thread.&quot;);
        }
        //åˆ¤æ–­æ˜¯å¦é‡å¤å¯åŠ¨Looper
        if (me.mInLoop) {
            Slog.w(TAG, &quot;Loop again would have the queued messages be executed&quot;
                    + &quot; before this one completed.&quot;);
        }

        me.mInLoop = true;

        // Make sure the identity of this thread is that of the local process,
        // and keep track of what that identity token actually is.
        Binder.clearCallingIdentity();
        final long ident = Binder.clearCallingIdentity();

        // Allow overriding a threshold with a system prop. e.g.
        // adb shell 'setprop log.looper.1000.main.slow 1 &amp;&amp; stop &amp;&amp; start'
        final int thresholdOverride =
                SystemProperties.getInt(&quot;log.looper.&quot;
                        + Process.myUid() + &quot;.&quot;
                        + Thread.currentThread().getName()
                        + &quot;.slow&quot;, 0);

        me.mSlowDeliveryDetected = false;
        //è½®è¯¢è·å–MessageQueueä¸­çš„message
        for (;;) {
            if (!loopOnce(me, ident, thresholdOverride)) {
                return;
            }
        }
    }

    private static boolean loopOnce(final Looper me,
            final long ident, final int thresholdOverride) {
        Message msg = me.mQueue.next(); // might block
        if (msg == null) {
            //æ²¡æœ‰æ¶ˆæ¯è¡¨ç¤ºæ¶ˆæ¯é˜Ÿåˆ—æ­£åœ¨é€€å‡ºã€‚
            return false;
        }

        // This must be in a local variable, in case a UI event sets the logger
        final Printer logging = me.mLogging;
        if (logging != null) {
            logging.println(&quot;&gt;&gt;&gt;&gt;&gt; Dispatching to &quot; + msg.target + &quot; &quot;
                    + msg.callback + &quot;: &quot; + msg.what);
        }
        // Make sure the observer won't change while processing a transaction.
        final Observer observer = sObserver;

        final long traceTag = me.mTraceTag;
        long slowDispatchThresholdMs = me.mSlowDispatchThresholdMs;
        long slowDeliveryThresholdMs = me.mSlowDeliveryThresholdMs;
        if (thresholdOverride &gt; 0) {
            slowDispatchThresholdMs = thresholdOverride;
            slowDeliveryThresholdMs = thresholdOverride;
        }
        final boolean logSlowDelivery = (slowDeliveryThresholdMs &gt; 0) &amp;&amp; (msg.when &gt; 0);
        final boolean logSlowDispatch = (slowDispatchThresholdMs &gt; 0);

        final boolean needStartTime = logSlowDelivery || logSlowDispatch;
        final boolean needEndTime = logSlowDispatch;

        if (traceTag != 0 &amp;&amp; Trace.isTagEnabled(traceTag)) {
            Trace.traceBegin(traceTag, msg.target.getTraceName(msg));
        }

        final long dispatchStart = needStartTime ? SystemClock.uptimeMillis() : 0;
        final long dispatchEnd;
        Object token = null;
        if (observer != null) {
            token = observer.messageDispatchStarting();
        }
        long origWorkSource = ThreadLocalWorkSource.setUid(msg.workSourceUid);
        try {
            //è¿™é‡Œçš„targetå°±æ˜¯Handlerï¼Œå¤„ç†æ¶ˆæ¯çš„åˆ†å‘
            msg.target.dispatchMessage(msg);
            if (observer != null) {
                observer.messageDispatched(token, msg);
            }
            dispatchEnd = needEndTime ? SystemClock.uptimeMillis() : 0;
        } catch (Exception exception) {
            if (observer != null) {
                observer.dispatchingThrewException(token, msg, exception);
            }
            throw exception;
        } finally {
            ThreadLocalWorkSource.restore(origWorkSource);
            if (traceTag != 0) {
                Trace.traceEnd(traceTag);
            }
        }
        if (logSlowDelivery) {
            if (me.mSlowDeliveryDetected) {
                if ((dispatchStart - msg.when) &lt;= 10) {
                    Slog.w(TAG, &quot;Drained&quot;);
                    me.mSlowDeliveryDetected = false;
                }
            } else {
                if (showSlowLog(slowDeliveryThresholdMs, msg.when, dispatchStart, &quot;delivery&quot;,
                        msg)) {
                    // Once we write a slow delivery log, suppress until the queue drains.
                    me.mSlowDeliveryDetected = true;
                }
            }
        }
        if (logSlowDispatch) {
            showSlowLog(slowDispatchThresholdMs, dispatchStart, dispatchEnd, &quot;dispatch&quot;, msg);
        }

        if (logging != null) {
            logging.println(&quot;&lt;&lt;&lt;&lt;&lt; Finished to &quot; + msg.target + &quot; &quot; + msg.callback);
        }

        // Make sure that during the course of dispatching the
        // identity of the thread wasn't corrupted.
        final long newIdent = Binder.clearCallingIdentity();
        if (ident != newIdent) {
            Log.wtf(TAG, &quot;Thread identity changed from 0x&quot;
                    + Long.toHexString(ident) + &quot; to 0x&quot;
                    + Long.toHexString(newIdent) + &quot; while dispatching to &quot;
                    + msg.target.getClass().getName() + &quot; &quot;
                    + msg.callback + &quot; what=&quot; + msg.what);
        }
        //æ¶ˆæ¯å›æ”¶
        msg.recycleUnchecked();

        return true;
    }
</code></pre>
<p>è¿™é‡Œæˆ‘ä»¬é¦–å…ˆè¦çœ‹ä¸€ä¸‹MessageQueueä¸­çš„nextæ€ä¹ˆè·å–æ¶ˆæ¯çš„</p>
<pre><code class="language-java">Message next() {
        //å¦‚æœæ¶ˆæ¯å¾ªç¯å·²ç»é€€å‡ºå¹¶è¢«å¤„ç†ï¼Œåˆ™è¿”å›æ­¤å¤„ã€‚å¦‚æœåº”ç”¨ç¨‹åºåœ¨é€€å‡ºåå°è¯•é‡æ–°å¯åŠ¨ä¸å—æ”¯æŒçš„ Looperï¼Œå°±ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚
        final long ptr = mPtr;
        if (ptr == 0) {
            return null;
        }

        int pendingIdleHandlerCount = -1; // -1 only during first iteration
        int nextPollTimeoutMillis = 0;
        for (;;) {
            if (nextPollTimeoutMillis != 0) {
                Binder.flushPendingCommands();
            }

            nativePollOnce(ptr, nextPollTimeoutMillis);

            synchronized (this) {
                // Try to retrieve the next message.  Return if found.
                final long now = SystemClock.uptimeMillis();
                Message prevMsg = null;
                Message msg = mMessages;
                //æŸ¥æ‰¾åŒæ­¥å±éšœçš„æ¶ˆæ¯
                if (msg != null &amp;&amp; msg.target == null) {
                    // Stalled by a barrier.  Find the next asynchronous message in the queue.
                    do {
                        prevMsg = msg;
                        msg = msg.next;
                    } while (msg != null &amp;&amp; !msg.isAsynchronous());
                }
                if (msg != null) {
                    if (now &lt; msg.when) {
                        //ä¸‹ä¸€æ¡æ¶ˆæ¯æœªå‡†å¤‡å¥½ã€‚è®¾ç½®è¶…æ—¶ä»¥åœ¨å‡†å¤‡å¥½æ—¶å”¤é†’ã€‚
                        nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);
                    } else {
                        // Got a message.
                        mBlocked = false;
                        if (prevMsg != null) {
                            prevMsg.next = msg.next;
                        } else {
                            mMessages = msg.next;
                        }
                        msg.next = null;
                        if (DEBUG) Log.v(TAG, &quot;Returning message: &quot; + msg);
                        msg.markInUse();
                        //è¿™é‡Œè¿”å›å½“å‰éœ€è¦å¤„ç†çš„æ¶ˆæ¯
                        return msg;
                    }
                } else {
                    // No more messages.
                    nextPollTimeoutMillis = -1;
                }

                //ç°åœ¨å¤„ç†é€€å‡ºæ¶ˆæ¯ï¼Œæ‰€æœ‰æŒ‚èµ·çš„æ¶ˆæ¯éƒ½å·²å¤„ç†å®Œæ¯•ã€‚
                if (mQuitting) {
                    dispose();
                    return null;
                }

                // å¦‚æœç¬¬ä¸€æ¬¡ç©ºé—²ï¼Œåˆ™è·å–è¦è¿è¡Œçš„ç©ºé—²ç¨‹åºçš„æ•°é‡ã€‚ç©ºé—²å¥æŸ„ä»…åœ¨é˜Ÿåˆ—ä¸ºç©ºæˆ–é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼ˆå¯èƒ½æ˜¯éšœç¢ï¼‰å°†åœ¨æœªæ¥å¤„ç†æ—¶è¿è¡Œã€‚
                if (pendingIdleHandlerCount &lt; 0
                        &amp;&amp; (mMessages == null || now &lt; mMessages.when)) {
                    pendingIdleHandlerCount = mIdleHandlers.size();
                }
                if (pendingIdleHandlerCount &lt;= 0) {
                    // No idle handlers to run.  Loop and wait some more.
                    mBlocked = true;
                    continue;
                }

                if (mPendingIdleHandlers == null) {
                    mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)];
                }
                mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);
            }

            // Run the idle handlers.
            // We only ever reach this code block during the first iteration.
            for (int i = 0; i &lt; pendingIdleHandlerCount; i++) {
                final IdleHandler idler = mPendingIdleHandlers[i];
                mPendingIdleHandlers[i] = null; // release the reference to the handler

                boolean keep = false;
                try {
                    keep = idler.queueIdle();
                } catch (Throwable t) {
                    Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t);
                }

                if (!keep) {
                    synchronized (this) {
                        mIdleHandlers.remove(idler);
                    }
                }
            }

            // Reset the idle handler count to 0 so we do not run them again.
            pendingIdleHandlerCount = 0;

            // While calling an idle handler, a new message could have been delivered
            // so go back and look again for a pending message without waiting.
            nextPollTimeoutMillis = 0;
        }
    }
</code></pre>
<p>åœ¨è·å–åˆ°æ¶ˆæ¯ä¹‹åï¼Œåœ¨Looperä¸­çš„loopOnceæ–¹æ³•é‡Œ msg.target.dispatchMessage(msg);ï¼Œå…¶ä¸­Messageçš„Targetå°±æ˜¯Handler</p>
<pre><code class="language-java">  public void dispatchMessage(@NonNull Message msg) {
        if (msg.callback != null) {
            handleCallback(msg);
        } else {
            if (mCallback != null) {
                if (mCallback.handleMessage(msg)) {
                    return;
                }
            }
            //handleMessageè¢«è°ƒç”¨äº†
            handleMessage(msg);
        }
    }
</code></pre>
<p>åˆ°è¿™ä¸€æ­¥æ•´ä¸ªæµç¨‹ä¸²èµ·æ¥äº†ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜</p>
<ul>
<li>1.å½“æ¶ˆæ¯é˜Ÿåˆ—æ²¡æœ‰æ¶ˆæ¯çš„æ—¶å€™ï¼ŒLooperæ˜¯å¤„äºä»€ä¹ˆæ ·çš„çŠ¶æ€ï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ä¸ªå¾ªç¯æ“ä½œï¼Œä¼šé˜»å¡çº¿ç¨‹ï¼Ÿ</li>
<li>2.å½“é˜Ÿåˆ—ä¸­ç¬¬ä¸€ä¸ªæ¶ˆæ¯çš„è§¦å‘æ—¶é—´è¿˜æ²¡åˆ°çš„è¯ï¼Œåˆæ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿ<br>
è¿™ä¸ªä¸¤ä¸ªé—®é¢˜æˆ‘ä»¬éƒ½å¯ä»¥ä»MessageQueueä¸­çš„next()æ–¹æ³•ä¸­æ‰¾åˆ°ç­”æ¡ˆï¼š</li>
</ul>
<pre><code class="language-java"> Message next() {
        // Return here if the message loop has already quit and been disposed.
        // This can happen if the application tries to restart a looper after quit
        // which is not supported.
        final long ptr = mPtr;
        if (ptr == 0) {
            return null;
        }

        int pendingIdleHandlerCount = -1; // -1 only during first iteration
        int nextPollTimeoutMillis = 0;
        for (;;) {
            if (nextPollTimeoutMillis != 0) {
                Binder.flushPendingCommands();
            }
            //nextPollTimeoutMilliså°±æ˜¯ä¸‹ä¸€ä¸ªä»»åŠ¡éœ€è¦ç­‰å¾…æ‰§è¡Œçš„æ—¶é—´ï¼Œå¦‚æœnextPollTimeoutMillisä¸º-1ï¼Œé‚£ä¹ˆè¿™ä¸ªLooperä¼šä¸€ç›´ä¼‘çœ ç­‰å¾…ä¸‹å»ï¼Œæ‰€ä»¥å­çº¿ç¨‹ä¸­çš„Looperæ²¡æœ‰æ¶ˆæ¯è¦å¤„ç†äº†è¦åŠæ—¶è°ƒç”¨quite
            nativePollOnce(ptr, nextPollTimeoutMillis);

            synchronized (this) {
                // Try to retrieve the next message.  Return if found.
                final long now = SystemClock.uptimeMillis();
                Message prevMsg = null;
                Message msg = mMessages;
                if (msg != null &amp;&amp; msg.target == null) {
                    // Stalled by a barrier.  Find the next asynchronous message in the queue.
                    do {
                        prevMsg = msg;
                        msg = msg.next;
                    } while (msg != null &amp;&amp; !msg.isAsynchronous());
                }
                if (msg != null) {
                    if (now &lt; msg.when) {
                        //è·å–åˆ°çš„æ¶ˆæ¯æ²¡æœ‰åˆ°æ‰§è¡Œçš„æ—¶é—´ï¼Œè·å–ä¸€ä¸ªæ‰§è¡Œæ—¶é—´å·®
                        nextPollTimeoutMillis = (int) Math.min(msg.when - now, Integer.MAX_VALUE);
                    } else {
                        // Got a message.
                        mBlocked = false;
                        if (prevMsg != null) {
                            prevMsg.next = msg.next;
                        } else {
                            mMessages = msg.next;
                        }
                        msg.next = null;
                        if (DEBUG) Log.v(TAG, &quot;Returning message: &quot; + msg);
                        msg.markInUse();
                        return msg;
                    }
                } else {
                    //è¿™é‡Œå°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ²¡æœ‰æ¶ˆæ¯äº†
                    nextPollTimeoutMillis = -1;
                }

                // åªæœ‰è°ƒç”¨quiteä¹‹åmQuittingæ‰ä¸ºtrue
                if (mQuitting) {
                    dispose();
                    return null;
                }

                // If first time idle, then get the number of idlers to run.
                // Idle handles only run if the queue is empty or if the first message
                // in the queue (possibly a barrier) is due to be handled in the future.
                if (pendingIdleHandlerCount &lt; 0
                        &amp;&amp; (mMessages == null || now &lt; mMessages.when)) {
                    pendingIdleHandlerCount = mIdleHandlers.size();
                }
                //åœ¨è¿™é‡Œè·³åˆ°ä¸‹ä¸€ä¸ªå¾ªç¯ï¼Œlooperå°±å¼€å§‹ç­‰å¾…äº†
                if (pendingIdleHandlerCount &lt;= 0) {
                    // No idle handlers to run.  Loop and wait some more.
                    mBlocked = true;
                    continue;
                }

                if (mPendingIdleHandlers == null) {
                    mPendingIdleHandlers = new IdleHandler[Math.max(pendingIdleHandlerCount, 4)];
                }
                mPendingIdleHandlers = mIdleHandlers.toArray(mPendingIdleHandlers);
            }

            // Run the idle handlers.
            // We only ever reach this code block during the first iteration.
            for (int i = 0; i &lt; pendingIdleHandlerCount; i++) {
                final IdleHandler idler = mPendingIdleHandlers[i];
                mPendingIdleHandlers[i] = null; // release the reference to the handler

                boolean keep = false;
                try {
                    keep = idler.queueIdle();
                } catch (Throwable t) {
                    Log.wtf(TAG, &quot;IdleHandler threw exception&quot;, t);
                }

                if (!keep) {
                    synchronized (this) {
                        mIdleHandlers.remove(idler);
                    }
                }
            }

            // Reset the idle handler count to 0 so we do not run them again.
            pendingIdleHandlerCount = 0;

            // While calling an idle handler, a new message could have been delivered
            // so go back and look again for a pending message without waiting.
            nextPollTimeoutMillis = 0;
        }
    }
</code></pre>
<p>åˆ°è¿™é‡Œæˆ‘ä»¬ä¹Ÿå°±æ˜¯å¯ä»¥çŸ¥é“ä¸ºä»€ä¹ˆHandlerèƒ½å¤ŸæŠŠæˆ‘ä»¬åœ¨å­çº¿ç¨‹å‘çš„æ¶ˆæ¯è½¬æ¢åˆ°ä¸»çº¿ç¨‹æ¥äº†ï¼Œhandlerçº¿ç¨‹é—´é€šä¿¡æ˜¯é€šè¿‡å…±äº«å†…å­˜å®ç°çš„ï¼Œå†…å­˜æ˜¯ä¸åˆ†çº¿ç¨‹çš„ï¼Œä½†æ˜¯å‡½æ•°æ˜¯æœ‰çº¿ç¨‹åŒºåˆ†çš„ï¼Œå½“æˆ‘ä»¬åœ¨å­çº¿ç¨‹é€šè¿‡handler.sendMessage(msg)-ã€‹MessageQueue.equeueMessage(msg)è¿™ä¸ªå°±æ˜¯å­çº¿ç¨‹æ“ä½œå¹¶åœ¨MessageQueueç®¡ç†çš„å†…å­˜ç©ºé—´ä¸­å†™å…¥ä¸€ä¸ªå¯¹è±¡æ•°æ®<br>
è€Œåœ¨ä¸»çº¿ç¨‹ä¸­çš„Looperä¸æ–­çš„è½®è¯¢æ¶ˆæ¯é˜Ÿåˆ—çš„æ–¹æ³•loopæ˜¯æ‰§è¡Œåœ¨ä¸»çº¿ç¨‹çš„ï¼Œå®ƒä¸æ–­çš„åœ¨ä¸»çº¿ç¨‹ä¸­ä»MessageQueueä¸­æ‹¿æ¶ˆæ¯ï¼Œè¿™æ ·å°±å®Œæˆäº†çº¿ç¨‹åˆ‡æ¢ã€‚</p>
<h2 id="5é‚£ä¹ˆåœ¨looperæ˜¯å¦‚ä½•ä¿è¯åœ¨çº¿ç¨‹çš„å”¯ä¸€æ€§">5.é‚£ä¹ˆåœ¨Looperæ˜¯å¦‚ä½•ä¿è¯åœ¨çº¿ç¨‹çš„å”¯ä¸€æ€§ï¼Ÿ</h2>
<p>ThreadLocal å¯ä»¥è¿›è¡Œçº¿ç¨‹æ•°æ®éš”ç¦»ï¼Œæ¯ä¸ªçº¿ç¨‹éƒ½æœ‰å•ç‹¬çš„ä¸€ä¸ªå‰¯æœ¬<br>
æ¯ä¸ªçº¿ç¨‹éƒ½åªä¼šæœ‰ä¸€ä¸ªLooperï¼Œå®ƒå°±æ˜¯é€šè¿‡ThreadLocalæ¥è¿›è¡Œå®ç°çš„</p>
<p>Looperç›¸å…³çš„æºç ï¼š</p>
<pre><code class="language-java">public final class Looper {
    //ThreadLocalåªæœ‰æœ‰ä¸€ä¸ªï¼Œå¹¶ä¸”Looperçš„æ„é€ æ–¹æ³•ç§æœ‰åŒ–ï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡prepare()æ–¹æ³•æ¥è¿›è¡Œè°ƒç”¨
   static final ThreadLocal&lt;Looper&gt; sThreadLocal = new ThreadLocal&lt;Looper&gt;();
    /**
    å°†å½“å‰çº¿ç¨‹åˆå§‹åŒ–ä¸ºå¾ªç¯ç¨‹åºã€‚ è¿™ä½¿æ‚¨æœ‰æœºä¼šåˆ›å»ºå¤„ç†ç¨‹åºï¼Œç„¶ååœ¨å®é™…å¼€å§‹å¾ªç¯ä¹‹å‰å¼•ç”¨æ­¤å¾ªç¯ç¨‹åºã€‚ è°ƒç”¨æ­¤æ–¹æ³•åä¸€å®šè¦è°ƒç”¨loop() ï¼Œå¹¶é€šè¿‡è°ƒç”¨quit()ç»“æŸå®ƒã€‚
    */
    public static void prepare() {
        prepare(true);
    }

    private static void prepare(boolean quitAllowed) {
        //é¦–å…ˆæ£€æŸ¥å½“å‰æ˜¯å¦å·²ç»æœ‰Looperï¼Œæœ‰é‚£ä¹ˆå°±æŠ›å‡ºå¼‚å¸¸ï¼Œä»è€Œä¿è¯äº†ä¸€ä¸ªçº¿ç¨‹åªæœ‰ä¸€ä¸ªLooper
        if (sThreadLocal.get() != null) {
            throw new RuntimeException(&quot;Only one Looper may be created per thread&quot;);
        }
        sThreadLocal.set(new Looper(quitAllowed));
    }

 private Looper(boolean quitAllowed) {
        mQueue = new MessageQueue(quitAllowed);
        mThread = Thread.currentThread();
    }
}
</code></pre>
<p>ThreadLocal:</p>
<pre><code class="language-java">/**
å°†æ­¤çº¿ç¨‹å±€éƒ¨å˜é‡çš„å½“å‰çº¿ç¨‹å‰¯æœ¬è®¾ç½®ä¸ºæŒ‡å®šå€¼ã€‚ å¤§å¤šæ•°å­ç±»å°†ä¸éœ€è¦è¦†ç›–æ­¤æ–¹æ³•ï¼Œä»…ä¾èµ–äºinitialValueæ–¹æ³•æ¥è®¾ç½®çº¿ç¨‹initialValueçš„å€¼ã€‚
å‚æ•°ï¼š
value -- è¦å­˜å‚¨åœ¨æ­¤çº¿ç¨‹æœ¬åœ°çš„å½“å‰çº¿ç¨‹å‰¯æœ¬ä¸­çš„å€¼ã€‚
*/
    public void set(T value) {
        //è·å–å½“å‰çº¿ç¨‹
        Thread t = Thread.currentThread();
        //é€šè¿‡çº¿ç¨‹è·å–ThreadLocalMap
        ThreadLocalMap map = getMap(t);
        if (map != null)
            map.set(this, value);
        else
            createMap(t, value);
    }
</code></pre>
<h2 id="6åŒæ­¥å±éšœ">6.åŒæ­¥å±éšœ</h2>
<p>åœ¨Androidä¸­Handlerçš„åŒæ­¥å±éšœå®ç°æ–¹å¼ï¼Œæ˜¯åœ¨éœ€è¦çš„åœ°æ–¹å¾€æ¶ˆæ¯é˜Ÿåˆ—ä¸­æ’å…¥ä¸€æ¡targetä¸ºnullçš„Messageï¼Œæ ¹æ®å‰é¢çš„æºç åˆ†æå¯ä»¥çœ‹åˆ°æ­£å¸¸çš„æ¶ˆæ¯çš„targetå°±æ˜¯è¦å¤„ç†æ¶ˆæ¯çš„Handlerï¼Œåœ¨MessageQueueçš„nextæ–¹æ³•ä¸­ï¼Œä¼šåˆ¤æ–­å½“å‰æ¶ˆæ¯ã€‚<br>
åŒæ­¥å±éšœæ¶ˆæ¯çš„è§¦å‘ï¼š</p>
<pre><code class="language-java">/**
å‘å¾ªç¯ç¨‹åºçš„æ¶ˆæ¯é˜Ÿåˆ—å‘é€ä¸€ä¸ªåŒæ­¥éšœç¢ã€‚åœ¨æ¶ˆæ¯é˜Ÿåˆ—é‡åˆ°å·²å‘å¸ƒçš„åŒæ­¥éšœç¢ä¹‹å‰ï¼Œæ¶ˆæ¯å¤„ç†ç…§å¸¸è¿›è¡Œã€‚
å½“é‡åˆ°barrieræ—¶ï¼Œé˜Ÿåˆ—ä¸­ç¨åçš„åŒæ­¥æ¶ˆæ¯å°†è¢«æš‚åœ(é˜»æ­¢æ‰§è¡Œ)ï¼Œç›´åˆ°barrieré€šè¿‡è°ƒç”¨removeSyncBarrierå¹¶æŒ‡å®šæ ‡è¯†åŒæ­¥barrierçš„ä»¤ç‰Œè¢«é‡Šæ”¾ã€‚
æ­¤æ–¹æ³•ç”¨äºç«‹å³æ¨è¿Ÿæ‰€æœ‰éšåå‘å¸ƒçš„åŒæ­¥æ¶ˆæ¯çš„æ‰§è¡Œï¼Œç›´åˆ°æ»¡è¶³é‡Šæ”¾barrierçš„æ¡ä»¶ã€‚
å¼‚æ­¥æ¶ˆæ¯(è¯·å‚è§æ¶ˆæ¯ã€‚isAsynchronousä¸å—æ­¤éšœç¢çš„é™åˆ¶ï¼Œå¹¶ç…§å¸¸è¿›è¡Œå¤„ç†ã€‚
è¯¥è°ƒç”¨å¿…é¡»å§‹ç»ˆä¸removeSyncBarrierè°ƒç”¨åŒ¹é…ï¼Œä»¥ç¡®ä¿æ¶ˆæ¯é˜Ÿåˆ—æ¢å¤æ­£å¸¸æ“ä½œã€‚
å¦åˆ™ï¼Œåº”ç”¨ç¨‹åºå¯èƒ½ä¼šæŒ‚èµ·! 
*/
 public int postSyncBarrier() {
        return postSyncBarrier(SystemClock.uptimeMillis());
    }

    private int postSyncBarrier(long when) {
        // åŠ å…¥ä¸€ä¸ªæ–°çš„åŒæ­¥éšœç¢ä»¤ç‰Œã€‚
        //æˆ‘ä»¬ä¸éœ€è¦å”¤é†’é˜Ÿåˆ—ï¼Œå› ä¸ºå±éšœçš„ç›®çš„æ˜¯è®©å®ƒåœæ»ã€‚
        synchronized (this) {
            final int token = mNextBarrierToken++;
            //åˆ›å»ºä¸€ä¸ªtargetä¸ºnullçš„Message
            final Message msg = Message.obtain();
            msg.markInUse();
            msg.when = when;
            msg.arg1 = token;

            Message prev = null;
            Message p = mMessages;
            if (when != 0) {
                while (p != null &amp;&amp; p.when &lt;= when) {
                    prev = p;
                    p = p.next;
                }
            }
            if (prev != null) { // invariant: p == prev.next
                msg.next = p;
                prev.next = msg;
            } else {
                msg.next = p;
                mMessages = msg;
            }
            return token;
        }
    }
</code></pre>
<p>åŒæ­¥å±éšœé‡Šæ”¾ï¼š</p>
<pre><code class="language-java"> public void removeSyncBarrier(int token) {
        //ä»é˜Ÿåˆ—ä¸­åˆ é™¤åŒæ­¥éšœç¢ä»¤ç‰Œã€‚
        //å¦‚æœé˜Ÿåˆ—ä¸å†è¢«éšœç¢ç‰©é˜»ç¢ï¼Œé‚£ä¹ˆå”¤é†’å®ƒã€‚
        synchronized (this) {
            Message prev = null;
            Message p = mMessages;
            while (p != null &amp;&amp; (p.target != null || p.arg1 != token)) {
                prev = p;
                p = p.next;
            }
            if (p == null) {
                throw new IllegalStateException(&quot;The specified message queue synchronization &quot;
                        + &quot; barrier token has not been posted or has already been removed.&quot;);
            }
            final boolean needWake;
            if (prev != null) {
                prev.next = p.next;
                needWake = false;
            } else {
                mMessages = p.next;
                needWake = mMessages == null || mMessages.target != null;
            }
            p.recycleUnchecked();

            //å¦‚æœå¾ªç¯é€€å‡ºï¼Œé‚£ä¹ˆå®ƒå·²ç»é†’äº†ã€‚
            //å½“mquitä¸ºfalseæ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å‡è®¾mPtr != 0ã€‚
            if (needWake &amp;&amp; !mQuitting) {
                nativeWake(mPtr);
            }
        }
    }
</code></pre>
<p>åŒæ­¥å±éšœåœ¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­çš„å¤„ç†ï¼Œå½“è·å–åˆ°åŒæ­¥å±éšœæ¶ˆæ¯åè¿™ä¸ªæ¶ˆæ¯ä¼šä¸€ç›´åœ¨ï¼Œå½“ä¸‹æ¬¡å¾ªç¯çš„æ—¶å€™ï¼Œæˆ‘ä»¬è·å¾—è¿˜æ˜¯åŒæ­¥å±éšœçš„æ¶ˆæ¯ï¼Œç„¶åç»§ç»­æŸ¥æ‰¾å¼‚æ­¥çš„æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œç›´åˆ°è°ƒç”¨ç§»é™¤åŒæ­¥å±éšœæ¶ˆæ¯ï¼š</p>
<pre><code class="language-java">//è¢«éšœç¢é˜»ç¢äº†ã€‚åœ¨é˜Ÿåˆ—ä¸­æŸ¥æ‰¾ä¸‹ä¸€ä¸ªå¼‚æ­¥æ¶ˆæ¯ã€‚
 if (msg != null &amp;&amp; msg.target == null) {
                    // Stalled by a barrier.  Find the next asynchronous message in the queue.
                    do {
                        prevMsg = msg;
                        msg = msg.next;
                    } while (msg != null &amp;&amp; !msg.isAsynchronous());
                }
</code></pre>
<p>åº”ç”¨åœºæ™¯ï¼Œæœ€å¸¸è§çš„å°±æ˜¯å±å¹•åˆ·æ–°ï¼Œå±å¹•åˆ·æ–°å¿…ç„¶æ˜¯è¦å®æ—¶å“åº”çš„ï¼Œé˜Ÿåˆ—ä¸­è¿™æ—¶å€™å…¶ä»–æ¶ˆæ¯éƒ½è¦å…ˆè¢«åŒæ­¥å±éšœæŒ¡æ‰ï¼Œå¤„ç†ç•Œé¢åˆ·æ–°çš„å¼‚æ­¥æ¶ˆæ¯ã€‚<br>
åœ¨ViewRootImplä¸­çš„scheduleTraversals()</p>
<pre><code class="language-java">    void scheduleTraversals() {
        if (!mTraversalScheduled) {
            mTraversalScheduled = true;
            //å…ˆå‘é€äº†åŒæ­¥å±éšœæ¶ˆæ¯
            mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();
            //è§†å›¾
            mChoreographer.postCallback(
                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, null);
            if (!mUnbufferedInputDispatch) {
                scheduleConsumeBatchedInput();
            }
            notifyRendererOfFramePending();
            pokeDrawLockIfNeeded();
        }
    }

   void doTraversal() {
        if (mTraversalScheduled) {
            mTraversalScheduled = false;
            //ç§»é™¤åŒæ­¥å±éšœ
            mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);

            if (mProfile) {
                Debug.startMethodTracing(&quot;ViewAncestor&quot;);
            }
            //å¾ªç¯åŒ…æ‹¬performMeasure,performLayout,performDraw
            performTraversals();

            if (mProfile) {
                Debug.stopMethodTracing();
                mProfile = false;
            }
        }
    }
</code></pre>
<h2 id="7é¢è¯•é—®é¢˜å›ç­”">7.é¢è¯•é—®é¢˜å›ç­”</h2>
<ul>
<li>1.ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªHandlerï¼Ÿ<br>
ä»»æ„ä¸ªï¼Œhandleræ˜¯newå‡ºæ¥çš„</li>
<li>2.ä¸€ä¸ªçº¿ç¨‹æœ‰å‡ ä¸ªlooperï¼Œå¦‚ä½•ä¿è¯çš„ï¼Ÿ<br>
åªæœ‰ä¸€ä¸ªï¼Œä¿éšœæœºåˆ¶Looperçš„æ„å»ºå’ŒThreadLocalä¸€èµ·</li>
<li>3.Handlerå†…å­˜æ³„æ¼åŸå› ï¼Ÿä¸ºä»€ä¹ˆå…¶ä»–çš„å†…éƒ¨ç±»æ²¡æœ‰è¯´è¿‡è¿™ä¸ªé—®é¢˜ï¼Ÿ<br>
å†…å­˜æ³„æ¼å‘é€ä¸»è¦å°±æ˜¯å› ä¸ºç”Ÿå‘½å‘¨æœŸä¸ä¸€è‡´çš„é—®é¢˜ï¼ŒHandlerä¸­å®¹æ˜“æŒæœ‰å¤–éƒ¨ç±»çš„å¼•ç”¨ï¼Œå¹¶ä¸”Messageåˆä¼šæŒæœ‰Handlerï¼Œå½“Messageæ²¡æœ‰å›æ”¶æ—¶ï¼Œæ ¹æ®å¯è¾¾æ€§åˆ†æï¼Œè¿™ä¸€ç³»åˆ—çš„å¯¹è±¡éƒ½æ— æ³•è¢«å›æ”¶ï¼Œä¹Ÿå°±å‘ç”Ÿå†…å­˜æ³„æ¼äº†ã€‚</li>
<li>4.ä¸ºä½•ä¸»çº¿ç¨‹å¯ä»¥new Handlerï¼Ÿå¦‚æœæƒ³è¦åœ¨å­çº¿ç¨‹ä¸­new handlerè¦åšä»€ä¹ˆå‡†å¤‡<br>
åœ¨ä¸»çº¿ç¨‹ä¸­ä¸€åˆ›å»ºå°±æ„å»ºå¥½äº†Looperäº†ï¼Œä½†æ˜¯å­çº¿ç¨‹ä¸­æ²¡æœ‰ï¼Œæ‰€æœ‰éœ€è¦è°ƒç”¨Looper.prepare()æ„å»ºLooperï¼Œè°ƒç”¨Looper.loop()å¯åŠ¨Looper</li>
<li>5.å­çº¿ç¨‹ä¸­ç»´æŠ¤çš„Looperï¼Œæ¶ˆæ¯é˜Ÿåˆ—æ— æ¶ˆæ¯çš„æ—¶å€™å¤„ç†æ–¹æ¡ˆæ˜¯ä»€ä¹ˆï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ<br>
éœ€è¦è°ƒç”¨quit()æ–¹æ³•æ¥é€€å‡ºMessageQueueçš„å¾ªç¯ï¼Œè¿”å›ä¸€ä¸ªä¸ºnullçš„Message</li>
<li>6.æ—¢ç„¶å¯ä»¥å­˜åœ¨å¤šä¸ªHandlerå¾€MessageQueueä¸­æ·»åŠ æ•°æ®ï¼ˆå‘æ¶ˆæ¯æ—¶å„ä¸ªHandlerå¯èƒ½å¤„äºä¸åŒçº¿ç¨‹ï¼‰ï¼Œé‚£å®ƒå†…éƒ¨æ˜¯å¦‚ä½•ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Ÿ<br>
é€šè¿‡synchronizedå…³é”®å­—åŒ…è£¹ä»£ç å—å®ç°ï¼Œä¸€ä¸ªçº¿ç¨‹ä¸­åªä¼šæœ‰ä¸€ä¸ªMessageQueueï¼Œæ‰€ä»¥åœ¨é€šè¿‡synchronizedï¼ˆthisï¼‰åŠ é”çš„ä»£ç ï¼ˆåŠ å…¥é˜Ÿåˆ—ï¼Œå–å‡ºï¼Œé€€å‡ºï¼‰çš„æ“ä½œï¼ŒåŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹å¯ä»¥æ‰§è¡Œã€‚</li>
<li>7.æˆ‘ä»¬ä½¿ç”¨Messageæ—¶åº”è¯¥å¦‚ä½•åˆ›å»ºå®ƒï¼Ÿ<br>
Message.obtain(),è¿™æ˜¯ä»æ¶ˆæ¯çš„å…¨é‡æ± ä¸­è¿”å›ä¸€ä¸ªæ–°çš„Messageå¯¹è±¡ï¼Œé¿å…åˆ†é…æ–°å¯¹è±¡</li>
<li>8.Looperæ­»å¾ªç¯ä¸ºä»€ä¹ˆä¸ä¼šå¯¼è‡´åº”ç”¨å¡æ­»ï¼Ÿ<br>
å…¶å®è¿™æ˜¯ä¸¤ä¸ªæ¦‚å¿µçš„æ¶ˆæ¯ï¼Œæ•´ä¸ªåº”ç”¨çš„å¤„ç†å°±æ˜¯å»ºç«‹åœ¨Handleræœºåˆ¶ä¸Šçš„ï¼Œæ‰€æœ‰çš„äº‹ä»¶ï¼ˆç‚¹å‡»ï¼Œé¡µé¢åˆ·æ–°ç­‰ï¼‰éƒ½æ˜¯é€šè¿‡æ¶ˆæ¯æœºåˆ¶å®Œæˆçš„ã€‚</li>
<li>9.MessageQueueé˜Ÿåˆ—å¤„ç†æœºåˆ¶ï¼Œåœ¨fragmentç”Ÿå‘½å‘¨æœŸç®¡ç†ä¸­çš„åº”ç”¨<br>
è¿™ä¸ªæ˜¯è¦åœ¨äº‹ä»¶åœºæ™¯å»å»çœ‹ï¼Œä¾‹å¦‚Glideçš„ä¾èµ–Fragmentæ¥æä¾›å¯¹åº”ç”Ÿå‘½å‘¨æœŸçš„,åœ¨Glideä¸­ä¼šæä¾›ä¸€ä¸ªSupportRequestMananagerFragmentï¼Œä¸€ä¸ªæ— è§†å›¾çš„Fragmentç”¨æ¥å®‰å…¨å­˜å‚¨RequestManagerï¼Œå¯ä»¥ç”¨æ¥å¯åŠ¨ã€åœæ­¢å’Œç®¡ç†é’ˆå¯¹Fragmentæˆ–activityçš„ç›®æ ‡å‘èµ·çš„Glideè¯·æ±‚ã€‚</li>
</ul>
<pre><code class="language-java">  final Map&lt;FragmentManager, SupportRequestManagerFragment&gt; pendingSupportRequestManagerFragments =
      new HashMap&lt;&gt;();

  @NonNull
  private SupportRequestManagerFragment getSupportRequestManagerFragment(
      @NonNull final FragmentManager fm, @Nullable Fragment parentHint, boolean isParentVisible) {
          //å…ˆé€šè¿‡FragmentManageræŸ¥æ‰¾å¯¹åº”tagçš„SupportRequestManagerFragment
    SupportRequestManagerFragment current =
        (SupportRequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);
    if (current == null) {
        //åœ¨mapä¸­å»æŸ¥æ‰¾å¯¹åº”çš„SupportRequestManagerFragment
      current = pendingSupportRequestManagerFragments.get(fm);
      if (current == null) {
          //éƒ½ä¸ºè¯´æ˜æ²¡æœ‰åˆ›å»ºè¿‡
        current = new SupportRequestManagerFragment();
        current.setParentFragmentHint(parentHint);
        if (isParentVisible) {
          current.getGlideLifecycle().onStart();
        }
        //å­˜å…¥mapä¸­
        pendingSupportRequestManagerFragments.put(fm, current);
        //å¯åŠ¨äº‹ç‰©åˆ›å»ºFragmentï¼Œå†…éƒ¨é€šè¿‡handlerå‘é€æ¶ˆæ¯
        fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();
        //å‘é€æ¶ˆæ¯ï¼Œè¿™é‡Œçš„Handleråˆ›å»ºçš„æ˜¯ä¸»çº¿ç¨‹çš„Handlerï¼Œå’Œäº‹ç‰©å½“ä¸­çš„åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ï¼Œé‚£ä¹ˆ
        //å®ƒä»¬çš„æ¶ˆæ¯é˜Ÿåˆ—æ˜¯åŒä¸€ä¸ªï¼Œä¹Ÿå°±æ˜¯å½“è¿™ä¸ªæ¶ˆæ¯æ‰§è¡Œçš„æ—¶å€™ï¼Œé‚£ä¹ˆFragmentå¿…ç„¶å·²ç»è¢«åˆ›å»ºå®Œæˆäº†ï¼Œ
        //é‚£ä¹ˆæ¸…é™¤Mapä¸­çš„å°±æ²¡æœ‰é—®é¢˜äº†ï¼Œé¿å…äº†é‡å¤åˆ›å»ºçš„é—®é¢˜ã€‚
        handler.obtainMessage(ID_REMOVE_SUPPORT_FRAGMENT_MANAGER, fm).sendToTarget();
      }
    }
    return current;
  }

    /**
    RequestManagerRetrieverä¸­çš„handleMessage
    */
  @Override
  public boolean handleMessage(Message message) {
    boolean handled = true;
    Object removed = null;
    Object key = null;
    switch (message.what) {
      case ID_REMOVE_FRAGMENT_MANAGER:
        android.app.FragmentManager fm = (android.app.FragmentManager) message.obj;
        key = fm;
        removed = pendingRequestManagerFragments.remove(fm);
        break;
      case ID_REMOVE_SUPPORT_FRAGMENT_MANAGER:
        FragmentManager supportFm = (FragmentManager) message.obj;
        key = supportFm;
        //ç§»é™¤å¯¹åº”çš„Fragment
        removed = pendingSupportRequestManagerFragments.remove(supportFm);
        break;
      default:
        handled = false;
        break;
    }
    if (handled &amp;&amp; removed == null &amp;&amp; Log.isLoggable(TAG, Log.WARN)) {
      Log.w(TAG, &quot;Failed to remove expected request manager fragment, manager: &quot; + key);
    }
    return handled;
  }

</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Hiltçš„ä½¿ç”¨]]></title>
        <id>https://arms-merchants.github.io/post/hilt-de-shi-yong/</id>
        <link href="https://arms-merchants.github.io/post/hilt-de-shi-yong/">
        </link>
        <updated>2021-12-31T02:11:17.000Z</updated>
        <content type="html"><![CDATA[<h2 id="1ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥">1.ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥</h2>
<p>åœ¨ä½¿ç”¨Hiltä¹‹å‰æˆ‘ä»¬è¦å…ˆæ˜ç™½ä»€ä¹ˆæ˜¯ä¾èµ–æ³¨å…¥ï¼Ÿ<br>
ä¾èµ–æ³¨å…¥ï¼Œåœ¨è¯´ä¹‹å‰è§‰å¾—æ˜¯å¾ˆé«˜å¤§ä¸Šçš„ä¸œè¥¿ï¼Œå…¶å®åœ¨å¼€å‘ä¸­éƒ½ä¼šä½¿ç”¨åˆ°åªæ˜¯æœ‰å¯èƒ½ä½ åªæ˜¯æ²¡æœ‰æ˜ç™½å…¶å«ä¹‰è€Œå·²ã€‚</p>
<pre><code class="language-java">A a = new A();
</code></pre>
<p>å¯¹è±¡åˆ›å»ºï¼Œè¿™æ˜¯æˆ‘ä»¬å¼€å‘ä¸­æœ€å¸¸å‡ºç°çš„ä¸œè¥¿ï¼Œå…¶å®è¿™å°±æ˜¯ä¾èµ–æ³¨å…¥ï¼Œä¸è¿‡è¿™ä¸ªæ˜¯æˆ‘ä»¬è‡ªå·±æ‰‹åŠ¨å»è¿›è¡Œä¾èµ–æ³¨å…¥çš„ï¼Œåˆ›å»ºaè¿™å¯¹è±¡å®ƒæ˜¯è¦ä¾èµ–ä¸Açš„è¿™ä¸ªclassçš„ã€‚<br>
è€ŒHiltå°±æ˜¯å°†è¿™ä¸ªè¿‡ç¨‹è¿›è¡Œè‡ªåŠ¨åŒ–äº†ï¼ŒHiltæ˜¯Draggr2çš„ä¸€ä¸ªä¸“é—¨ä¸ºAndroidè¿›è¡Œåœºæ™¯è¯å®šåˆ¶çš„å¼€æºæ¡†æ¶ã€‚</p>
<h2 id="2hilté…ç½®">2.Hilté…ç½®</h2>
<p>é¡¹ç›®æ ¹ç›®æ ‡çš„build.gradle.kts,è¿™é‡Œæ˜¯åœ¨ktsé‡Œçš„å†™æ³•ï¼Œæ™®é€šçš„gradleæ”¹å†™ä¸‹æ ¼å¼å°±okã€‚</p>
<pre><code class="language-java">classpath(&quot;com.google.dagger:hilt-android-gradle-plugin:2.40&quot;)
</code></pre>
<p>Appçš„gradleé…ç½®</p>
<pre><code class="language-java">plugins {
    id(&quot;com.android.application&quot;)
    kotlin(&quot;android&quot;)
    id(&quot;kotlin-kapt&quot;)
    id(&quot;dagger.hilt.android.plugin&quot;)
}
android{
     //hiltçš„æ˜¯ä½¿ç”¨æ˜¯è¦æ±‚Java8çš„
        compileOptions {
        sourceCompatibility(JavaVersion.VERSION_1_8)
        targetCompatibility(JavaVersion.VERSION_1_8)
    }
}

dependencies {
     //hilt
    implementation(&quot;com.google.dagger:hilt-android:2.40&quot;)
    kapt(&quot;com.google.dagger:hilt-android-compiler:2.40&quot;)
    //åœ¨viewmodelä¸Šä½¿ç”¨hilt
    implementation (&quot;androidx.hilt:hilt-lifecycle-viewmodel:1.0.0-alpha03&quot;)
    kapt (&quot;androidx.hilt:hilt-compiler:1.0.0-beta01&quot;)
}
</code></pre>
<p>åœ¨Applicationä¸Šæ·»åŠ @HiltAndroidAppæ³¨è§£ï¼Œæ‰€æœ‰ä½¿ç”¨Hiltçš„åº”ç”¨å¿…é¡»è¦åŒ…å«ä¸€ä¸ªå¸¦æœ‰å½“å‰æ³¨è§£çš„Applicationï¼Œè¿™ä¸ªåœ°æ–¹ä¼šè§¦å‘Hiltçš„ä»£ç æ“ä½œï¼Œè€Œä¸”è¿™ä¸ªæ³¨è§£ä¼šç›¸åº”çš„ç”Ÿæˆä¸€ä¸ªåº”ç”¨çº§åˆ«çš„ä¾èµ–å®¹å™¨ã€‚</p>
<pre><code class="language-java">@HiltAndroidApp
class ExampleApplication : Application() { ... }
</code></pre>
<p>åˆ°ç°åœ¨æ•´ä¸ªçš„é…ç½®å·²ç»å®Œæˆäº†ï¼Œä¸‹é¢æˆ‘ä»¬æ¥çœ‹å®ƒçš„ä½¿ç”¨ã€‚</p>
<h2 id="3åŸºç¡€ä½¿ç”¨">3.åŸºç¡€ä½¿ç”¨</h2>
<p>æˆ‘ä»¬ä½¿ç”¨ä¾èµ–æ³¨å…¥ï¼Œè¯´ç™½äº†å°±æ˜¯è¦æä¾›ä¸€ä¸ªå¯¹è±¡ç»™å¤–éƒ¨ä½¿ç”¨ï¼Œè€Œå¤–éƒ¨ä¸éœ€è¦äº†è§£å…·ä½“çš„åˆ›å»ºè¿‡ç¨‹ï¼Œä½†æ˜¯æˆ‘ä»¬éœ€è¦æ˜ç¡®å‘ŠçŸ¥Hilté‚£äº›æ˜¯å¿…è¦çš„ä¾èµ–é¡¹ã€‚</p>
<pre><code class="language-java">/**
æ„é€ å‡½æ•°æ³¨å…¥å°±æ˜¯å…¶ä¸­çš„ä¸€ç§æ–¹æ³•
*/
class Car @Inject constructor() {
    val id:String = &quot;123123&quot;
    val name:String = &quot;1231232&quot;
}
/**
æ¨¡æ‹Ÿè°ƒç”¨
*/
@AndroidEntryPoint
class MainActivity :AppCompatActivity(){
    @Inject lateinit var car: Car
        override fun onCreate(savedInstanceState: Bundle?) {
            car.id
        }
}
</code></pre>
<p>ä¸Šé¢çš„ä¾‹å­å°±æ˜¯æœ€ç®€å•çš„ä½¿ç”¨Hiltçš„è¿‡ç¨‹ï¼Œç»™ç±»çš„æ„é€ æ·»åŠ @Injectæ³¨è§£ï¼Œåœ¨èƒ½å¤Ÿè¿›è¡Œä¾èµ–æ³¨å…¥çš„åœ°æ–¹ï¼Œæ·»åŠ @AndroidEntryPointæ³¨è§£ï¼Œä½¿ç”¨@Injectæ¥æ ‡ç¤ºæ³¨å…¥çš„å¯¹è±¡ã€‚<br>
Hiltæ”¯æŒçš„Androidç±»åŒ…æ‹¬ï¼š</p>
<ul>
<li>Application</li>
<li>Activity  ä»…æ”¯æŒComponentActivity</li>
<li>Fragment ä»…æ”¯æŒandroidx.Fragment</li>
<li>View</li>
<li>Service</li>
<li>BroadcastReceiver</li>
</ul>
<p>è€Œä¸”Hiltæ³¨å…¥çš„å­—æ®µä¸èƒ½ä¸ºç§æœ‰å­—æ®µï¼Œå¹¶ä¸”åœ¨æ„å»ºæ—¶ï¼ŒHiltä¼šä¸ºAndroidç±»ç”ŸæˆDaggerç»„ä»¶ã€‚ç„¶åDaggerä¼šè¿›è¡Œä»£ç æ£€æŸ¥ï¼Œå¹¶æ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š</p>
<ul>
<li>1.æ„å»ºå¹¶éªŒè¯ä¾èµ–å…³ç³»ï¼Œç¡®ä¿æ²¡æœ‰æœªæ»¡è¶³çš„ä¾èµ–ä¾èµ–å…³ç³»ä¸”æ²¡æœ‰ä¾èµ–å¾ªç¯ã€‚</li>
<li>2.ç”Ÿæˆå®ƒåœ¨è¿è¡Œæ—¶ç”¨æ¥åˆ›å»ºå®é™…å¯¹è±¡åŠå…¶ä¾èµ–é¡¹çš„ç±»ã€‚</li>
</ul>
<p>ä¿®æ”¹ä¸Šé¢çš„ä¾‹å­ï¼š</p>
<pre><code class="language-java">class Engine @inject constructor(){}
/**
æ„é€ å‡½æ•°æ³¨å…¥å°±æ˜¯å…¶ä¸­çš„ä¸€ç§æ–¹æ³•
*/
class Car @Inject constructor(val engine:Engine) {
    val id:String = &quot;123123&quot;
    val name:String = &quot;1231232&quot;
}
/**
æ¨¡æ‹Ÿè°ƒç”¨
*/
@AndroidEntryPoint
class MainActivity :AppCompatActivity(){
    @Inject lateinit var car: Car
        override fun onCreate(savedInstanceState: Bundle?) {
            car.id
        }
}
</code></pre>
<p>æˆ‘ä»¬åœ¨åˆ›å»ºCarçš„å¯¹è±¡æ—¶éœ€è¦ä¸€ä¸ªEngineå¯¹è±¡ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¿…è¦ä¹Ÿè¦æä¾›Engineçš„ä¾èµ–é¡¹ã€‚<br>
ä¸Šé¢çš„æƒ…å†µæ˜¯é’ˆå¯¹æœ‰æ„é€ å‡½æ•°çš„å¯¹è±¡çš„ï¼Œé‚£ä¹ˆå¦‚æœæ˜¯æ¥å£çš„è¯è¦æ€ä¹ˆå¤„ç†ï¼Ÿ</p>
<pre><code class="language-java">/**
æ¥å£æ˜¯æ²¡æœ‰æ„é€ å‡½æ•°çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å¸¦æœ‰@Bindsæ³¨é‡Šçš„æŠ½è±¡å‡½æ•°
*/
interface Engine{
    fun getEngineType():String
}
class ElectricEngine @Inject constructor() :Engine{
    over fun getEngineType() = &quot;ç”µæ°”å¼•æ“&quot;
}
/**
é€šè¿‡@Moduleæ ‡æ˜å½“å‰æ˜¯ä¸€ä¸ªå®ä¾‹å¯¹è±¡çš„æä¾›è€…
*/
@Module
/**
è¿™ä¸ªå®ƒçš„ä½œç”¨åŸŸï¼Œæ ‡ç¤ºå½“å‰çš„ä¾èµ–é¡¹å¯ä»¥åœ¨é¡¹ç›®ä¸­çš„æ‰€æœ‰çš„Activityä¸­ä½¿ç”¨ã€‚
*/
@InstallIn(ActivityComponent::class)
abstract class EngineModule{
    @Binds
    /**
    æ³¨æ„ElectricEngineå¿…é¡»èƒ½å¤Ÿæ‰¾åˆ°å¯¹åº”çš„ä¾èµ–é¡¹ï¼Œè¿™é‡Œæ˜¯åœ¨å®ƒçš„æ„é€ å‡½æ•°ä¸Šæ·»åŠ äº†@Inject
    */
    abstract fun providesEngineImp(electricEngine:ElectricEngine):Engine
}

class Car @Inject constructor(val engine:Engine) {
    val id:String = &quot;123123&quot;
    val name:String = &quot;1231232&quot;
}
/**
æ¨¡æ‹Ÿè°ƒç”¨
*/
@AndroidEntryPoint
class MainActivity :AppCompatActivity(){
    @Inject lateinit var car: Car
        override fun onCreate(savedInstanceState: Bundle?) {
            car.engine.getEngineType()
        }
}
</code></pre>
<p>ä½¿ç”¨è¿‡ç¨‹çœ‹ä»£ç å°±å¯ä»¥ï¼Œæ³¨æ„å‡ ä¸ªåœ°æ–¹ï¼š</p>
<ul>
<li>1.æä¾›çš„ä¾èµ–é¡¹çš„Moduleå¿…é¡»è¦æ˜¯abstractçš„</li>
<li>2.å¯¹åº”çš„å®ç°ç±»ä¹Ÿè¦æä¾›ä¾èµ–é¡¹</li>
</ul>
<p>æ¥å£å¯ä»¥æœ‰å¤šä¸ªå®ç°ï¼Œé‚£ä¹ˆè¿™ä¹ˆä¸ªæ—¶å€™è¦è¿™ä¹ˆå¤„ç†å‘¢ï¼Ÿ</p>
<pre><code class="language-java">/**
æ¥å£å¤šå®ç°çš„ä¾èµ–æ³¨å…¥
*/
interface Engine{
    fun getEngineType():String
}
class ElectricEngine @Inject constructor() :Engine{
    over fun getEngineType() = &quot;ç”µæ°”å¼•æ“&quot;
}

class OtherEngine @Inject constructor():Engine{
    over fun getEngineType() = &quot;å…¶ä»–å¼•æ“&quot;
}

class Car @Inject constructor(val engine:Engine) {
    val id:String = &quot;123123&quot;
    val name:String = &quot;1231232&quot;
}

//å®ç°ç”¨æ¥åŒºåˆ†ç±»åˆ«çš„é™å®šç¬¦
@Qualifier
@Retention(AnnotationRetention.BINARY)
annotation class ElectricTypeEngine

@Qualifier
@Retention(AnnotationRetention.BINARY)
annotation class OtherTypeEngine

@Module
@InstallIn(ActivityComponent::class)
object CarModule{
    /**
    ä½¿ç”¨é™å®šç¬¦æ¥æä¾›ä¸åŒå¼•æ“çš„è½¦
    */
    @ElectricTypeEngine
    @Provides
    /**
    è¿™é‡Œéœ€è¦ä½¿ç”¨@Providesï¼Œä¹‹å‰å°è¯•åœ¨@Bindsä¸ŠåŠ é™åˆ¶ç¬¦ç›´æ¥ç¼–è¯‘æŠ¥é”™ï¼Œåœ¨æœ€ç»ˆè·å–å®ä¾‹çš„åœ°æ–¹è¦æ±‚åŠ é™åˆ¶ç¬¦çš„éœ€è¦æä¾›@Provides
    */
    fun providesElectricTypeCar(electricEngine: ElectricEngine):Car{
        return Car(electricEngine)
    }

    @OtherTypeEngine
    @Provides
    fun providesOtherTypeCar(otherEngine: OtherEngine):Car{
        return Car(otherEngine)
    }
}

/**
æ¨¡æ‹Ÿè°ƒç”¨
*/
@AndroidEntryPoint
class MainActivity :AppCompatActivity(){
    @ElectricTypeEngine
    @Inject
    lateinit var elecTypeCar: Car

    @OtherTypeEngine
    @Inject
    lateinit var otherTypeCar: Car

     override fun onCreate(savedInstanceState: Bundle?) {
        elecTypeCar.engine.getEngineType()
        otherTypeCar.engine.getEngineType()
     }
}
</code></pre>
<p>é‚£ä¹ˆå¦‚æœæ˜¯ä¸‰æ–¹çš„ç±»å‘¢ï¼Ÿæ—¢ä¸èƒ½é€šè¿‡æ„é€ å‡½æ•°ä¹Ÿæ²¡æœ‰æ¥å£å®ç°çš„æ–¹å¼ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥ä½¿ç”¨ @Provides æ³¨å…¥å®ä¾‹ï¼Œå®ƒçš„ä½¿ç”¨åœºæ™¯ï¼ˆä¸‰æ–¹çš„åº“ï¼ŒRetrofitã€OkHttpClientã€Roomç­‰ï¼‰ï¼Œæˆ–è€…æ˜¯éœ€è¦ä½¿ç”¨æ„å»ºè€…æ¨¡å¼åˆ›å»ºå®ä¾‹ï¼Œè¿˜æœ‰ä¸Šé¢çš„åœºæ™¯æ ¹æ®é™åˆ¶ç¬¦æ¥è¿”å›æ¥å£çš„ä¸åŒå®ä¾‹å¯¹è±¡ã€‚</p>
<pre><code class="language-java">@Module
@InstallIn(ActivityComponent::class)
object HttpModule{
    @provides
    fun providesApiService():ApiService{
        returen Retrofit.Builder()
                    .baseUrl(&quot;&quot;)
                    .build()
                    .create(ApiService::class.java)
    }
}
</code></pre>
<h2 id="4ä¸€äº›æ³¨è§£çš„è§£é‡Š">4.ä¸€äº›æ³¨è§£çš„è§£é‡Š</h2>
<p>åœ¨ä¸€äº›æˆ‘ä»¬éœ€è¦Applcitionæˆ–è€…Activityçš„contextçš„å®è¯ï¼Œçœ‹çœ‹Hiltä¸ºæˆ‘ä»¬æä¾›äº†ä»€ä¹ˆ<br>
@ApplicationContext @ActivityContext</p>
<pre><code class="language-java">//å¸¸è§çš„ä¸€ä¸ªåœºæ™¯ï¼ŒAdapterä¸­éœ€è¦contextæ¥è¿›è¡Œåˆå§‹åŒ–ï¼Œ
//é‚£ä¹ˆè¿™é‡Œé€šè¿‡@ActivityContextæä¾›äº†Activityçš„ä¸Šä¸‹æ–‡
class MyAdapter @Inject constructor(@ActvityContext val context:Context){
}
</code></pre>
<p>åœ¨å‰é¢çš„@Moduleä¸­æˆ‘ä»¬ä½¿ç”¨äº†@InstallIn(ActivityComponent::class)æ¥ç¡®å®šå®ä¾‹æ³¨å…¥çš„èŒƒå›´ï¼ŒHiltç»„ä»¶å’Œæ³¨å…¥å¯¹è±¡çš„å¯¹åº”å…³ç³»</p>
<table>
<thead>
<tr>
<th style="text-align:center">Hiltç»„ä»¶</th>
<th style="text-align:center">æ³¨å…¥å™¨é¢å‘çš„å¯¹è±¡</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ActivityRetainedComponent</td>
<td style="text-align:center">ViewModel</td>
</tr>
<tr>
<td style="text-align:center">ActivityComponent</td>
<td style="text-align:center">Activity</td>
</tr>
<tr>
<td style="text-align:center">FragmentComponent</td>
<td style="text-align:center">Fragment</td>
</tr>
<tr>
<td style="text-align:center">ViewComponent</td>
<td style="text-align:center">View</td>
</tr>
<tr>
<td style="text-align:center">ViewWithFragmentComponent</td>
<td style="text-align:center">å¸¦æœ‰@WithFragmentBindingsæ³¨é‡Šçš„View</td>
</tr>
<tr>
<td style="text-align:center">ServiceComponent</td>
<td style="text-align:center">Service</td>
</tr>
</tbody>
</table>
<p>æœ‰äº†ç»„ä»¶å…³ç³»ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬åœ¨ç›¸åº”çš„ç»„ä»¶èŒƒå›´å†…è¦æ±‚è¿”å›åŒä¸€å®ä¾‹è¦æ€ä¹ˆåšï¼Ÿå¦‚æœä¸æ·»åŠ ä½œç”¨åŸŸçš„è¯ï¼Œæ¯æ¬¡æˆ‘ä»¬è·å–åˆ°çš„éƒ½æ˜¯ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œåœ¨æœ‰ä½œç”¨åŸŸçš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆåœ¨ç›¸åº”ä½œç”¨åŸŸè¿”å›çš„éƒ½æ˜¯åŒä¸€å®ä¾‹ã€‚</p>
<table>
<thead>
<tr>
<th style="text-align:center">Androidç±»</th>
<th style="text-align:center">ç”Ÿæˆç»„ä»¶</th>
<th style="text-align:center">ä½œç”¨åŸŸ</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Application</td>
<td style="text-align:center">ApplicationComponent(è¿™ä¸ªåœ¨æ–°ç‰ˆæœ¬ä¸­æ²¡æœ‰äº†)</td>
<td style="text-align:center">@Singleton</td>
</tr>
<tr>
<td style="text-align:center">ViewModel</td>
<td style="text-align:center">ActivityRetainedComponent</td>
<td style="text-align:center">@ActivityRetainedScope</td>
</tr>
<tr>
<td style="text-align:center">Activity</td>
<td style="text-align:center">ActivityComponent</td>
<td style="text-align:center">@ActivityScoped</td>
</tr>
<tr>
<td style="text-align:center">Fragment</td>
<td style="text-align:center">FragmentComponent</td>
<td style="text-align:center">@FragmentScoped</td>
</tr>
<tr>
<td style="text-align:center">View</td>
<td style="text-align:center">ViewComponent</td>
<td style="text-align:center">@ViewScoped</td>
</tr>
<tr>
<td style="text-align:center">å¸¦æœ‰@WithFragmentBindingsçš„View</td>
<td style="text-align:center">ViewWithFragmentComponent</td>
<td style="text-align:center">@ViewScope</td>
</tr>
<tr>
<td style="text-align:center">Service</td>
<td style="text-align:center">ServiceComponent</td>
<td style="text-align:center">@ServiceScoped</td>
</tr>
</tbody>
</table>
<p>ç»„ä»¶å±‚æ¬¡ç»“æ„ï¼Œå°†æ¨¡å—å®‰è£…åˆ°ç»„ä»¶åï¼Œå…¶ç»‘å®šå°±å¯ä»¥ç”¨ä½œè¯¥ç»„ä»¶ä¸­å…¶ä»–ç»‘å®šçš„ä¾èµ–é¡¹ï¼Œä¹Ÿå¯ä»¥ç”¨ä½œç»„ä»¶å±‚çº§ç»“æ„ä¸­è¯¥ç»„ä»¶ä¸‹çš„ä»»ä½•å­ç»„ä»¶ä¸­å…¶ä»–ç»‘å®šçš„ä¾èµ–é¡¹ï¼š<br>
<img src="file:///Users/heyueyang/Desktop/hilt-hierarchy.svg" alt="" loading="lazy"></p>
<p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ‚¨åœ¨è§†å›¾ä¸­æ‰§è¡Œå­—æ®µæ³¨å…¥ï¼ŒViewComponent å¯ä»¥ä½¿ç”¨ ActivityComponent ä¸­å®šä¹‰çš„ç»‘å®šã€‚å¦‚æœæ‚¨è¿˜éœ€è¦ä½¿ç”¨ FragmentComponent ä¸­å®šä¹‰çš„ç»‘å®šå¹¶ä¸”è§†å›¾æ˜¯ Fragment çš„ä¸€éƒ¨åˆ†ï¼Œåº”å°† @WithFragmentBindings æ³¨é‡Šå’Œ @AndroidEntryPoint ä¸€èµ·ä½¿ç”¨ã€‚</p>
<p>è€Œå¦‚æœæƒ³è¦åœ¨éç›´æ¥æ”¯æŒçš„åœ°æ–¹ä½¿ç”¨ä¾èµ–æ³¨å…¥</p>
<pre><code class="language-java">class TestEntryPoint {
    /**
    åˆ›å»ºä¸€ä¸ªæ³¨å…¥çš„ç‚¹ï¼Œä»¥åŠç›¸åº”çš„å®¹å™¨
    */
    @EntryPoint
    @InstallIn(FragmentComponent::class)
    interface CarProviderEntryPoint{
        /**
        è¿™é‡Œæ˜¯å› ä¸ºCaræ˜¯æœ‰ä¸¤ç§å¼•æ“ç»„ä»¶çš„å®ç°ï¼Œæˆ‘ä»¬éœ€è¦å‘ŠçŸ¥å®ƒè¦é‚£ä¸€ç§ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªå®ä¾‹çš„æƒ…å†µä¸‹ä¸éœ€è¦
        */
        @OtherTypeEngine
        fun providerCar():Car
    }

/**
ä½¿ç”¨æ¥è‡ª EntryPointAccessors çš„é€‚å½“é™æ€æ–¹æ³•ã€‚å‚æ•°åº”è¯¥æ˜¯ç»„ä»¶å®ä¾‹æˆ–å……å½“ç»„ä»¶æŒæœ‰è€…çš„ @AndroidEntryPoint å¯¹è±¡ã€‚ç¡®ä¿æ‚¨ä»¥å‚æ•°å½¢å¼ä¼ é€’çš„ç»„ä»¶å’Œ EntryPointAccessors é™æ€æ–¹æ³•éƒ½ä¸ @EntryPoint æ¥å£ä¸Šçš„ @InstallIn æ³¨é‡Šä¸­çš„ Android ç±»åŒ¹é…
*/
    fun getCar(fragment:Fragment):Car{
      val carProviderPoint =   EntryPointAccessors.fromFragment(fragment,CarProviderEntryPoint::class.java)
        return carProviderPoint.providerCar()
    }
}
</code></pre>
<h2 id="5hiltåœ¨viewmodelä¸Šçš„ä½¿ç”¨">5.Hiltåœ¨ViewModelä¸Šçš„ä½¿ç”¨</h2>
<p>é¦–å…ˆæ˜¯ä¾èµ–ï¼š</p>
<pre><code class="language-java">dependencies {
  implementation 'androidx.hilt:hilt-lifecycle-viewmodel:1.0.0-alpha01'
  // When using Kotlin.
  kapt 'androidx.hilt:hilt-compiler:1.0.0-alpha01'
  // When using Java.
  annotationProcessor 'androidx.hilt:hilt-compiler:1.0.0-alpha01'
}
</code></pre>
<p>ç„¶ååœ¨ViewModelä¸Šæ·»åŠ æ³¨è§£,å¹¶æ·»åŠ å¸¦æœ‰@Injectçš„æ„é€ æ–¹æ³•ã€‚</p>
<pre><code class="language-java">@HiltViewModel
class ExViewModel @Inject constructor():ViewModel() {

}
</code></pre>
<p>ç„¶åï¼Œå¸¦æœ‰ @AndroidEntryPoint æ³¨é‡Šçš„ Activity æˆ– Fragment å¯ä»¥ä½¿ç”¨ ViewModelProvider æˆ– by viewModels() KTX æ‰©å±•ç…§å¸¸è·å– ViewModel å®ä¾‹ï¼š</p>
<pre><code class="language-java">@AndroidEntryPoint
class ExampleActivity : AppCompatActivity() {
  private val viewModel: ExViewModel by viewModels()
}
</code></pre>
<p>ä½†æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦åˆ›å»ºå¸¦æœ‰å‚æ•°çš„ViewModel,ä¾‹å¦‚æ ¹æ®ä¸åŒçš„ç±»å‹è·å–ä¸åŒçš„æ•°æ®é›†</p>
<pre><code class="language-java">/**
ç›¸åº”çš„å±æ€§éœ€è¦æ·»åŠ @Assistedï¼Œå¹¶ä¸”æ„é€ æ–¹æ³•æ·»åŠ @AssistedInject
*/
class TestViewModel @AssistedInject constructor(@Assisted val pokeName:String):ViewModel() {

    /**
    æä¾›ä¸€ä¸ªè¾…åŠ©å·¥å‚
    */
    @dagger.assisted.AssistedFactory
    interface AssistedFactory{
        fun create(name:String):TestViewModel
    }
    /**
    å¯¹å¤–æä¾›æ„å»ºçš„å·¥å‚
    */
    companion object{
        fun provideFactory(
            factory: AssistedFactory,
            name:String
        ):ViewModelProvider.Factory = object :ViewModelProvider.Factory{
            override fun &lt;T : ViewModel&gt; create(modelClass: Class&lt;T&gt;): T {
                return factory.create(name) as T
            }
        }
    }
}
/**
æ¨¡æ‹Ÿè°ƒç”¨
*/
@AndroidEntryPoint
class TestActivity:AppCompatActivity() {

    @Inject lateinit var factory:TestViewModel.AssistedFactory

    val viewModel:TestViewModel by viewModels {
        TestViewModel.provideFactory(factory,&quot;123123&quot;)
    }
}
</code></pre>
<p>å°±æ˜¯åœ¨æ„å»ºViewModelæ—¶éœ€è¦è‡ªå·±åˆ›å»ºæ„å»ºå·¥å‚ï¼Œæ¥å®ç°å‚æ•°çš„æ•°å€¼ï¼Œåœ¨ViewModelåˆ›å»ºæ—¶è®¾ç½®ä¸ºè‡ªå·±åˆ›å»ºçš„å·¥å‚ã€‚</p>
<h1 id="2021å†è§ä»Šå¹´çš„æœ€åä¸€ç¯‡æ–‡ç« äº†">2021å†è§ï¼Œä»Šå¹´çš„æœ€åä¸€ç¯‡æ–‡ç« äº†ã€‚</h1>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[æ‰‹åŠ¿æ§åˆ¶ä»¥åŠå¤šç‚¹è§¦æ§]]></title>
        <id>https://arms-merchants.github.io/post/shou-shi-kong-zhi-yi-ji-duo-dian-hong-kong/</id>
        <link href="https://arms-merchants.github.io/post/shou-shi-kong-zhi-yi-ji-duo-dian-hong-kong/">
        </link>
        <updated>2021-12-27T07:42:47.000Z</updated>
        <content type="html"><![CDATA[<h2 id="åœºæ™¯1å®ç°ä¸€ä¸ªç®€å•çš„photoviewç›¸å…³åŠŸèƒ½åŒ…æ‹¬åŒå‡»æ”¾å¤§æ”¾å¤§æ‹–åŠ¨åŒæŒ‡ç¼©æ”¾">åœºæ™¯1ï¼šå®ç°ä¸€ä¸ªç®€å•çš„PhotoViewï¼Œç›¸å…³åŠŸèƒ½åŒ…æ‹¬ï¼ŒåŒå‡»æ”¾å¤§ï¼Œæ”¾å¤§æ‹–åŠ¨ï¼ŒåŒæŒ‡ç¼©æ”¾</h2>
<h3 id="åŠŸèƒ½åˆ†æ">åŠŸèƒ½åˆ†æï¼š</h3>
<p>1.åŒå‡»æ”¾å¤§ï¼Œæ”¾å¤§æ‹–åŠ¨ï¼š<br>
å®˜æ–¹æä¾›äº†GestureDetectoræ¥è¿›è¡Œæ‰‹åŠ¿ç›¸å…³çš„å¤„ç†ï¼š</p>
<pre><code class="language-java">/**
è¿™é‡Œä½¿ç”¨SimpleOnGestureListenerï¼ŒSimpleOnGestureListenerå®ç°äº†OnDoubleTapListeneræ¥å£ï¼Œè¿™é‡Œå°±æœ‰æˆ‘ä»¬éœ€è¦ä½¿ç”¨çš„åŒå‡»å®ç°çš„å›æ‰
*/
val gestureDetector = GestureDetector(context, gestureDetectorListener)

 /**
     * æ‰‹åŠ¿å¤„ç†ç±»
     */
    val gestureDetectorListener = object : GestureDetector.SimpleOnGestureListener() {

        /**
         * ä¸€ä¸ªäº‹ä»¶çš„å¼€å§‹æ˜¯ä»downå¼€å§‹çš„ï¼Œå¦‚æœdownæ²¡æœ‰è·å–åˆ°
         * é‚£ä¹ˆåç»­çš„äº‹ä»¶ä¹Ÿä¸ä¼šå†æ¶ˆè´¹ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†å®ç°åŒå‡»çš„æ•ˆæœï¼Œéœ€è¦æ¶ˆè´¹äº‹ä»¶
         */
        override fun onDown(e: MotionEvent?): Boolean {
            return true
        }

        /**
         * æ˜¾ç¤ºæ°´æ³¢çº¹
         */
        override fun onShowPress(e: MotionEvent?) {
            super.onShowPress(e)
        }

        /**
         * å•å‡»äº‹ä»¶çš„ï¼Œupäº‹ä»¶æ—¶å›æ‰
         */
        override fun onSingleTapUp(e: MotionEvent?): Boolean {
            return super.onSingleTapUp(e)
        }

        /**
         * æ»‘åŠ¨æ˜¯è¿›è¡Œå›¾åƒç§»åŠ¨
         */
        override fun onScroll(
            e1: MotionEvent?,
            e2: MotionEvent?,
            distanceX: Float,
            distanceY: Float
        ): Boolean {
         return super.onScroll(e1, e2, distanceX, distanceY)
        }

        /**
         * é•¿æŒ‰
         */
        override fun onLongPress(e: MotionEvent?) {
            super.onLongPress(e)
        }

        /**
         * æƒ¯æ€§æ»‘åŠ¨ï¼Œåœ¨æƒ¯æ€§æ»‘åŠ¨çš„æƒ…å†µä¸‹å®ç°ä¸€ä¸ªå›å¼¹çš„æ•ˆæœ
         */
        override fun onFling(
            e1: MotionEvent?,
            e2: MotionEvent?,
            velocityX: Float,
            velocityY: Float
        ): Boolean {
            return super.onFling(e1, e2, velocityX, velocityY)
        }

        /**
         * ç‚¹å‡»åœ¨upä»¥åŠTagæ—¶ä¼šè§¦å‘å›æ‰
         */
        override fun onSingleTapConfirmed(e: MotionEvent?): Boolean {
            return super.onSingleTapConfirmed(e)
        }

        /**
         * åŒå‡»äº‹ä»¶çš„çš„Eventå›æ‰ï¼ŒåŒ…æ‹¬æœ‰downï¼Œmoveï¼Œup
         */
        override fun onDoubleTapEvent(e: MotionEvent?): Boolean {
            return super.onDoubleTapEvent(e)

        }

        override fun onContextClick(e: MotionEvent?): Boolean {
            return super.onContextClick(e)
        }

        /**
         * åŒå‡»äº‹ä»¶çš„ç¬¬äºŒæ¬¡downäº‹ä»¶ä¼šè¿›è¡Œå›æ‰
         */
        override fun onDoubleTap(e: MotionEvent): Boolean {
             return super.onDoubleTap(e)
        }
    }
</code></pre>
<p>æ ¹æ®ç›¸å…³çš„æ³¨é‡Šï¼Œæˆ‘ä»¬å¯ä»¥åœ¨onDoubleTapå¤„ç†åŒå‡»æ‰€å‘çš„å¤„ç†ï¼ŒonScrollæ¥è¿›è¡Œæ»‘åŠ¨çš„å¤„ç†å¹¶ä¸”å¯ä»¥åœ¨onFlingä¸­å¤„ç†æ»‘åŠ¨çš„æƒ¯æ€§å¤„ç†ï¼Œå…·ä½“çš„ä¸šåŠ¡å¤„ç†çœ‹ä¸‹é¢çš„å®Œæ•´ä»£ç ã€‚<br>
2.åŒæŒ‡ç¼©æ”¾ï¼š<br>
ç¼©æ”¾æ‰‹åŠ¿å¤„ç†ç±»ï¼šScaleGestureDetector</p>
<pre><code class="language-java">scaleGestureDetector = ScaleGestureDetector(context, PhotoScaleGestureListener())

 /**
     * æ‰‹åŠ¿å‘ç”Ÿæ—¶æ¥æ”¶é€šçŸ¥çš„ç›‘å¬å™¨ã€‚ å¦‚æœä½ æƒ³ç›‘å¬æ‰€æœ‰ä¸åŒçš„æ‰‹åŠ¿ï¼Œé‚£ä¹ˆå®ç°è¿™ä¸ªæ¥å£ã€‚ å¦‚æœæ‚¨åªæƒ³ä¾¦å¬å­é›†ï¼Œ
     * æ‰©å±•ScaleGestureDetector.SimpleOnScaleGestureListenerå¯èƒ½ä¼šæ›´å®¹æ˜“ã€‚ åº”ç”¨ç¨‹åºå°†æŒ‰ä»¥ä¸‹é¡ºåºæ¥æ”¶äº‹ä»¶ï¼š
    ä¸€ä¸ªonScaleBegin(ScaleGestureDetector)
    é›¶ä¸ªæˆ–å¤šä¸ªonScale(ScaleGestureDetector)
    ä¸€ä¸ªonScaleEnd(ScaleGestureDetector)
     */
    inner class PhotoScaleGestureListener : ScaleGestureDetector.OnScaleGestureListener {
        /**
         * å“åº”æ­£åœ¨è¿›è¡Œçš„æ‰‹åŠ¿çš„ç¼©æ”¾äº‹ä»¶ã€‚ é€šè¿‡æŒ‡é’ˆè¿åŠ¨æŠ¥å‘Š
         * @param
         * @return æ£€æµ‹å™¨æ˜¯å¦åº”å°†æ­¤äº‹ä»¶è§†ä¸ºå·²å¤„ç†ã€‚ å¦‚æœäº‹ä»¶æœªè¢«å¤„ç†ï¼Œæ¢æµ‹å™¨å°†ç»§ç»­ç´¯ç§¯è¿åŠ¨ï¼Œç›´åˆ°äº‹ä»¶è¢«å¤„ç†ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœåº”ç”¨ç¨‹åºåªæƒ³åœ¨æ›´æ”¹å¤§äº 0.01 æ—¶æ›´æ–°ç¼©æ”¾å› å­ï¼Œè¿™ä¼šå¾ˆæœ‰ç”¨ã€‚
         */
        override fun onScale(detector: ScaleGestureDetector): Boolean {
            return false
        }

        /**
         * @return æ£€æµ‹å™¨æ˜¯å¦åº”ç»§ç»­è¯†åˆ«æ­¤æ‰‹åŠ¿ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‰‹åŠ¿å¼€å§‹äºæœ‰æ„ä¹‰çš„åŒºåŸŸä¹‹å¤–çš„ç„¦ç‚¹ï¼Œåˆ™ onScaleBegin() å¯èƒ½ä¼šè¿”å› false ä»¥å¿½ç•¥æ‰‹åŠ¿çš„å…¶ä½™éƒ¨åˆ†
         */
        override fun onScaleBegin(detector: ScaleGestureDetector?): Boolean {
            return true
        }

        /**
         * æ‰‹åŠ¿ç¼©æ”¾ç»“æŸæ—¶ï¼Œå¤„ç†è¾¹ç•Œé—®é¢˜
         */
        override fun onScaleEnd(detector: ScaleGestureDetector?) {
        }
    }
</code></pre>
<p>å½“æˆ‘ä»¬æ„å»ºå¥½è¿™ä¸¤ä¸ªæ‰‹åŠ¿å¤„ç†ç±»åå°±å¯ä»¥å»æ¥ç®¡Viewçš„Touchäº‹ä»¶</p>
<pre><code class="language-java">  override fun onTouchEvent(event: MotionEvent?): Boolean {
      //é¦–å…ˆå…ˆå¤„ç†çš„æ˜¯åŒæŒ‡ç¼©æ”¾ï¼Œå› ä¸ºå¦‚æœå…ˆå¤„ç†åŒå‡»å’Œæ»‘åŠ¨çš„è¯ï¼ŒåŒæŒ‡å°±æ°¸è¿œæ²¡æœ‰æœºä¼šè§¦å‘äº†
        var result = scaleGestureDetector.onTouchEvent(event)
        if (!scaleGestureDetector.isInProgress) {
            result = gestureDetector.onTouchEvent(event)
        }
        return result
    }
</code></pre>
<h3 id="å®Œæ•´çš„ä»£ç ">å®Œæ•´çš„ä»£ç ï¼š</h3>
<p>æ•´ä¸ªæ„å»ºæ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹åŒ…æ‹¬ï¼šè‡ªå®šä¹‰viewï¼Œæ‰‹åŠ¿æ§åˆ¶ï¼Œå±æ€§åŠ¨ç”»ï¼Œ</p>
<pre><code class="language-java">package com.arms.flowview.photoView

import android.animation.ObjectAnimator
import android.content.Context
import android.graphics.Bitmap
import android.graphics.BitmapFactory
import android.graphics.Canvas
import android.graphics.Paint
import android.util.AttributeSet
import android.view.GestureDetector
import android.view.MotionEvent
import android.view.ScaleGestureDetector
import android.view.View
import android.widget.OverScroller
import com.arms.flowview.R
import com.arms.flowview.ext.logE
import com.arms.flowview.utils.ConverUtils
import com.arms.flowview.utils.ImageUtils

/**
 *    author : heyueyang
 *    time   : 2021/12/21
 *    desc   :è¿˜æœ‰ä¸¤åœ°éœ€è¦ä¼˜åŒ–ï¼Œå¤„ç†æœ€å¼€å§‹å›¾ç‰‡åŠ è½½çš„é—®ï¼Œæœ€å¼€å§‹å›¾ç‰‡åŠ è½½çš„å¤§å°ä¸å¯¹ï¼Œå›¾ç‰‡èµ„æºçš„è·å–ç°åœ¨æ˜¯ç›´æ¥æ„å»ºæ­»çš„æœ¬åœ°å›¾ç‰‡è·¯å¾„ï¼Œè¿™é‡Œå¦‚æœè¦æ”¯æŒurlçš„è¯è¦æ€ä¹ˆå¤„ç†
 *    version: 1.0
 */
class PhotoView : View {


    private lateinit var bitmap: Bitmap
    private val mPaint = Paint()

    /**
     * å›¾åƒæœ€åˆå§‹æ—¶çš„xå’Œyçš„åæ ‡
     */
    var originalOffsetX = 0f
    var originalOffsetY = 0f

    //å›¾åƒçš„åç§»åæ ‡
    private var offSetX = 0f
    private var offSetY = 0f

    /**
     * æ”¾å¤§çš„æ¯”ä¾‹
     */
    private val OVER_SCALE_FACTOR = 1.5f

    //å½“å‰çš„ç¼©æ”¾æ¯”ä¾‹
    private var currentScale = 0f
        set(value) {
            field = value
            invalidate()
        }

    //æœ€å°çš„ç¼©æ”¾æ¯”ä¾‹
    private var smallScale = 0f

    //æœ€å¤§çš„ç¼©æ”¾æ¯”ä¾‹
    private var bigScale = 0f

    //è®°å½•å½“å‰çš„çŠ¶æ€æ˜¯ä¸æ˜¯å·²ç»æ˜¯æ”¾å¤§
    private var isEnlarge = false

    /**
     * ä½¿ç”¨æä¾›çš„MotionEventæ£€æµ‹å„ç§æ‰‹åŠ¿å’Œäº‹ä»¶ã€‚ GestureDetector.OnGestureListenerå›è°ƒå°†åœ¨å‘ç”Ÿç‰¹å®šè¿åŠ¨äº‹ä»¶æ—¶é€šçŸ¥ç”¨æˆ·ã€‚ æ­¤ç±»åº”ä»…ä¸é€šè¿‡è§¦æ‘¸æŠ¥å‘Šçš„MotionEventä¸€èµ·ä½¿ç”¨ï¼ˆä¸è¦ç”¨äºè½¨è¿¹çƒäº‹ä»¶ï¼‰ã€‚ è¦ä½¿ç”¨è¿™ä¸ªç±»ï¼š
    ä¸ºæ‚¨çš„Viewåˆ›å»ºä¸€ä¸ªGestureDetectorå®ä¾‹
    åœ¨View.onTouchEvent(MotionEvent)æ–¹æ³•ä¸­ï¼Œç¡®ä¿æ‚¨è°ƒç”¨onTouchEvent(MotionEvent) ã€‚ å›è°ƒä¸­å®šä¹‰çš„æ–¹æ³•å°†åœ¨äº‹ä»¶å‘ç”Ÿæ—¶æ‰§è¡Œã€‚
    å¦‚æœç›‘å¬GestureDetector.OnContextClickListener.onContextClick(MotionEvent)ä½ å¿…é¡»åœ¨View.onGenericMotionEvent(MotionEvent)onGenericMotionEvent(MotionEvent)
    ä¸­è°ƒç”¨onGenericMotionEvent(MotionEvent) View.onGenericMotionEvent(MotionEvent) ã€‚
     */
    private lateinit var gestureDetector: GestureDetector

    /**
     * æ­¤ç±»å°è£…äº†æ»šåŠ¨ï¼Œå¹¶å…·æœ‰è¶…å‡ºæ»šåŠ¨æ“ä½œè¾¹ç•Œçš„èƒ½åŠ›ã€‚ åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæ­¤ç±»æ˜¯Scrolleræ›¿ä»£å“
     */
    private lateinit var overScroller: OverScroller

    private lateinit var scaleGestureDetector: ScaleGestureDetector

    constructor(context: Context?) : super(context) {
        init(context)
    }

    constructor(context: Context?, attrs: AttributeSet?) : super(context, attrs) {
        init(context)
    }

    constructor(context: Context?, attrs: AttributeSet?, defStyleAttr: Int) : super(
        context,
        attrs,
        defStyleAttr
    ) {
        init(context)
    }

    private fun init(context: Context?) {
        //è·å–bitmap
        bitmap =
            ImageUtils.instant.getBitmapBySize(context!!, R.drawable.test, ConverUtils.dp2px(300f))
        //æ³¨å†Œæ‰‹åŠ¿ç›‘å¬ç±»
        gestureDetector = GestureDetector(context, gestureDetectorListener)
        //ä¸ºäº†å®ç°åœ¨æ»‘åŠ¨åˆ°è¾¹ç¼˜çš„å›å¼¹æ•ˆæœ
        overScroller = OverScroller(context)
        //ç¼©æ”¾æ“ä½œ
        scaleGestureDetector = ScaleGestureDetector(context, PhotoScaleGestureListener())
    }
    /**
    ç»˜åˆ¶è¿™é‡Œå…¶å®ä¸€ç›´éƒ½æ˜¯ä»¥åŸå§‹çš„xï¼Œyè¿›è¡Œç»˜åˆ¶çš„ï¼Œä¸è¿‡æ˜¯åœ¨å‘ç”Ÿå˜åŒ–çš„æ—¶å€™ï¼Œåç§»ç”»å¸ƒï¼ˆå°†éœ€è¦çš„å†…å®¹å±•ç¤ºåˆ°å±å¹•ä¸Šï¼‰å’Œç¼©æ”¾å¤§ç”»å¸ƒï¼ˆåŸæœ¬éœ€è¦1åƒç´ ï¼Œç°åœ¨éœ€è¦2ä¸ªæˆ–è€…æ›´å¤šæ¥å±•ç¤ºï¼‰
    */
    override fun onDraw(canvas: Canvas) {
        super.onDraw(canvas)
        //currentScaleå½“å‰çš„æ¯”ä¾‹æ˜¯ä¸æ–­å˜åŒ–çš„ï¼Œè¿™æ ·è®¡ç®—è·å–åˆ°å½“å‰éœ€è¦å˜åŒ–çš„æ¯”ä¾‹ï¼Œä¾‹å¦‚æœ€å¼€å§‹çš„é€‚åˆcurrentScale = smallScaleï¼Œé‚£ä¹ˆscaleFaction = 0ï¼Œtranslateçš„æ“ä½œå°±æ˜¯ï¼ˆ0ï¼Œ0ï¼‰ä¸éœ€è¦åç§»
        val scaleFaction = (currentScale - smallScale) / (bigScale - smallScale)
        //ç”»å¸ƒåç§»
        canvas.translate(offSetX * scaleFaction, offSetY * scaleFaction)
        //æ ¹æ®æ¯”ä¾‹ä»¥æ§ä»¶ä¸­å¿ƒä¸ºè½´å¿ƒè¿›è¡Œç¼©æ”¾
        canvas.scale(currentScale, currentScale, width / 2f, height / 2f)
        //ç»˜åˆ¶å›¾åƒ
        canvas.drawBitmap(bitmap, originalOffsetX, originalOffsetY, mPaint)
    }

    override fun onSizeChanged(w: Int, h: Int, oldw: Int, oldh: Int) {
        super.onSizeChanged(w, h, oldw, oldh)
        originalOffsetX = (width - bitmap.width) / 2f
        originalOffsetY = (height - bitmap.height) / 2f
        //æ”¾å¤§çš„æ¯”ä¾‹ï¼Œæœ€å¤§çš„æ”¾å¤§æ¯”ä¾‹å–å®½é«˜ä¸­å°çš„é‚£ä¸ªï¼Œå› ä¸ºå®ƒçš„æ¯”ä¾‹å¤§
        if ((bitmap.width / bitmap.height) &gt; width / height) {
            //è¯´æ˜æ˜¯å®½å¤§äºé«˜çš„
            smallScale = (width / bitmap.width).toFloat()
            bigScale = (height / bitmap.height).toFloat() * OVER_SCALE_FACTOR
        } else {
            smallScale = (height / bitmap.height).toFloat()
            bigScale = (width / bitmap.width).toFloat() * OVER_SCALE_FACTOR
        }
        currentScale = smallScale
    }

    override fun onTouchEvent(event: MotionEvent?): Boolean {
        var result = scaleGestureDetector.onTouchEvent(event)
        if (!scaleGestureDetector.isInProgress) {
            result = gestureDetector.onTouchEvent(event)
        }
        return result
    }

    private var scaleAnimator: ObjectAnimator? = null

    private fun getScaleAnimation(smallScale: Float, bigScale: Float): ObjectAnimator {
        if (scaleAnimator == null) {
            //ç¼©æ”¾å¤„ç†çš„ä¸ºcurrentScaleè¿™ä¸ªå±æ€§ï¼ŒèŒƒå›´ä¸ºsmallScaleåˆ°bigScale
            scaleAnimator = ObjectAnimator.ofFloat(this, &quot;currentScale&quot;, 0f)
        }
        scaleAnimator!!.setFloatValues(smallScale, bigScale)
        return scaleAnimator!!
    }

    /**
     * æ§åˆ¶è¾¹ç•ŒèŒƒå›´
     */
    private fun fixOffsets() {
        //xè½´çš„åç§»å¿…é¡»åœ¨ä¸€ä¸ªèŒƒå›´ä¹‹å†…ï¼Œè¿™ä¸ªèŒƒå›´çš„æœ€å¤§å€¼æ˜¯å¤§å›¾çš„æœ€å¤§å®½åº¦-æ§ä»¶å®½åº¦çš„ä¸€åŠï¼Œè¿™é‡Œæ˜¯åœ¨å›¾åƒçš„å³è¾¹ï¼Œè€Œåœ¨å·¦è¾¹æ˜¯çš„æ˜¯è´Ÿå€¼çš„èŒƒå›´ï¼Œyè½´ç±»ä¼¼
        offSetX = Math.min(offSetX, (bitmap.width * bigScale - width) / 2f)
        offSetX = Math.max(offSetX, -(bitmap.width * bigScale - width) / 2f)
        offSetY = Math.min(offSetY, (bitmap.height * bigScale - height) / 2f)
        offSetY = Math.max(offSetY, -(bitmap.height * bigScale - height) / 2f)
    }


    /**
     * æ‰‹åŠ¿å¤„ç†ç±»
     */
    val gestureDetectorListener = object : GestureDetector.SimpleOnGestureListener() {

        /**
         * ä¸€ä¸ªäº‹ä»¶çš„å¼€å§‹æ˜¯ä»downå¼€å§‹çš„ï¼Œå¦‚æœdownæ²¡æœ‰è·å–åˆ°
         * é‚£ä¹ˆåç»­çš„äº‹ä»¶ä¹Ÿä¸ä¼šå†æ¶ˆè´¹ï¼Œæ‰€ä»¥è¿™é‡Œä¸ºäº†å®ç°åŒå‡»çš„æ•ˆæœï¼Œéœ€è¦æ¶ˆè´¹äº‹ä»¶
         */
        override fun onDown(e: MotionEvent?): Boolean {
            return true
        }

        /**
         * æ˜¾ç¤ºæ°´æ³¢çº¹
         */
        override fun onShowPress(e: MotionEvent?) {
            super.onShowPress(e)
        }

        /**
         * å•å‡»äº‹ä»¶çš„ï¼Œupäº‹ä»¶æ—¶å›æ‰
         */
        override fun onSingleTapUp(e: MotionEvent?): Boolean {
            return super.onSingleTapUp(e)
        }

        /**
         * æ»‘åŠ¨æ˜¯è¿›è¡Œå›¾åƒç§»åŠ¨
         */
        override fun onScroll(
            e1: MotionEvent?,
            e2: MotionEvent?,
            distanceX: Float,
            distanceY: Float
        ): Boolean {
            //åªåœ¨å¤§å›¾çš„æƒ…å†µä¸‹è¿›è¡Œè§¦å‘
            if (isEnlarge) {
                offSetX -= distanceX
                offSetY -= distanceY
                fixOffsets()
                invalidate()
            }
            return super.onScroll(e1, e2, distanceX, distanceY)
        }

        /**
         * é•¿æŒ‰
         */
        override fun onLongPress(e: MotionEvent?) {
            super.onLongPress(e)
        }

        /**
         * æƒ¯æ€§æ»‘åŠ¨ï¼Œåœ¨æƒ¯æ€§æ»‘åŠ¨çš„æƒ…å†µä¸‹å®ç°ä¸€ä¸ªå›å¼¹çš„æ•ˆæœ
         */
        override fun onFling(
            e1: MotionEvent?,
            e2: MotionEvent?,
            velocityX: Float,
            velocityY: Float
        ): Boolean {
            if (isEnlarge) {
                //overX â€“ è¶…å‡ºèŒƒå›´ã€‚ å¦‚æœ &gt; 0ï¼Œåˆ™å¯ä»¥åœ¨ä»»ä¸€æ–¹å‘è¿›è¡Œæ°´å¹³ç¿»è½¬ã€‚
                //overY â€“ è¶…å‡ºèŒƒå›´ã€‚ å¦‚æœ &gt; 0ï¼Œåˆ™å¯ä»¥åœ¨ä»»ä¸€æ–¹å‘è¿›è¡Œå‚ç›´ç¿»è½¬
                overScroller.fling(
                    offSetX.toInt(), offSetY.toInt(), velocityX.toInt(), velocityY.toInt(),
                    (-(bitmap.width * bigScale - width) / 2).toInt(),
                    ((bitmap.width * bigScale - width) / 2).toInt(),
                    (-(bitmap.height * bigScale - height) / 2).toInt(),
                    ((bitmap.height * bigScale - height) / 2).toInt(), 300, 300
                )
                postOnAnimation(FlishRunner())
            }
            return super.onFling(e1, e2, velocityX, velocityY)
        }

        /**
         * ç‚¹å‡»åœ¨upä»¥åŠTagæ—¶ä¼šè§¦å‘å›æ‰
         */
        override fun onSingleTapConfirmed(e: MotionEvent?): Boolean {
            return super.onSingleTapConfirmed(e)
        }

        /**
         * åŒå‡»äº‹ä»¶çš„çš„Eventå›æ‰ï¼ŒåŒ…æ‹¬æœ‰downï¼Œmoveï¼Œup
         */
        override fun onDoubleTapEvent(e: MotionEvent?): Boolean {
            return super.onDoubleTapEvent(e)
        }

        override fun onContextClick(e: MotionEvent?): Boolean {
            return super.onContextClick(e)
        }

        /**
         * åŒå‡»äº‹ä»¶çš„ç¬¬äºŒæ¬¡downäº‹ä»¶ä¼šè¿›è¡Œå›æ‰
         */
        override fun onDoubleTap(e: MotionEvent): Boolean {
            isEnlarge = !isEnlarge
            if (isEnlarge) {
                //å®ç°çš„æ•ˆæœæ˜¯ç‚¹å‡»æ˜¯ç‚¹å‡»ä»€ä¹ˆåœ°æ–¹æ”¾å¤§ä»€ä¹ˆåœ°æ–¹ï¼Œæ‰€ä»¥éœ€è¦å¯¹åæ ‡è¿›è¡Œåç§»å¤„ç†
                offSetX = (e.x - width / 2) - (e.x - width / 2) * bigScale / smallScale
                offSetY = (e.y - height / 2) - (e.y - height / 2) * bigScale / smallScale
                fixOffsets()
                //é€šè¿‡åŠ¨ç”»æ¥è¿›è¡Œç¼©æ”¾å¤„ç†
                getScaleAnimation(smallScale, bigScale).start()
            } else {
                //åŠ¨ç”»åè½¬
                val tempScale = Math.min(currentScale, bigScale)
                getScaleAnimation(smallScale, tempScale).reverse()
            }
            return super.onDoubleTap(e)
        }
    }

    inner class FlishRunner : Runnable {
        override fun run() {
            //computeScrollOffsetä¸ºtrueï¼Œè¯´æ˜åŠ¨ç”»è¿˜æ²¡ç»“æŸ
            if (overScroller.computeScrollOffset()) {
                //currXè·å–çš„æ˜¯å½“åŸç‚¹å’Œç°åœ¨ä½ç½®çš„ç»å¯¹è·ç¦»ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬éœ€è¦çš„åç§»é‡ï¼Œå› ä¸ºéœ€è¦å›å¼¹å¤„ç†ï¼Œè¿™é‡Œä¸éœ€è¦å¤„ç†è¾¹ç•Œé—®é¢˜
                offSetX = overScroller.currX.toFloat()
                offSetY = overScroller.currY.toFloat()
                invalidate()
                postOnAnimation(this)
            }
        }
    }

    /**
     * æ‰‹åŠ¿å‘ç”Ÿæ—¶æ¥æ”¶é€šçŸ¥çš„ç›‘å¬å™¨ã€‚ å¦‚æœä½ æƒ³ç›‘å¬æ‰€æœ‰ä¸åŒçš„æ‰‹åŠ¿ï¼Œé‚£ä¹ˆå®ç°è¿™ä¸ªæ¥å£ã€‚ å¦‚æœæ‚¨åªæƒ³ä¾¦å¬å­é›†ï¼Œ
     * æ‰©å±•ScaleGestureDetector.SimpleOnScaleGestureListenerå¯èƒ½ä¼šæ›´å®¹æ˜“ã€‚ åº”ç”¨ç¨‹åºå°†æŒ‰ä»¥ä¸‹é¡ºåºæ¥æ”¶äº‹ä»¶ï¼š
    ä¸€ä¸ªonScaleBegin(ScaleGestureDetector)
    é›¶ä¸ªæˆ–å¤šä¸ªonScale(ScaleGestureDetector)
    ä¸€ä¸ªonScaleEnd(ScaleGestureDetector)
     */
    inner class PhotoScaleGestureListener : ScaleGestureDetector.OnScaleGestureListener {

        var initScale = 0f;

        /**
         * å“åº”æ­£åœ¨è¿›è¡Œçš„æ‰‹åŠ¿çš„ç¼©æ”¾äº‹ä»¶ã€‚ é€šè¿‡æŒ‡é’ˆè¿åŠ¨æŠ¥å‘Š
         * @param
         * @return æ£€æµ‹å™¨æ˜¯å¦åº”å°†æ­¤äº‹ä»¶è§†ä¸ºå·²å¤„ç†ã€‚ å¦‚æœäº‹ä»¶æœªè¢«å¤„ç†ï¼Œæ¢æµ‹å™¨å°†ç»§ç»­ç´¯ç§¯è¿åŠ¨ï¼Œç›´åˆ°äº‹ä»¶è¢«å¤„ç†ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœåº”ç”¨ç¨‹åºåªæƒ³åœ¨æ›´æ”¹å¤§äº 0.01 æ—¶æ›´æ–°ç¼©æ”¾å› å­ï¼Œè¿™ä¼šå¾ˆæœ‰ç”¨ã€‚
         */
        override fun onScale(detector: ScaleGestureDetector): Boolean {
            currentScale = initScale * detector.scaleFactor
            isEnlarge = currentScale &gt; smallScale
            invalidate()
            return false
        }

        /**
         * @return æ£€æµ‹å™¨æ˜¯å¦åº”ç»§ç»­è¯†åˆ«æ­¤æ‰‹åŠ¿ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœæ‰‹åŠ¿å¼€å§‹äºæœ‰æ„ä¹‰çš„åŒºåŸŸä¹‹å¤–çš„ç„¦ç‚¹ï¼Œåˆ™ onScaleBegin() å¯èƒ½ä¼šè¿”å› false ä»¥å¿½ç•¥æ‰‹åŠ¿çš„å…¶ä½™éƒ¨åˆ†
         */
        override fun onScaleBegin(detector: ScaleGestureDetector?): Boolean {
            //è¿™æ˜¯ç¼©æ”¾æ¯”ä¾‹ä¸éƒ½æ˜¯ä»é›¶å¼€å§‹çš„
            initScale = currentScale
            return true
        }

        /**
         * æ‰‹åŠ¿ç¼©æ”¾ç»“æŸæ—¶ï¼Œå¤„ç†è¾¹ç•Œé—®é¢˜ï¼Œå¯ä»¥åœ¨åŒæŒ‡æ—¶å±•ç¤ºæ›´å¤§æˆ–æ›´å°ï¼Œä½†å½“ç»“æŸæ—¶æ¢å¤åˆ°è¾¹ç•ŒèŒƒå›´
         */
        override fun onScaleEnd(detector: ScaleGestureDetector?) {
            if (currentScale &gt; bigScale) {
                getScaleAnimation(bigScale, currentScale).reverse()
            } else if (currentScale &lt; smallScale) {
                getScaleAnimation(currentScale, smallScale).start()
            }
        }
    }
}
</code></pre>
<p>é¢„ç•™æœªå®Œæˆï¼š<br>
1.åŠ è½½çš„å›¾ç‰‡æ¯”ä¾‹éœ€è¦è®¡ç®—ï¼Œç°åœ¨æ˜¯å›ºå®šä¸º300dp<br>
2.å›¾ç‰‡çš„åŠ è½½åŠŸèƒ½æ²¡æœ‰</p>
<hr>
<h2 id="åœºæ™¯2å¤šç‚¹è§¦æ§">åœºæ™¯2ï¼šå¤šç‚¹è§¦æ§</h2>
<p>åœ¨Androidä¸Šæ˜¯æ”¯æŒå¤šç‚¹è§¦æ§çš„ï¼Œæ³¨æ„çš„ç‚¹å°±æ˜¯éœ€è¦æ˜¯ä½¿ç”¨getActionMaskedï¼ŒåŸæ¥çš„getActionåªèƒ½è·å–åˆ°indexä¸º0çš„æ‰‹æŒ‡äº‹ä»¶ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ—¶äº‹ä»¶çš„è§¦å‘æ—¶æœºï¼Œå¹¶ä¸”æ‰€æœ‰çš„æ‰‹æŒ‡çš„Evenéƒ½æ˜¯é€šè¿‡ä¸€ä¸ªæ•°ç»„è¿›è¡Œå­˜å‚¨çš„ï¼Œå½“æŠ¬èµ·æ—¶ä»æ•°ç»„ä¸­ç§»é™¤è¿™ä¸ªï¼Œä½†æ˜¯å½“æœ‰æ–°çš„æ‰‹æŒ‡è½ä¸‹æ—¶ï¼Œä¼šå…ˆåˆ†é…åˆ°ä¹‹å‰æŠ¬èµ·çš„indexä¸Šã€‚</p>
<pre><code class="language-java">package com.arms.flowview.photoView

import android.content.Context
import android.graphics.Bitmap
import android.graphics.Canvas
import android.graphics.Paint
import android.util.AttributeSet
import android.view.MotionEvent
import android.view.View
import com.arms.flowview.R
import com.arms.flowview.utils.ConverUtils
import com.arms.flowview.utils.ImageUtils
import com.orhanobut.logger.Logger

/**
 *    author : heyueyang
 *    time   : 2021/12/27
 *    desc   :
 *    version: 1.0
 */
class MultiPointView : View {

    private lateinit var bitmap: Bitmap
    private lateinit var paint: Paint

    // æ‰‹æŒ‡æ»‘åŠ¨åç§»å€¼
    private var offsetX = 0f
    private var offsetY = 0f

    // æŒ‰ä¸‹æ—¶çš„x,yåæ ‡
    private var downX = 0f
    private var downY = 0f

    // ä¸Šä¸€æ¬¡çš„åç§»å€¼
    private var lastOffsetX = 0f
    private var lastOffsetY = 0f

    // å½“å‰æŒ‰ä¸‹çš„pointId
    private var currentPointId = 0

    constructor(context: Context?) : super(context)
    constructor(context: Context?, attrs: AttributeSet?) : super(context, attrs)
    constructor(context: Context?, attrs: AttributeSet?, defStyleAttr: Int) : super(
        context,
        attrs,
        defStyleAttr
    )

    init {
        init(context)
    }

    private fun init(context: Context?) {
        bitmap =
            ImageUtils.instant.getBitmapBySize(context!!, R.drawable.dm1, ConverUtils.dp2px(300f))
        paint = Paint().apply {
            isAntiAlias = true
        }
    }

    override fun draw(canvas: Canvas) {
        super.draw(canvas)
        canvas.drawBitmap(bitmap, offsetX, offsetY, paint)
    }

    override fun onTouchEvent(event: MotionEvent): Boolean {
        //è¦æƒ³å¤„ç†å¤šæŒ‡å¿…é¡»ä½¿ç”¨actionMasked
        when (event.actionMasked) {
            //DOWNåªä¼šåœ¨ç¬¬ä¸€æ ¹æ‰‹æŒ‡è½ä¸‹æ—¶è§¦å‘
            MotionEvent.ACTION_DOWN -&gt; {
                downX = event.x
                downY = event.y

                lastOffsetX = offsetX
                lastOffsetY = offsetY
                currentPointId = 0
            }
            MotionEvent.ACTION_MOVE -&gt; {
                //é€šè¿‡idè·å–å½“å‰çš„ä¸‹æ ‡,è¿™é‡Œå®ç°çš„æ•ˆæœæ˜¯ï¼Œåœ¨å‰ä¸€æ ¹æ‰‹æŒ‡
                val index = event.findPointerIndex(currentPointId)

                offsetX = lastOffsetX + event.getX(index) - downX
                offsetY = lastOffsetY + event.getY(index) - downY
                invalidate()
            }
            MotionEvent.ACTION_POINTER_DOWN -&gt; {
                //å¤šæŒ‡æ“ä½œçš„æƒ…å†µä¸‹ï¼Œä»ç¬¬äºŒä¸ªæ‰‹æŒ‡è½ä¸‹æ—¶ä¼šè§¦å‘
                //è·å–å½“å‰çš„è½ä¸‹çš„ä¸‹æ ‡
                val actionIndex = event.actionIndex
                Logger.e(&quot;actionIndex:${actionIndex}&quot;)
                //é€šè¿‡ä¸‹æ ‡è·å–å¯¹åº”çš„æ‰‹æŒ‡IDï¼Œ
                currentPointId = event.getPointerId(actionIndex)
                downX = event.getX(actionIndex)
                downY = event.getY(actionIndex)
                lastOffsetX = offsetX
                lastOffsetY = offsetY
            }
            MotionEvent.ACTION_POINTER_UP -&gt; {
                //éæœ€åä¸€æ ¹æ‰‹æŒ‡æŠ¬èµ·æ—¶è§¦å‘
                var upIndex = event.actionIndex
                val pointId = event.getPointerId(upIndex)
                //å€¼å¤„ç†å½“å‰æ­£åœ¨ç›¸åº”äº‹ä»¶çš„æ‰‹æŒ‡
                if (pointId == currentPointId) {
                    //åœ¨æ‰‹æŒ‡æŠ¬èµ·åè·å–ä¸‹ä¸€ä¸ªç›¸åº”çš„ä¸‹æ ‡
                    val nextLastIndex =
                        if (upIndex == event.pointerCount - 1) {
                            event.pointerCount - 2
                        } else {
                            upIndex++
                        }
                    currentPointId = event.getPointerId(nextLastIndex)

                    downX = event.getX(nextLastIndex)
                    downY = event.getY(nextLastIndex)
                    lastOffsetX = offsetX
                    lastOffsetY = offsetY
                }
            }
            //æœ€åä¸€æ ¹æ‰‹æŒ‡æŠ¬èµ·æ—¶è§¦å‘
            MotionEvent.ACTION_UP-&gt;{

            }
        }
        return true
    }

}
</code></pre>
<h1 id="é¡¹ç›®åœ°å€"><a href="https://github.com/Arms-merchants/Study/tree/main/UI/FlowView/app/src/main/java/com/arms/flowview/photoView">é¡¹ç›®åœ°å€</a></h1>
]]></content>
    </entry>
</feed>