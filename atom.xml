<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://arms-merchants.github.io/</id>
    <title>Arms-merchants</title>
    <updated>2024-01-05T08:06:39.076Z</updated>
    <generator>https://github.com/jpmonette/feed</generator>
    <link rel="alternate" href="https://arms-merchants.github.io/"/>
    <link rel="self" href="https://arms-merchants.github.io/atom.xml"/>
    <subtitle>æ¸©æ•…è€ŒçŸ¥æ–°</subtitle>
    <logo>https://arms-merchants.github.io/images/avatar.png</logo>
    <icon>https://arms-merchants.github.io/favicon.ico</icon>
    <rights>All rights reserved 2024, Arms-merchants</rights>
    <entry>
        <title type="html"><![CDATA[åœ¨AndroidStudio Hedgehogä¸­ä½¿ç”¨Bitoæ’ä»¶é”™è¯¯çš„è§£å†³æ–¹æ¡ˆ]]></title>
        <id>https://arms-merchants.github.io/post/zai-androidstudio-hedgehog-zhong-shi-yong-bito-cha-jian-cuo-wu-de-jie-jue-fang-an/</id>
        <link href="https://arms-merchants.github.io/post/zai-androidstudio-hedgehog-zhong-shi-yong-bito-cha-jian-cuo-wu-de-jie-jue-fang-an/">
        </link>
        <updated>2024-01-05T06:40:41.000Z</updated>
        <content type="html"><![CDATA[<p>è¿™æ®µæ—¶é—´ä¸€ç›´åœ¨ASä¸­ä½¿ç”¨Bitoè¿™ä¸ªåŸºäºChatGPTçš„æ’ä»¶ï¼Œå½“ç„¶äº†ç™½æ¼‚ä¸ºä¸»ï¼Œæ‰€ä»¥ç”¨çš„éƒ½æ˜¯å…è´¹ç‰ˆçš„ï¼Œä¸è¿‡ä¸€äº›é—®é¢˜åŸºæœ¬éƒ½èƒ½è§£å†³ï¼Œä¸èƒ½è¯å°±æ¢ä¸€å®¶ğŸ¶ã€‚<br>
ä¸è¿‡å—åœ¨æ„‰å¿«çš„ç©è€äº†ä¸€æ®µæ—¶é—´ï¼Œç„¶åæ‰‹ä¸å—æ§åˆ¶çš„å°†ASæ›´æ–°åˆ°æœ€æ–°äº†ï¼Œæ„‰å¿«ä¸èµ·æ¥äº†ã€‚ã€‚ã€‚ã€‚</p>
<h2 id="gpu-process-restarts-too-many-times-and-seems-to-be-unstable-try-to-restart-ide-or-disable-gpu-acceleration-completely">GPU process restarts too many times and seems to be unstable. Try to restart IDE or disable GPU acceleration completely.</h2>
<p>ç„¶åBitoå°±åŠ è½½ä¸å‡ºæ¥äº†ï¼Œå°è¯•å°†æ’ä»¶é‡è£…ä¹Ÿä¸€æ ·çš„æ•ˆæœã€‚æœ€ååªæœ‰é™çº§å›Giraffeç‰ˆæœ¬æ‰èƒ½æ­£å¸¸ä½¿ç”¨ã€‚<br>
ä¸è¿‡æœ€è¿‘åœ¨Bitoçš„githubä»“åº“çš„issuesä¸­çœ‹åˆ°äº†ä¸ªè§£å†³æ–¹æ¡ˆï¼Œå°è¯•æˆåŠŸè§£å†³äº†æˆ‘çš„é—®é¢˜ï¼Œå¦‚ä½•ä½ æ˜¯å’Œæˆ‘ä¸€æ ·çš„é”™è¯¯ï¼Œå¯ä»¥è€ƒè™‘å°è¯•è¯¥æ–¹æ³•ï¼š<br>
1.åœ¨Helpèœå•ä¸­é€‰æ‹©Find Action<br>
2.è¾“å…¥Registryé€‰æ‹©Registry...<br>
3.åœ¨å‡ºç°çš„åˆ—è¡¨ä¸­æ‰¾åˆ°ide.browser.jcef.sandbox.enableé€‰é¡¹ï¼Œå°†å®ƒç¦ç”¨è°ƒ<br>
4.é‡å¯<br>
ç„¶ååº”è¯¥èƒ½ç»§ç»­è°ƒæˆBitoAiäº†ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ä½¿ç”¨Composeæ¥å¼€å‘WanAndroidAppç¢°åˆ°çš„ä¸€äº›é—®é¢˜é›†é”¦]]></title>
        <id>https://arms-merchants.github.io/post/shi-yong-compose-lai-kai-fa-wanandroidapp-peng-dao-de-yi-xie-wen-ti-ji-jin/</id>
        <link href="https://arms-merchants.github.io/post/shi-yong-compose-lai-kai-fa-wanandroidapp-peng-dao-de-yi-xie-wen-ti-ji-jin/">
        </link>
        <updated>2023-05-25T06:17:04.000Z</updated>
        <content type="html"><![CDATA[<h2 id="1lzaycloumné¡µé¢é‡æ–°å±•ç¤ºçš„æ—¶å€™å‡ºç°é‡æ–°å®šä½åˆ°é¡¶éƒ¨çš„é—®é¢˜">1.LzayCloumné¡µé¢é‡æ–°å±•ç¤ºçš„æ—¶å€™å‡ºç°é‡æ–°å®šä½åˆ°é¡¶éƒ¨çš„é—®é¢˜</h2>
<h3 id="11é—®é¢˜åœºæ™¯">1.1é—®é¢˜åœºæ™¯ï¼š</h3>
<p>ä½¿ç”¨PaginåŠ è½½åˆ†é¡µæ•°æ®ï¼Œå¹¶æ˜¾ç¤ºåœ¨Açš„LazyColumnä¸Šï¼Œå‘ä¸‹æ»‘åŠ¨LazyColumnï¼Œç„¶åé€šè¿‡navigation.navigateè·³è½¬åˆ°é¡µé¢Bï¼Œæ¥ç€å†navigatUpå›åˆ°é¡µé¢Aï¼Œé¡µé¢Açš„LazyColumnåˆå›åˆ°åˆ—è¡¨é¡¶éƒ¨ã€‚</p>
<h3 id="12åˆ†æ">1.2åˆ†æï¼š</h3>
<p>LazyColumné»˜è®¤çš„å‚æ•°stateæ˜¯æœ‰é€šè¿‡rememberLazyListState()æ¥åšæŒä¹…åŒ–ä¿å­˜çš„ã€‚å¦‚æœLazyColumnå†…éƒ¨åªåŒ…å«ä¸€ä¸ªitemsæ¥åˆ›å»ºå­åˆ—è¡¨çš„è¯ï¼Œé‚£ä¹ˆæ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œå¦‚æœæ˜¯å†…éƒ¨é€šè¿‡itemæ¥åˆ›å»ºäº†Headeræ´»ç€Footerå°±ä¸è¡Œäº†ã€‚<br>
è¿™æ˜¯å› ä¸ºrememberLazyListStateä¼šåœ¨åˆ—è¡¨ä¸­è‡³å°‘æœ‰ä¸€é¡¹æ—¶restoreæ»šåŠ¨ä½ç½®ï¼ŒåŒæ—¶Pagingæ˜¯é€šè¿‡Flowè·å–æ•°æ®çš„ï¼Œå½“è¿”å›åˆ°é¡µé¢é‡ç»„æ—¶å¹¶ä¸èƒ½é©¬ä¸Šè·å–åˆ°Pagingæ•°æ®ï¼Œç¬¬ä¸€å¸§æ—¶Pagingçš„itemCountä¸º0<br>
ä½†åŒæ—¶å› ä¸ºLazyColumnä¸­å·²ç»æœ‰äº†ä¸€ä¸ªHeaderï¼Œè¿™æ—¶ä¾¿ä¼šè¿˜åŸä¿å­˜çš„ä½ç½®ï¼Œä½†å› ä¸ºè¿™æ—¶Pagingä¸­çš„æ•°æ®è¿˜ä¸ºç©ºï¼Œä¸èƒ½æ»šåŠ¨åˆ°æ­£ç¡®çš„ä½ç½®ï¼Œäºæ˜¯ä¾¿åˆæ»šåŠ¨åˆ°é¡¶éƒ¨äº†<br>
è€Œå½“LazyColumnä¸­æ²¡æœ‰Headeræ—¶ï¼Œåˆ—è¡¨ä¸­è‡³å°‘æœ‰ä¸€é¡¹æ—¶ä¾¿æ˜¯Pagingæ•°æ®æˆåŠŸå¡«å……çš„æ—¶å€™ï¼Œè¿™ä¸ªæ—¶å€™è¿˜åŸçš„ä½ç½®å°±æ˜¯å¯¹çš„,æ‰€ä»¥æ²¡æœ‰é—®é¢˜ã€‚</p>
<h3 id="13è§£å†³é—®é¢˜">1.3è§£å†³é—®é¢˜ï¼š</h3>
<p>æ—¢ç„¶åŸå› åœ¨äºLazyListStateæ²¡æœ‰åœ¨æ­£ç¡®çš„æ—¶æœºè¢«è¿˜åŸï¼Œé‚£æˆ‘ä»¬å°†LazyListSateä¿å­˜åœ¨ViewModelä¸­,å¹¶ä¸”åœ¨Pagingä¸­æœ‰æ•°æ®æ—¶å†è¿˜åŸlistStateï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre><code class="language-java">@HiltViewModel
class SquareViewModel @Inject constructor(
    private var service: HttpService,
) : ViewModel() {
    private val pager by lazy { simplePager { service.getSquareData(it) }.cachedIn(viewModelScope) }
    val listState: LazyListState = LazyListState()
}
 
@Composable
fun SquarePage(
    navCtrl: NavHostController,
    scaffoldState: ScaffoldState,
    viewModel: SquareViewModel = hiltViewModel()
) {
    val squareData = viewStates.pagingData.collectAsLazyPagingItems()
    // å½“`Paging`æœ‰æ•°æ®æ—¶ï¼Œè¿”å›`ViewModel`ä¸­çš„`listState`
    val listState = if (squareData.itemCount &gt; 0) viewStates.listState else LazyListState()
 
    RefreshList(squareData, listState = listState) {
        itemsIndexed(squareData) { _, item -&gt;
           //...
        }
    }
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[é˜…è¯»KotlinComposeä»å…¥é—¨åˆ°å®æˆ˜è¯»ä¹¦ç¬”è®°ä¸€]]></title>
        <id>https://arms-merchants.github.io/post/compose-yi/</id>
        <link href="https://arms-merchants.github.io/post/compose-yi/">
        </link>
        <updated>2023-05-17T11:36:10.000Z</updated>
        <content type="html"><![CDATA[<h2 id="1composeåŸºæœ¬æ¦‚å¿µ">1.ComposeåŸºæœ¬æ¦‚å¿µ</h2>
<p>ç›¸è¾ƒäºä¹‹å‰åŸºäºviewä½“ç³»çš„UIï¼ŒComposeæ˜¯Androidå…¨æ–°çš„å£°æ˜å¼UIï¼Œé‚£ä¹ˆå£°æ˜å¼å’Œå‘½ä»¤å¼çš„åŒºåˆ«æ˜¯ä»€ä¹ˆï¼Ÿ<br>
åŸºäºViewä½“ç°çš„UIå°±æ˜¯å…¸å‹çš„å‘½ä»¤å¼UIï¼Œæˆ‘ä»¬éœ€è¦ä¸€æ­¥æ­¥çš„å‘Šè¯‰ç¨‹åºæ€ä¹ˆå–æ‰§è¡Œï¼Œæˆ‘ä»¬éœ€è¦è·å–æ§ä»¶ï¼Œç„¶åç»™æ§ä»¶è®¾ç½®å¯¹åº”çš„å±æ€§ï¼Œè€Œæ§ä»¶ä¼šæŒæœ‰ç›¸åº”çš„å±æ€§å€¼ï¼Œç›¸å½“äºæ§ä»¶æ˜¯æŒæœ‰çŠ¶æ€çš„ã€‚ä½†æ˜¯å£°æ˜å¼UIæ˜¯æˆ‘ä»¬å‘Šè¯‰ç¨‹åºæˆ‘æƒ³è¦æ€ä¹ˆæ ·ï¼Œå‰©ä¸‹çš„ç”±ç¨‹åºå¤„ç†ã€‚</p>
<h2 id="2è®¾ç½®é¡¹ç›®æ”¯æŒcompose">2.è®¾ç½®é¡¹ç›®æ”¯æŒCompose</h2>
<p>build.gradleçš„ç›¸å…³é…ç½®</p>
<pre><code class="language-java">android{
    ...
    //composeæ˜¯åŸºäºå•ä¸€è¯­è¨€(Kotlin)çš„
    kotlinOptions {
        jvmTarget = '1.8'
    }
    buildFeatures {
        compose true
    }
    composeOptions {
        kotlinCompilerExtensionVersion '1.2.0'
    }
    packagingOptions {
        resources {
            excludes += '/META-INF/{AL2.0,LGPL2.1}'
        }
    }
}
dependencies{
    ...
    //ComponentActivity
    implementation 'androidx.activity:activity-compose:1.4.0'
    //composeçš„åŸºç¡€åº“
    implementation &quot;androidx.compose.ui:ui:$compose_ui_version&quot;
    //ç”¨äºcomposeçš„é¢„è§ˆ
    implementation &quot;androidx.compose.ui:ui-tooling-preview:$compose_ui_version&quot;
    //Materialçš„compose
    implementation 'androidx.compose.material:material:1.2.0'
    //composeç‰ˆæœ¬çš„constraintlayout
    implementation &quot;androidx.constraintlayout:constraintlayout-compose:1.0.1&quot;
    //ä¸€ä¸ªå›¾ç‰‡åŠ è½½æ¡†æ¶
    implementation &quot;io.coil-kt:coil-compose:2.2.2&quot;
    //composeç‰ˆæœ¬çš„livedata
    implementation &quot;androidx.compose.runtime:runtime-livedata:$compose_ui_version&quot;
}
</code></pre>
<p>å¦‚æœæ˜¯é€šè¿‡ASæ¥ç›´æ¥ç”Ÿæˆä¸€ä¸ªComposeé¡¹ç›®çš„è¯ï¼Œä¸Šé¢éƒ¨åˆ†é…ç½®å’Œä¾èµ–éƒ½ä¼šå·²ç»æ·»åŠ å¥½ï¼Œä¸è¿‡æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªè¡Œé…ç½®å˜›ï¼ŒComposeæ˜¯æ”¯æŒå’ŒåŸç”Ÿé¡¹ç›®æ··ç¼–çš„ï¼Œæ”¯æŒåœ¨Composeä¸­ä½¿ç”¨åŸç”ŸViewä½“ç³»ï¼Œä¹Ÿæ”¯æŒåœ¨åŸç”Ÿçš„Viewä½“ç³»ä¸­ä½¿ç”¨Composeã€‚<br>
æ¥çœ‹ä¸€ä¸‹é€šè¿‡ASç›´æ¥åˆ›å»ºä¸€ä¸ªç©ºçš„Composeé¡¹ç›®çš„MainActivity</p>
<pre><code class="language-java">//ç»§æ‰¿çš„æ˜¯ComponentActivity
class MainActivity : ComponentActivity() {
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        //è®¾ç½®äº†ä¸ªæ²‰æµ¸ï¼Œéå¿…é¡»
        WindowCompat.setDecorFitsSystemWindows(window, false)
        val controller = WindowCompat.getInsetsController(window, window.decorView)
        controller.isAppearanceLightStatusBars = true
        //è®¾ç½®å†…å®¹
        setContent {
            //åœ¨ui/theme/ä¸‹Theme.ktä¸­é…ç½®çš„ä¸»ä½“
            StComposeTheme {
                //å…·ä½“çš„æ§ä»¶åé¢å†è¯´ï¼Œè¿™é‡Œå¯ä»¥ç†è§£ä¸ºå…¨å±ï¼ŒèƒŒæ™¯è‰²ä¸ºStComposeThemeä¸­é…ç½®çš„backgroundçš„color
                Surface(
                    modifier = Modifier.fillMaxSize(),
                    color = MaterialTheme.colors.background
                ) {
                    Greeting(&quot;Android&quot;)
                }
            }
        }
    }
    /**
    å£°æ˜çš„ä¸€ä¸ªComposeå‡½æ•°ï¼Œ@Previewå¯ä»¥é¢„è§ˆå½“å‰Composeçš„æ ·å¼ï¼Œä¸è¿‡éœ€è¦æ³¨æ„æœ‰å‚æ•°çš„è¯è®°å¾—ç»™å‡ºé»˜è®¤å€¼
    */
    @Preview(showBackground = true)
    @Composable
    fun Greeting(str:String = &quot;123&quot;){
        //å°±ä¸€ä¸ªæ–‡æœ¬æ§ä»¶
        Text(text = str)
    }
}
</code></pre>
<p>Composeå‡½æ•°é¢„è§ˆæ•ˆæœ<br>
<img src="https://arms-merchants.github.io//post-images/1684293710477.png" alt="" loading="lazy"><br>
ä¸è¿‡ç°åœ¨Greetingå‡½æ•°éå¸¸ç®€å•ï¼Œä¸‹é¢æˆ‘ä»¬æ¥æ„å»ºä¸€ä¸ªå¤æ‚çš„é¡µé¢ï¼š<br>
å…ˆçœ‹é¢„è§ˆçš„æ•ˆæœå›¾ï¼š<br>
<img src="https://arms-merchants.github.io//post-images/1684294378624.png" alt="" loading="lazy"></p>
<pre><code class="language-java">@Composable
fun Greeting(name: String) {
    Box(
        modifier = Modifier
            .fillMaxSize()
            //composeä¸­åªæœ‰paddingçš„æ¦‚å¿µï¼Œæ ¹æ®è°ƒç”¨çš„é¡ºåºå¯ä»¥å®ç°åŸæ¥çš„å¤–è¾¹è·å’Œå†…è¾¹è·çš„æ•ˆæœ
            //è¿™é‡Œè®¾ç½®çš„å°±æ˜¯å¤–è¾¹è·
            .padding(8.dp)
            //è®¾ç½®è¾¹æ¡† å®½2dp é»„è‰² åœ†è§’ä¸º2dp
            .border(2.dp, Color.Yellow, shape = RoundedCornerShape(2.dp))
            .background(color = Color.Red)
            .padding(8.dp)
    ) {
        Spacer(
            //æ³¨æ„è¿™é‡Œçš„Modifierï¼Œå› ä¸ºå®ƒæ˜¯åœ¨BoxScopeçš„ä¸­ï¼Œæ‰€ä»¥å®ƒå¯ä»¥è®¾ç½®çš„æ–¹æ³•ä¼šå¤šå‡ºä¸¤ä¸ªåˆ†åˆ«æ˜¯alignå’ŒmatchParenSizeï¼Œè¿™æ˜¯åœ¨Boxä¸­çš„Modifierä¸­ä¸å…·å¤‡çš„
            modifier = Modifier
                .matchParentSize()
                .background(color = Color.Green)
        )
    }
    //å®šä¹‰ä¸ªåˆ—è¡¨
    Column {
        //æ–‡æœ¬æ§ä»¶
        Text(text = &quot;Hello $name!&quot;)
        //å› ä¸ºComposeä¸­æ²¡æœ‰Marginçš„æ¦‚å¿µï¼Œä¸è¿‡å¯ä»¥é€šè¿‡Spaceræ¥è®¾ç½®ä¸¤ä¸ªæ§ä»¶ä¹‹é—´çš„é—´è·
        Spacer(modifier = Modifier.height(10.dp))
        //å›¾ç‰‡æ§ä»¶
        Image(
            //ä½¿ç”¨æœ¬åœ°å›¾ç‰‡èµ„æºçš„æ–¹å¼
            painter = painterResource(id = R.mipmap.ic_hotel_share_img),
            //æè¿°ä¿¡æ¯ï¼Œå¯ä»¥ä¸ºç©º
            contentDescription = null,
            //è®¾ç½®å›¾ç‰‡çš„å®½é«˜ä»¥åŠè£å‰ªæ ·å¼ä¸ºåœ†å½¢
            modifier = Modifier
                .size(width = 200.dp, height = 200.dp)
                .clip(CircleShape)
        )
        Spacer(modifier = Modifier.height(10.dp))
        Box(
            modifier = Modifier
                .size(50.dp)
                .background(color = Color.Red)
        ) {
            Text(text = &quot;çº¯è‰²&quot;, Modifier.align(Alignment.Center))
        }
        Spacer(modifier = Modifier.height(10.dp))
        Box(
            modifier = Modifier
                .size(50.dp)
                .background(
                    //èƒŒæ™¯çš„æ¸å˜æ•ˆæœ
                    brush = verticalGradientBrush1
                )
        ) {
            Text(text = &quot;æ¸å˜è‰²&quot;, Modifier.align(Alignment.Center))
        }
        Spacer(modifier = Modifier.height(10.dp))
        Box(
            modifier = Modifier
                .size(100.dp)
                //è®¾ç½®åç§»é‡
                //.offset(50.dp, 50.dp)
                //offsetçš„é‡è½½æ–¹æ³•
                .offset { IntOffset(50.dp.roundToPx(), 50.dp.roundToPx()) }
                .background(color = Color.Yellow)
        )
    }
}

//ä¸¤ç§åˆ›å»ºæ¸å˜è‰²çš„æ–¹å¼
//æ–¹å¼ä¸€ç»™å®šé¢œè‰²åˆ—è¡¨ï¼Œé¢œè‰²å‡åŒ€åˆ†å¸ƒ
val verticalGradientBrush1 = Brush.verticalGradient(
    colors = listOf(Color.Red, Color.Yellow, Color.White)
)
//ç»™å®šåç§»é‡å’Œé¢œè‰²
val verticalGradientBrush2 = Brush.verticalGradient(
    //0-0.1æ˜¾ç¤ºçº¢è‰²
    0.1f to Color.Red,
    //0.1-0.3æ˜¾ç¤ºçº¢åˆ°ç»¿è‰²çš„æ¸å˜
    0.3f to Color.Green,
    //0.3-0.9æ˜¾ç¤ºç»¿è‰²åˆ°è“è‰²çš„æ¸å˜
    0.9f to Color.Blue
)

</code></pre>
<h2 id="3å…³äºscopseçš„ä¸¾ä¾‹è¯´æ˜">3.å…³äºScopseçš„ä¸¾ä¾‹è¯´æ˜</h2>
<p>åœ¨Composeæ‰€æä¾›çš„æ§ä»¶éƒ½æ˜¯æœ‰ä¸€ä¸ªcontentå‚æ•°ï¼Œè¿™å°±æ˜¯æ¯ä¸ªçš„ä½œç”¨åŸŸ</p>
<pre><code class="language-java">@Composable
inline fun Box(
    modifier: Modifier = Modifier,
    contentAlignment: Alignment = Alignment.TopStart,
    propagateMinConstraints: Boolean = false,
    content: @Composable BoxScope.() -&gt; Unit
) {
    val measurePolicy = rememberBoxMeasurePolicy(contentAlignment, propagateMinConstraints)
    Layout(
        content = { BoxScopeInstance.content() },
        measurePolicy = measurePolicy,
        modifier = modifier
    )
}
</code></pre>
<p>åœ¨ä¹‹å‰çš„Viewä½“ç³»ä¸­ï¼Œä¾‹å¦‚åœ¨xmlå¸ƒå±€ä¸­æˆ‘ä»¬å¯ä»¥ç»™ä¸€ä¸ªå­viewè®¾ç½®androidï¼šlayout_toRightå±æ€§ï¼Œå“ªæ€•å®ƒçš„å¤–å±‚å¸ƒå±€æ˜¯Linerlayoutå¸ƒå±€ï¼Œè¿™ä¸ªå±æ€§å¹¶ä¸ä¼šç”Ÿæ•ˆã€‚<br>
è€Œåœ¨Composeä¸­é€šè¿‡Scopeé™åˆ¶å¯¹åº”å±æ€§èƒ½å¤Ÿç”Ÿæ•ˆçš„èŒƒå›´,ä¸‹é¢æ˜¯BoxScopeçš„ä»£ç ï¼Œé€šè¿‡@LayoutScopeMarkerå…ƒæ³¨è§£ï¼Œé™¤äº†æ˜¯Modifierçš„å…¬å…±å±æ€§å¤–ï¼Œé‚£ä¹ˆåœ¨ç‰¹å®šScopeä¸­å®šä¹‰çš„æ–¹æ³•ï¼Œåªèƒ½åœ¨å¯¹åº”çš„ä½œç”¨åŸŸæ¥è°ƒç”¨ã€‚å°±åƒä¸‹é¢çš„BoxScopeï¼Œå®ƒå†…éƒ¨å®šä¹‰æœ‰ä¸¤ä¸ªæ–¹æ³•alignå’ŒmatchParentSizeï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªæ–¹æ³•åªèƒ½åœ¨BoxScopeä½œç”¨åŸŸå†…è°ƒç”¨ã€‚</p>
<pre><code class="language-java">@LayoutScopeMarker
@Immutable
interface BoxScope {
    /**
     * Pull the content element to a specific [Alignment] within the [Box]. This alignment will
     * have priority over the [Box]'s `alignment` parameter.
     */
    @Stable
    fun Modifier.align(alignment: Alignment): Modifier

    /**
     * Size the element to match the size of the [Box] after all other content elements have
     * been measured.
     *
     * The element using this modifier does not take part in defining the size of the [Box].
     * Instead, it matches the size of the [Box] after all other children (not using
     * matchParentSize() modifier) have been measured to obtain the [Box]'s size.
     * In contrast, a general-purpose [Modifier.fillMaxSize] modifier, which makes an element
     * occupy all available space, will take part in defining the size of the [Box]. Consequently,
     * using it for an element inside a [Box] will make the [Box] itself always fill the
     * available space.
     */
    @Stable
    fun Modifier.matchParentSize(): Modifier
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kotlinå…³é”®å­—by lazyä¸­çš„Modeåˆ†æ]]></title>
        <id>https://arms-merchants.github.io/post/kotlin-guan-jian-zi-by-lazy-zhong-de-mode-fen-xi/</id>
        <link href="https://arms-merchants.github.io/post/kotlin-guan-jian-zi-by-lazy-zhong-de-mode-fen-xi/">
        </link>
        <updated>2023-05-16T08:42:58.000Z</updated>
        <content type="html"><![CDATA[<pre><code class="language-java">    class TestManager private constructor(){
        companion object{
            val instance by lazy(LazyThreadSafetyMode.SYNCHRONIZED){
                TestManager()
            }
        }
    }
</code></pre>
<p>ä¸Šé¢ä»£ç æ˜¯å¸¸è§çš„Kotlinä¸­é€šè¿‡byå…³é”®å­—æ¥åˆ›å»ºå•ä¾‹å¯¹è±¡çš„å®ç°ï¼Œä½†lazyä¸­çš„Modeæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>
äº†è§£è¿™äº›ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆç®€å•åˆ†åˆ«è¯´ä¸‹lazyå’Œbyï¼Œå…¶ä¸­byæ˜¯Kotlinä¸­ç”¨äºå§”æ‰˜çš„å…³é”®å­—ï¼Œè€Œlazyæ˜¯ä¸€ä¸ªæ–¹æ³•ï¼Œå…¶è¿”å›å€¼æ˜¯å§”æ‰˜çš„å…·ä½“å¯¹è±¡ã€‚by lazyç”¨äºå®ç°æ•°æ®çš„æƒ°æ€§åŠ è½½ï¼Œåœ¨åˆå§‹åŒ–ä¸€ä¸ªå¸¸é‡æ—¶ç¡®ä¿å…¶ä¸ä¼šè¢«å¤šæ¬¡åˆå§‹åŒ–ã€‚<br>
LazyThreadSafetyModeçš„å€¼æœ‰ä¸‰ä¸ªï¼Œé€šè¿‡å®ƒæ¥ç¡®å®šå¯¹è±¡çš„åˆ›å»ºæ¨¡å¼ï¼š</p>
<ul>
<li>LazyThreadSafetyMode.SYNCHRONIZED</li>
<li>LazyThreadSafetyMode.PUBLICATION</li>
<li>LazyThreadSafetyMode.NONE</li>
</ul>
<p>lazyæ–¹æ³•é»˜è®¤æ˜¯ä½¿ç”¨SynchronizedLazyImplæ¥è¿”å›å§”æ‰˜çš„å…·ä½“å¯¹è±¡çš„ã€‚<br>
Lazyå®ç°äº†by lazyçš„æ–¹æ³•ï¼š</p>
<pre><code class="language-java">@kotlin.internal.InlineOnly
public inline operator fun &lt;T&gt; Lazy&lt;T&gt;.getValue(thisRef: Any?, property: KProperty&lt;*&gt;): T = value
</code></pre>
<p>ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„è·å–åˆ°çš„å€¼å°±æ˜¯è¿™ä¸ªvalueï¼Œé‚£ä¹ˆæˆ‘ä»¬å°±è¦æ¥çœ‹è¿™ä¸ªvalueæ˜¯æ€ä¹ˆè·å–åˆ°çš„ã€‚åˆ†æä¸‰ç§Modeä¸‹valueä¸åŒå–å€¼ï¼Œå¯ä»¥ç¡®å®šåç»­æˆ‘ä»¬åœ¨ä½¿ç”¨by lazyæ—¶åº”è¯¥ä½¿ç”¨é‚£ç§Modeï¼Œé¦–å…ˆå…ˆçœ‹SynchronizedLazyImplçš„å®ç°ï¼š</p>
<pre><code class="language-java">private class SynchronizedLazyImpl&lt;out T&gt;(initializer: () -&gt; T, lock: Any? = null) : Lazy&lt;T&gt;, Serializable {
    //lazyåçš„æ–¹æ³•ä½“ï¼Œè¿”å›å½“å‰éœ€è¦åˆ›å»ºçš„å¯¹è±¡
    private var initializer: (() -&gt; T)? = initializer
    //é»˜è®¤å€¼ï¼Œå®šä¹‰äº†ä¸€ä¸ªæœªåˆå§‹åŒ–çš„å€¼ï¼Œä¸ºäº†è§£å†³DCLå¸¦æ¥æŒ‡ä»¤é‡æ’åºå¯¼è‡´ä¸»å­˜å’Œå·¥ä½œå†…å­˜æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Œè¿™é‡Œä½¿ç”¨VolatileåŸè¯­æ³¨è§£ï¼Œçº¿ç¨‹å®‰å…¨
    @Volatile private var _value: Any? = UNINITIALIZED_VALUE
    //é”
    // final field is required to enable safe publication of constructed instance
    private val lock = lock ?: this

    override val value: T
        //è·å–valueçš„å€¼å°±æ˜¯é€šè¿‡getæ–¹æ³•
        get() {
            val _v1 = _value
            //å¦‚æœå½“å‰çš„å€¼å·²ç»ä¸æ˜¯æœªåˆå§‹åŒ–çš„äº†é‚£ä¹ˆç›´æ¥è¿”å›
            if (_v1 !== UNINITIALIZED_VALUE) {
                @Suppress(&quot;UNCHECKED_CAST&quot;)
                return _v1 as T
            }

            return synchronized(lock) {
                //åŒé‡æ£€æµ‹
                val _v2 = _value
                if (_v2 !== UNINITIALIZED_VALUE) {
                    @Suppress(&quot;UNCHECKED_CAST&quot;) (_v2 as T)
                } else {
                    //å¦‚æœæ²¡æœ‰åˆå§‹åŒ–ï¼Œé‚£ä¹ˆé€šè¿‡initializeræ¥è¿›è¡Œåˆå§‹åŒ–æ“ä½œ
                    val typedValue = initializer!!()
                    //å¹¶å°†è¿™ä¸ªå€¼ä¿å­˜åœ¨_valueä¸­
                    _value = typedValue
                    initializer = null
                    typedValue
                }
            }
        }

    override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE

    override fun toString(): String = if (isInitialized()) value.toString() else &quot;Lazy value not initialized yet.&quot;

    private fun writeReplace(): Any = InitializedLazyImpl(value)
}
</code></pre>
<p>SafePublicationLazyImplçš„å®ç°ï¼š</p>
<pre><code class="language-java">private class SafePublicationLazyImpl&lt;out T&gt;(initializer: () -&gt; T) : Lazy&lt;T&gt;, Serializable {
    @Volatile private var initializer: (() -&gt; T)? = initializer
    @Volatile private var _value: Any? = UNINITIALIZED_VALUE
    // this final field is required to enable safe initialization of the constructed instance
    private val final: Any = UNINITIALIZED_VALUE

    override val value: T
        get() {
            val value = _value
            if (value !== UNINITIALIZED_VALUE) {
                @Suppress(&quot;UNCHECKED_CAST&quot;)
                return value as T
            }
            val initializerValue = initializer
            // if we see null in initializer here, it means that the value is already set by another thread
            if (initializerValue != null) {
                   //å¦‚æœæ˜¯å¤šçº¿ç¨‹çš„è¯ï¼Œåˆå§‹åŒ–æ–¹æ³•ä¼šè°ƒç”¨å¤šæ¬¡
                val newValue = initializerValue()
                //é€šè¿‡CASä¿è¯åªæœ‰åœ¨åŸå§‹å€¼ä¸ºUNINITIALIZED_VALUEæ—¶èµ‹å€¼
                if (valueUpdater.compareAndSet(this, UNINITIALIZED_VALUE, newValue)) {
                    initializer = null
                    return newValue
                }
            }
            @Suppress(&quot;UNCHECKED_CAST&quot;)
            return _value as T
        }

    override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE

    override fun toString(): String = if (isInitialized()) value.toString() else &quot;Lazy value not initialized yet.&quot;

    private fun writeReplace(): Any = InitializedLazyImpl(value)

    companion object {
        private val valueUpdater = 
        //javaä¸­çš„åŸå­æ“ä½œ
        java.util.concurrent.atomic.AtomicReferenceFieldUpdater.newUpdater(
            SafePublicationLazyImpl::class.java,
            Any::class.java,
            &quot;_value&quot;
        )
    }
}
</code></pre>
<p>UnsafeLazyImplçš„å®ç°ï¼š</p>
<pre><code class="language-java">internal class UnsafeLazyImpl&lt;out T&gt;(initializer: () -&gt; T) : Lazy&lt;T&gt;, Serializable {
    private var initializer: (() -&gt; T)? = initializer
    private var _value: Any? = UNINITIALIZED_VALUE

    override val value: T
        get() {
            //åªæ˜¯æ˜¯æœªåˆå§‹åŒ–é‚£ä¹ˆå°±è°ƒç”¨åˆå§‹åŒ–æ–¹æ³•
            //å¤šçº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆå®ƒçš„å€¼ä¸ºæœ€åçš„èµ‹å€¼æ–¹æ³•ï¼Œçº¿ç¨‹ä¸å®‰å…¨
            if (_value === UNINITIALIZED_VALUE) {
                _value = initializer!!()
                initializer = null
            }
            @Suppress(&quot;UNCHECKED_CAST&quot;)
            return _value as T
        }

    override fun isInitialized(): Boolean = _value !== UNINITIALIZED_VALUE

    override fun toString(): String = if (isInitialized()) value.toString() else &quot;Lazy value not initialized yet.&quot;

    private fun writeReplace(): Any = InitializedLazyImpl(value)
}
</code></pre>
<p>ç»è¿‡ä¸Šé¢çš„æºç åˆ†æï¼Œæˆ‘ä»¬ä¸éš¾çœ‹å‡ºä¸‰ç§Modeçš„åŒºåˆ«ï¼š</p>
<ul>
<li>LazyThreadSafetyMode.SYNCHRONIZED é€šè¿‡synchronizedå…³é”®å€¼åˆ›å»ºåŒæ­¥é”æ¥å®ç°çº¿ç¨‹å®‰å…¨</li>
<li>LazyThreadSafetyMode.PUBLICATION é€šè¿‡CASæ¥ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œå¤šçº¿ç¨‹çš„æƒ…å†µä¸‹åˆå§‹åŒ–æ–¹æ³•ä¼šè°ƒç”¨ï¼Œä½†åªæœ‰ä¸€ä¸ªç”Ÿæ•ˆã€‚</li>
<li>LazyThreadSafetyMode.NONEï¼Œåªè¦æ ‡è¯†ä¸ºæœªåˆå§‹åŒ–å°±è°ƒç”¨åˆå§‹åŒ–æ¥èµ‹å€¼ï¼Œçº¿ç¨‹ä¸å®‰å…¨ã€‚</li>
</ul>
<p>æ‰€ä»¥ç»è¿‡ä¸Šé¢çš„åˆ†æï¼Œåœ¨ç¡®å®šå½“å‰å±æ€§ä¸ä¼šåœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«çš„æ—¶å€™ï¼Œåˆ™å¯ä»¥ä½¿ç”¨NONEæ¨¡å¼ï¼Œè¿™æ˜¯æœ€å¿«çš„æ¨¡å¼ï¼Œä½†ä¹Ÿæ˜¯æœ€ä¸å®‰å…¨çš„æ¨¡å¼ã€‚<br>
å¦‚æœå±æ€§æ˜¯è¦åœ¨å¤šä¸ªçº¿ç¨‹é—´å…±äº«ï¼Œé‚£ä¹ˆä½¿ç”¨SYNCHRONIZEDå’ŒPUBLICATIONï¼Œä½†å› ä¸ºSYNCHRONIZEDå¼•å…¥äº†é”çš„æœºåˆ¶ï¼Œå®ƒæ˜¯æœ€å®‰å…¨çš„ï¼Œä½†ä¹Ÿæ˜¯æœ€æ…¢çš„æ¨¡å¼ã€‚æŠ˜ä¸­çš„è¯åˆ™å¯ä»¥ä½¿ç”¨PUBLICATIONã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¯¹Closeableçš„è‡ªåŠ¨å…³é—­å¤„ç†ï¼Œè¯­æ³•ğŸ¬]]></title>
        <id>https://arms-merchants.github.io/post/dui-closeable-de-zi-dong-guan-bi-chu-li-yu-fa/</id>
        <link href="https://arms-merchants.github.io/post/dui-closeable-de-zi-dong-guan-bi-chu-li-yu-fa/">
        </link>
        <updated>2022-06-14T01:30:07.000Z</updated>
        <content type="html"><![CDATA[<p>é¦–å…ˆçœ‹ä¸€æ®µç¤ºä¾‹ä»£ç ï¼š</p>
<pre><code class="language-java"> FileInputStream fis = null;
        try {
            fis = new FileInputStream(&quot;&quot;);
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        } finally {
            try {
                fis.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
</code></pre>
<p>ä¸€æ®µåŸºæœ¬æ“ä½œï¼Œå¯¹æ–‡ä»¶æµè¿›è¡Œæ“ä½œé‚£ä¹ˆä¸è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥æœ€å¥½éƒ½è¦è¿›è¡Œæ–‡ä»¶æµçš„å…³é—­ã€‚ä¸è¿‡è¿™æ ·çš„ä»£ç ç¡®å®æŒºæ ·æ¿çš„ã€‚æˆ‘ä»¬çœ‹ä¸‹javaå’Œkotlinå¯¹è¿™ä¸­æ ·æœ¬ä»£ç æ¶ˆé™¤çš„è¯­æ³•ç³–å®ç°ã€‚</p>
<h2 id="1javaçš„å®ç°">1.javaçš„å®ç°</h2>
<pre><code class="language-java">     try (FileInputStream fis = new FileInputStream(&quot;file_path&quot;);
             FileOutputStream fos = new FileOutputStream(&quot;file_path&quot;)) {
            byte[] bytes = new byte[1024];
            while ( fis.read(bytes) != -1) {
                fos.write(bytes);
            }
        } catch (IOException e) {
            e.printStackTrace();
        }
</code></pre>
<p>è·ŸåŸæ¥çš„å†™æ³•å”¯ä¸€çš„åŒºåˆ«å°±æ˜¯å°†Closeableå¯¹è±¡çš„å£°æ˜æ˜¯åœ¨tryåçš„æ‹¬å·å†…,å¹¶ä¸”å¯ä»¥é€šè¿‡ï¼›æ¥è¿›è¡Œåˆ†å‰²å£°æ˜å¤šä¸ªCloseableå¯¹è±¡ï¼Œåœ¨tryåŒ…è£¹å†…çš„ä»£ç æ‰§è¡Œå®Œåéƒ½ä¼šè¢«è‡ªåŠ¨closeæ‰ã€‚</p>
<h2 id="2kotlinçš„å®ç°">2.kotlinçš„å®ç°</h2>
<pre><code class="language-java">   val fis = FileInputStream(&quot;file_path&quot;)
    fis.use { 
        fis.read()
    }
</code></pre>
<p>é€šè¿‡ä½¿ç”¨useæ“ä½œç¬¦æ¥å®ç°è‡ªåŠ¨å…³é—­Closeableå¯¹è±¡ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹useçš„æºç ï¼š</p>
<pre><code class="language-java">@InlineOnly
@RequireKotlin(&quot;1.2&quot;, versionKind = RequireKotlinVersionKind.COMPILER_VERSION, message = &quot;Requires newer compiler version to be inlined correctly.&quot;)
public inline fun &lt;T : Closeable?, R&gt; T.use(block: (T) -&gt; R): R {
    contract {
        callsInPlace(block, InvocationKind.EXACTLY_ONCE)
    }
    var exception: Throwable? = null
    try {
        return block(this)
    } catch (e: Throwable) {
        exception = e
        throw e
    } finally {
        when {
            apiVersionIsAtLeast(1, 1, 0) -&gt; this.closeFinally(exception)
            this == null -&gt; {}
            exception == null -&gt; close()
            else -&gt;
                try {
                    close()
                } catch (closeException: Throwable) {
                    // cause.addSuppressed(closeException) // ignored here
                }
        }
    }
}
</code></pre>
<p>ä¸€ä¸ªé«˜é˜¶çš„å†…è”å‡½æ•°ï¼Œæœ€ç»ˆéƒ½æ˜¯é€šè¿‡finallyä¸­è¿›è¡Œå…³é—­æ“ä½œã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[NDKå¼€å‘-ä½¿ç”¨FMODè¿›è¡Œå˜å£°]]></title>
        <id>https://arms-merchants.github.io/post/ndk-kai-fa-shi-yong-fmod-jin-xing-bian-sheng/</id>
        <link href="https://arms-merchants.github.io/post/ndk-kai-fa-shi-yong-fmod-jin-xing-bian-sheng/">
        </link>
        <updated>2022-04-28T03:30:02.000Z</updated>
        <content type="html"><![CDATA[<p>FMODä¸€æ¬¾å¼ºå¤§çš„è¯­éŸ³å¼•æ“ï¼Œç­‰åŒäºè§†é¢‘å±Šçš„FFMPEG.å¯ä»¥è¿›è¡ŒéŸ³é¢‘çš„å¤šç§ä¿®æ”¹å’Œè®¾ç½®ï¼Œå®ƒæœ‰æä¾›å®¢æˆ·ç«¯æ¥è¿›è¡Œç›´æ¥ä½¿ç”¨ï¼Œä¸è¿‡ä»Šå¤©æˆ‘ä»¬é€šè¿‡é›†æˆAPIæ¥å®ç°å‡ ä¸ªç®€å•çš„å˜éŸ³æ•ˆæœã€‚</p>
<h2 id="1ndké…ç½®">1.NDKé…ç½®</h2>
<p>ç°åœ¨éœ€è¦æ³¨æ„çš„æ˜¯åœ¨æ–°ç‰ˆæœ¬çš„AndroidStudioä¸­å·²ç»ä¸æ”¯æŒåœ¨local.propertiesè®¾ç½®ä¸­è®¾ç½®ndk.dirçš„é…ç½®æ¥è®¾ç½®ä½¿ç”¨çš„NDKç‰ˆæœ¬ï¼Œå¦‚æœéœ€è¦é…ç½®çš„è¯é€šè¿‡ä¸‹é¢çš„æ–¹å¼ï¼š</p>
<pre><code class="language-java">android{
    ndkVersion &quot;major.minor.build&quot; //ndkVersion &quot;21.3.6528147&quot;
}
</code></pre>
<p>å¦‚æœä¸æŒ‡å®šçš„è¯é‚£ä¹ˆé»˜è®¤é‡‡ç”¨å½“å‰AGPæ”¯æŒçš„æœ€é«˜ç‰ˆæœ¬ã€‚<br>
å¯¼å…¥fmodçš„æ–‡ä»¶ï¼Œè¿™é‡ŒåŒ…æ‹¬ä¸¤ä¸ªéƒ¨åˆ†ï¼Œä¸€ä¸ªæ˜¯åŠ¨æ€åº“ï¼ˆsoåº“ï¼‰ï¼Œä¸€ä¸ªæ˜¯å¤´æ–‡ä»¶<br>
é€šè¿‡å¤´æ–‡ä»¶æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨å¯¹åº”çš„fmodçš„æ–¹æ³•äº†ã€‚<br>
å°†fmodçš„incå¤´æ–‡ä»¶æ‹·è´åˆ°cppç›®å½•ä¸‹ï¼Œå°†soåº“æ‹·è´åˆ°jinLibsï¼ˆé»˜è®¤ï¼Œä¹Ÿå¯ä»¥æ˜¯æŒ‡å®šçš„soåº“ç›®å½•ï¼‰<br>
ä¿®æ”¹é»˜è®¤çš„CMakeLists.txtæ–‡ä»¶ï¼š</p>
<pre><code class="language-java">#æ‰¹é‡å¯¼å…¥æºæ–‡ä»¶ï¼Œé¿å…è¿˜éœ€è¦ä¸€ä¸ªä¸ªçš„å¯¼å…¥æºæ–‡ä»¶
file(GLOB allCPP *.c *.h *.cpp)

add_library( # Sets the name of the library.
        native-lib

        # Sets the library as a shared library.
         #SHARED è¡¨ç¤ºè¿™ä¸ªåº“æ˜¯ä¸€ä¸ªåŠ¨æ€åº“ STATICè¡¨ç¤ºè¿™ä¸ªåº“æ˜¯ä¸€ä¸ªé™æ€åº“ï¼ŒåŠ¨æ€åº“æ˜¯ä»¥.soæ–‡ä»¶ç»“å°¾ é™æ€åº“æ˜¯ä»¥.aç»“å°¾ï¼Œå¹¶ä¸”Androidçš„è¯
        #åœ¨æ‰“åŒ…çš„æœ€ååªä¼šåŒ…å«æœ‰åŠ¨æ€åº“ï¼Œå› ä¸ºå¦‚æœæ˜¯é™æ€åº“çš„è¯é‚£ä¹ˆä¼šå°†å¯¹åº”çš„ä»£ç æ‹·è´åˆ°å¯¹åº”çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯åœ¨è¿è¡Œçš„æ—¶å€™ä¸éœ€è¦é™æ€åº“äº†ï¼Œè€ŒåŠ¨æ€åº“å¯¹åº”çš„éƒ½æ˜¯é€šè¿‡åœ°å€
        #æ¥è¿›è¡Œé“¾æ¥çš„ï¼Œé‚£ä¹ˆåº“æ–‡ä»¶è¿˜æ˜¯éœ€è¦çš„
        SHARED

        # Provides a relative path to your source file(s).
        //æ³¨æ„è¿™é‡Œçš„åç§°è¦å’Œä¸Šé¢æ‰¹é‡å¯¼å…¥çš„åç§°ä¸€è‡´
        ${allCPP}
        )

#å¯¼å…¥åº“æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸‰æ–¹çš„soï¼Œä¸è¿‡éœ€è¦æ³¨æ„è¿™ä¸ªæ˜¯éœ€è¦åœ¨jniLibsä¸­æœ‰å¯¹åº”æ–‡ä»¶å¤¹åæ‰èƒ½ç”Ÿæ•ˆï¼Œä¸ç„¶ä¼šåœ¨ç¼–è¯‘é˜¶æ®µæŠ¥é”™
set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -L${CMAKE_SOURCE_DIR}/../jniLibs/${CMAKE_ANDROID_ARCH_ABI}&quot;)
</code></pre>
<h2 id="2æ·»åŠ fmodçš„å¤´æ–‡ä»¶å’Œåº“">2.æ·»åŠ FMODçš„å¤´æ–‡ä»¶å’Œåº“</h2>
<p>å°†ä¸‹è½½çš„FMODä¸­å¯¹åº”çš„å¤´æ–‡ä»¶æ–‡ä»¶å¤¹incæ‹·è´åˆ°cppç›®å½•ä¸‹ï¼Œåœ¨jniLibsä¸­æ‹·è´éœ€è¦ä½¿ç”¨åˆ°çš„çš„æ¶æ„ç›®å½•ã€‚<br>
åœ¨CMakeLists.txtä¸­æ·»åŠ é…ç½®ä¿¡æ¯ï¼š</p>
<pre><code class="language-java">#æ‰¹é‡å¯¼å…¥å¤´æ–‡ä»¶,æ³¨æ„å¯¹åº”çš„ç›®å½•ï¼Œå½“å‰çš„æ ¹ç›®å½•æ˜¯CMakeLists.txtæ‰€åœ¨çš„ç›®å½•
include_directories(&quot;inc&quot;)
#é“¾æ¥å¯¹åº”çš„åº“æ–‡ä»¶
target_link_libraries( # Specifies the target library.
        native-lib

        # Links the target library to the log library
        # included in the NDK.
        ${log-lib}
        fmod
        fmodL
        )
</code></pre>
<p>å®Œæ•´çš„CMakeLists.txtæ–‡ä»¶ï¼š</p>
<pre><code class="language-java"># For more information about using CMake with Android Studio, read the
# documentation: https://d.android.com/studio/projects/add-native-code.html

# Sets the minimum version of CMake required to build the native library.

cmake_minimum_required(VERSION 3.10.2)

# Declares and names the project.

project(&quot;ndktest&quot;)

# Creates and names a library, sets it as either STATIC
# or SHARED, and provides the relative paths to its source code.
# You can define multiple libraries, and CMake builds them for you.
# Gradle automatically packages shared libraries with your APK.

#æ‰¹é‡å¯¼å…¥å¤´æ–‡ä»¶
include_directories(&quot;inc&quot;)
#æ‰¹é‡å¯¼å…¥æºæ–‡ä»¶
file(GLOB allCPP *.c *.h *.cpp)

add_library( # Sets the name of the library.
        native-lib

        # Sets the library as a shared library.
        SHARED

        # Provides a relative path to your source file(s).
        ${allCPP}
        )
#å¯¼å…¥åº“æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯ä¸‰æ–¹çš„so
set(CMAKE_CXX_FLAGS &quot;${CMAKE_CXX_FLAGS} -L${CMAKE_SOURCE_DIR}/../jniLibs/${CMAKE_ANDROID_ARCH_ABI}&quot;)

# Searches for a specified prebuilt library and stores the path as a
# variable. Because CMake includes system libraries in the search path by
# default, you only need to specify the name of the public NDK library
# you want to add. CMake verifies that the library exists before
# completing its build.

find_library( # Sets the name of the path variable.
        log-lib

        # Specifies the name of the NDK library that
        # you want CMake to locate.
        log)

# Specifies libraries CMake should link to your target library. You
# can link multiple libraries, such as libraries you define in this
# build script, prebuilt third-party libraries, or system libraries.

target_link_libraries( # Specifies the target library.
        native-lib

        # Links the target library to the log library
        # included in the NDK.
        ${log-lib}
        fmod
        fmodL
        )
</code></pre>
<h2 id="3å‡†å¤‡éœ€è¦ç¼–è¾‘çš„éŸ³é¢‘æ–‡ä»¶">3.å‡†å¤‡éœ€è¦ç¼–è¾‘çš„éŸ³é¢‘æ–‡ä»¶</h2>
<p>è¿™é‡Œæˆ‘ç›´æ¥å‡†å¤‡äº†ä¸€ä¸ªmp3æ–‡ä»¶æ¥è¿›è¡Œç¼–è¾‘ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è¿›è¡Œå½•åˆ¶åç¼–è¾‘ã€‚åœ¨assetsç›®å½•ä¸­æ”¾å…¥mp3æ–‡ä»¶ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿æ“ä½œï¼Œä½¿ç”¨okioå°†æ–‡ä»¶æ‹·è´åˆ°cacheç›®å½•æ“ä½œï¼Œè¿™æ ·ä¹Ÿä¸éœ€è¦è¿›è¡Œæƒé™çš„ç”³è¯·ã€‚</p>
<pre><code class="language-java">    implementation 'com.squareup.okio:okio:2.10.0'
</code></pre>
<p>æ‹·è´æ–‡ä»¶ï¼š</p>
<pre><code class="language-java">    private fun copyFile(): String {
        //å°†assetsç›®å½•ä¸‹çš„æ–‡ä»¶æ‹·è´åˆ°åº”ç”¨çš„cacheç›®å½•ä¸‹ï¼Œè¿™é‡Œçš„sourceæ˜¯okioçš„æ‰©å±•æ–¹æ³•
        val targetFile = File(this.cacheDir, &quot;test.mp3&quot;)
        //ä½¿ç”¨useæ¥è‡ªåŠ¨å…³é—­å®ç°Closeableçš„å¯¹è±¡
        this.assets.open(&quot;test.mp3&quot;).source().use { source -&gt;
            targetFile.sink().buffer().use {
                it.writeAll(source)
            }
        }
        return targetFile.path;
    }
</code></pre>
<h2 id="4ä½¿ç”¨ndkå®ç°å¯¹åº”çš„æ–¹æ³•è°ƒç”¨">4.ä½¿ç”¨NDKå®ç°å¯¹åº”çš„æ–¹æ³•è°ƒç”¨</h2>
<pre><code class="language-c++">#include &lt;jni.h&gt;
#include &lt;string&gt;

#include &lt;fmod.hpp&gt;

#include &quot;Student.h&quot;

using namespace std;
using namespace FMOD;

//androidçš„logæ‰“å°éœ€è¦å¯¼å…¥çš„å¤´æ–‡ä»¶P
#include &lt;android/log.h&gt;
#include &lt;unistd.h&gt;
#include &lt;pthread.h&gt;
//å®å®šä¹‰
#define LOG_TAG &quot;ARM_NDK&quot;
//...çš„å‚æ•°ç”±__VA_ARGS__æ¥è¿›è¡Œç¡®è®¤
#define LOGE(...) __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__);
#define LOGI(...) __android_log_print(ANDROID_LOG_INFO,LOG_TAG,__VA_ARGS__);

#undef MODE_NORMAL
#define MODE_NORMAL 0
#undef MODE_FUNNY
#define MODE_FUNNY 1
#undef MODE_UNCLE
#define MODE_UNCLE 2
#undef MODE_LOLITA
#define MODE_LOLITA 3
#undef MODE_ROBOT
#define MODE_ROBOT 4
#undef MODE_ETHEREAL
#define MODE_ETHEREAL 5
#undef MODE_CHORUS
#define MODE_CHORUS 6
#undef MODE_HORROR
#define MODE_HORROR 7

extern &quot;C&quot; {
//å› ä¸ºcppæ˜¯C++ï¼Œå¦‚æœè¦å¯¼å…¥cçš„ä»£ç ï¼Œéœ€è¦ä½¿ç”¨cçš„è¯­è¨€ç¯å¢ƒ
};

extern &quot;C&quot; JNIEXPORT
jstring JNICALL
Java_com_arms_ndktest_MainActivity_stringFromJNI(
        JNIEnv
        *env,
        jobject /* this */) {
    string hello = &quot;Hello from C++&quot;;
    LOGE(&quot;æµ‹è¯•æ‰“å°&quot;);
    auto *student = new Student(&quot;haha&quot;, 21);
    const char *str = student-&gt;getName().c_str();
    LOGE(&quot;%s&quot;, str);
    delete student;
    return env-&gt;
            NewStringUTF(hello.c_str());
}

//æ²¡æœ‰è¿”å›å€¼çš„JNIæ–¹æ³•,éé™æ€æ–¹æ³•ï¼Œéé™æ€æ–¹æ³•çš„è¯è¿™é‡Œæ˜¯jobject
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_MainActivity_testNoReturnFromJNI(JNIEnv
                                                       *env,
                                                       jobject thiz
) {
    //å¦‚æœæ˜¯ä»javaå±‚ä¼ å…¥çš„æ•°ç»„ï¼Œé‚£ä¹ˆç›´æ¥ä¿®æ”¹æ“ä½œåªä¼šåœ¨c++å±‚ç”Ÿæ•ˆï¼Œä¸ä¼šæ”¹å˜javaå±‚çš„æ•°æ®
    jintArray jintArray1;
    int length = env-&gt;GetArrayLength(jintArray1);

    int *pInt = env-&gt;GetIntArrayElements(jintArray1, NULL);
    for (int i = 0; i &lt; length; i++) {
        *(pInt + i) += 100;
    }
    //é€šè¿‡ä¸‹é¢çš„æ“ä½œæ†æ¥è¾¾åˆ°ä¿®æ”¹å¯¹åº”javaçš„æ•°æ®ï¼Œmodeçš„æ¨¡å¼0 åˆ·æ–°javaæ•°ç»„ï¼Œé‡Šæ”¾C++å±‚æ•°ç»„ JNI_COMMIT:åªæäº¤åªåˆ·æ–°Javaæ•°ç»„ï¼Œä¸é‡Šæ”¾C++,JNI_ABORT:åªé‡Šæ”¾C++å±‚æ•°æ®
    env-&gt;ReleaseIntArrayElements(jintArray1, pInt, 0);
}
//ä¸€ä¸ªæµ‹è¯•æ–¹æ³•ï¼Œä½¿ç”¨c++æ¥æ„å»ºä¸€ä¸ªjavaçš„å¯¹è±¡ï¼Œå¹¶è®¾ç½®å…¶ä¸­çš„å‚æ•°
void test(JNIEnv *env) {

    const char *className = &quot;com/arms/ndktest/PeopleBean&quot;;

    jclass pJclass = env-&gt;FindClass(className);
    //è¿™ç§æ–¹å¼ä¸ä¼šè°ƒç”¨æ„é€ æ–¹æ³•
    jobject pJobject = env-&gt;AllocObject(pJclass);
    //è¿™ç§æ–¹å¼ï¼Œè¯´ç™½äº†å°±æ˜¯è¦ä¼ å…¥ä¸€ä¸ªæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯æ„é€ æ–¹æ³•ä»è€Œæ¥æ‰§è¡ŒæŒ‡å®šçš„æ„é€ æ–¹æ³•
    jmethodID pJmethodId = env-&gt;GetMethodID(pJclass, &quot;&lt;init&gt;&quot;, &quot;()V&quot;);
    jobject object = env-&gt;NewObject(pJclass, pJmethodId);

    jmethodID setNameMethod = env-&gt;GetMethodID(pJclass, &quot;setName&quot;, &quot;(Ljava/lang/String;)V&quot;);
    jmethodID setAageMethod = env-&gt;GetMethodID(pJclass, &quot;setAge&quot;, &quot;(I)V&quot;);

    jstring nameValue = env-&gt;NewStringUTF(&quot;123&quot;);

    env-&gt;CallVoidMethod(pJobject, setNameMethod, nameValue);
    env-&gt;CallVoidMethod(pJobject, setAageMethod, 11);

    env-&gt;DeleteLocalRef(pJclass);
    env-&gt;DeleteLocalRef(pJobject);
}

/**
æœ€å¼€å§‹åœ¨MainActivityä¸­æ¥å®ç°å¯¹åº”çš„æ–¹æ³•ï¼Œå‡ºå…¥å‚æ•°ä¸ºæ’­æ”¾çš„æ¨¡å¼ä»¥åŠå¯¹åº”çš„éŸ³é¢‘æ–‡ä»¶è·¯å¾„
*/
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_MainActivity_voiceChangeNative(JNIEnv *env, jobject thiz, jint mode,
                                                     jstring path) {
    char *content_ = &quot;æ’­æ”¾å®Œæ¯•&quot;;
    const char *path_ = env-&gt;GetStringUTFChars(path, NULL);
    LOGE(&quot;mode:%d&quot;, mode);
    System *system = 0;
    Sound *sound = 0;
    Channel *channel = 0;
    DSP *dsp = 0;
    System_Create(&amp;system);
    system-&gt;init(32, FMOD_INIT_NORMAL, 0);
    system-&gt;createSound(path_, FMOD_DEFAULT, 0, &amp;sound);
    system-&gt;playSound(sound, 0, false, &amp;channel);
    switch (mode) {
        case 1:
            content_ = &quot;åŸå£°æ’­æ”¾&quot;;
            break;
        case 2:
            content_ = &quot;èè‰æ’­æ”¾&quot;;
            system-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
            dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 2.0f);
            channel-&gt;addDSP(0, dsp);
            break;
        case 3:
            content_ = &quot;å¤§å”æ’­æ”¾&quot;;
            // éŸ³è°ƒä½ -- å¤§å” 0.7
            // 1.åˆ›å»ºDSPç±»å‹çš„Pitch éŸ³è°ƒæ¡ä»¶
            system-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
            // 2.è®¾ç½®PitchéŸ³è°ƒè°ƒèŠ‚2.0
            dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 0.7f);
            // 3.æ·»åŠ éŸ³æ•ˆè¿›å» éŸ³è½¨
            channel-&gt;addDSP(0, dsp);
            break;
        case 4:
            content_ = &quot;ææ€ªæ’­æ”¾&quot;;
            // å°é»„äººå£°éŸ³ é¢‘ç‡å¿«

            // ä»éŸ³è½¨æ‹¿ å½“å‰ é¢‘ç‡
            float mFrequency;
            channel-&gt;getFrequency(&amp;mFrequency);

            // ä¿®æ”¹é¢‘ç‡
            channel-&gt;setFrequency(mFrequency * 1.5f); // é¢‘ç‡åŠ å¿«  å°é»„äººçš„å£°éŸ³
            break;
        case 5:
            content_ = &quot;æƒŠæ‚šæ’­æ”¾&quot;;
            // TODO éŸ³è°ƒä½
            // éŸ³è°ƒä½ -- å¤§å” 0.7
            // 1.åˆ›å»ºDSPç±»å‹çš„Pitch éŸ³è°ƒæ¡ä»¶
            system-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
            // 2.è®¾ç½®PitchéŸ³è°ƒè°ƒèŠ‚2.0
            dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 0.7f);
            // 3.æ·»åŠ éŸ³æ•ˆè¿›å» éŸ³è½¨
            channel-&gt;addDSP(0, dsp); // ç¬¬ä¸€ä¸ªéŸ³è½¨

            // TODO æç‚¹å›å£°
            // å›éŸ³ ECHO
            system-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
            dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 200); // å›éŸ³ å»¶æ—¶    to 5000.  Default = 500.
            dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 10); // å›éŸ³ è¡°å‡åº¦ Default = 50   0 å®Œå…¨è¡°å‡äº†
            channel-&gt;addDSP(1, dsp); // ç¬¬äºŒä¸ªéŸ³è½¨

            // TODO é¢¤æŠ–
            // Tremolo é¢¤æŠ–éŸ³ æ­£å¸¸5    éå¸¸é¢¤æŠ–  20
            system-&gt;createDSPByType(FMOD_DSP_TYPE_TREMOLO, &amp;dsp);
            dsp-&gt;setParameterFloat(FMOD_DSP_TREMOLO_FREQUENCY, 20); // éå¸¸é¢¤æŠ–
            dsp-&gt;setParameterFloat(FMOD_DSP_TREMOLO_SKEW, 0.8f); // ï¼Ÿï¼Ÿï¼Ÿ
            channel-&gt;addDSP(2, dsp); // ç¬¬ä¸‰ä¸ªéŸ³è½¨
            break;
        case 6:
            content_ = &quot;ç©ºçµæ’­æ”¾&quot;;
            // å›éŸ³ ECHO
            system-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
            dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 200); // å›éŸ³ å»¶æ—¶    to 5000.  Default = 500.
            dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 10); // å›éŸ³ è¡°å‡åº¦ Default = 50   0 å®Œå…¨è¡°å‡äº†
            channel-&gt;addDSP(0, dsp);
            break;
    }
    bool isPlayer = true;
    while (isPlayer) {
        channel-&gt;isPlaying(&amp;isPlayer);
        usleep(1000 * 1000);
    }
    sound-&gt;release();
    system-&gt;close();
    system-&gt;release();
    env-&gt;ReleaseStringUTFChars(path, path_);
}

Channel *channel = 0;

extern &quot;C&quot;
JNIEXPORT jint JNICALL
Java_com_arms_ndktest_FmodSound_saveSound(JNIEnv *env, jobject cls, jstring path_jstr, jint type,
                                          jstring save_jstr) {
    Sound *sound;
    DSP *dsp;
    bool playing = true;
    float frequency = 0;
    System *mSystem;
    JNIEnv *mEnv = env;
    int code = 0;
    System_Create(&amp;mSystem);
    const char *path_cstr = mEnv-&gt;GetStringUTFChars(path_jstr, NULL);
    LOGI(&quot;saveAiSound-%s&quot;, path_cstr);
    const char *save_cstr;
    if (save_jstr != NULL) {
        save_cstr = mEnv-&gt;GetStringUTFChars(save_jstr, NULL);
        LOGI(&quot;saveAiSound-save_path=%s&quot;, save_cstr)
    }
    try {
        if (save_jstr != NULL) {
            char cDest[200];
            strcpy(cDest, save_cstr);
            mSystem-&gt;setSoftwareFormat(8000, FMOD_SPEAKERMODE_MONO, 0); //è®¾ç½®é‡‡æ ·ç‡ä¸º8000ï¼Œchannelä¸º1
            mSystem-&gt;setOutput(FMOD_OUTPUTTYPE_WAVWRITER); //ä¿å­˜æ–‡ä»¶æ ¼å¼ä¸ºWAV
            mSystem-&gt;init(32, FMOD_INIT_NORMAL, cDest);
            mSystem-&gt;recordStart(0, sound, true);
        }
        //åˆ›å»ºå£°éŸ³
        mSystem-&gt;createSound(path_cstr, FMOD_DEFAULT, NULL, &amp;sound);
        mSystem-&gt;playSound(sound, 0, false, &amp;channel);
        LOGI(&quot;saveAiSound-%s&quot;, &quot;save_start&quot;)
        switch (type) {
            case MODE_NORMAL:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_NORMAL&quot;);
                break;
            case MODE_FUNNY:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_FUNNY&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_NORMALIZE, &amp;dsp);
                channel-&gt;getFrequency(&amp;frequency);
                frequency = frequency * 1.6;
                channel-&gt;setFrequency(frequency);
                break;
            case MODE_UNCLE:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_UNCLE&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 0.8);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_LOLITA:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_LOLITA&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_PITCHSHIFT, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_PITCHSHIFT_PITCH, 1.8);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_ROBOT:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_ROBOT&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 50);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 60);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_ETHEREAL:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_ETHEREAL&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 300);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 20);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_CHORUS:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_CHORUS&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_ECHO, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_DELAY, 100);
                dsp-&gt;setParameterFloat(FMOD_DSP_ECHO_FEEDBACK, 50);
                channel-&gt;addDSP(0, dsp);
                break;
            case MODE_HORROR:
                LOGI(&quot;saveAiSound-%s&quot;, &quot;save MODE_HORROR&quot;)
                mSystem-&gt;createDSPByType(FMOD_DSP_TYPE_TREMOLO, &amp;dsp);
                dsp-&gt;setParameterFloat(FMOD_DSP_TREMOLO_SKEW, 0.8);
                channel-&gt;addDSP(0, dsp);
                break;
            default:
                break;
        }
        mSystem-&gt;update();
    } catch (...) {
        LOGE(&quot;saveAiSound-%s&quot;, &quot;save error!&quot;)
        code = 1;
        goto end;
    }
    while (playing) {
        usleep(1000);
        channel-&gt;isPlaying(&amp;playing);
    }
    LOGI(&quot;saveAiSound-%s&quot;, &quot;save over!&quot;)
    goto end;
    end:
    if (path_jstr != NULL) {
        mEnv-&gt;ReleaseStringUTFChars(path_jstr, path_cstr);
    }
    if (save_jstr != NULL) {
        mEnv-&gt;ReleaseStringUTFChars(save_jstr, save_cstr);
    }
    sound-&gt;release();
    mSystem-&gt;close();
    mSystem-&gt;release();
    return code;
}

extern &quot;C&quot;
JNIEXPORT jint JNICALL
Java_com_arms_ndktest_FmodSound_playSound(JNIEnv *env, jobject thiz, jstring path, jint type) {
}
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_FmodSound_stopPlay(JNIEnv *env, jobject thiz) {
    channel-&gt;stop();
}
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_FmodSound_resumePlay(JNIEnv *env, jobject thiz) {
    channel-&gt;stop();
    //æ£€æµ‹å½“å‰çš„envæ‰§è¡Œè¿‡ç¨‹æ˜¯å¦æœ‰å¼‚å¸¸å‘ç”Ÿ
    jthrowable pJthrowable = env-&gt;ExceptionOccurred();
    if (pJthrowable) {
        //ä¸»åŠ¨æ¸…é™¤å¼‚å¸¸
        env-&gt;ExceptionClear();
        //JNIä¸­ä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸
        jclass throwClass = env-&gt;FindClass(&quot;java/lang/NoSuchFieldError&quot;);
        env-&gt;ThrowNew(throwClass, &quot;dfsdf&quot;);
    }
}
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_FmodSound_pausePlay(JNIEnv *env, jobject thiz) {
    channel-&gt;stop();
}
extern &quot;C&quot;
JNIEXPORT jboolean JNICALL
Java_com_arms_ndktest_FmodSound_isPlaying(JNIEnv *env, jobject thiz) {
    bool isPlaying = false;
    channel-&gt;isPlaying(&amp;isPlaying);
    return isPlaying;
}

JavaVM *javaVm = nullptr;

/**
 * JNIEnv *env ä¸èƒ½è·¨è¶Šçº¿ç¨‹ï¼Œå¯ä»¥è·¨è¶Šå‡½æ•°  è§£å†³æ–¹æ¡ˆé€šè¿‡JavaVM.attchCurrentThreadè·å–å­çº¿ç¨‹çš„JNIEnv
 * jobject thiz ä¸èƒ½è·¨è¶Šçº¿ç¨‹å’Œå‡½æ•°  è¿™ä¸ªé€šè¿‡æå‡ä¸ºå…¨å±€å˜é‡æ¥è§£å†³
 * JavaVM *javaVm å¯ä»¥è·¨è¶Šçº¿ç¨‹å’Œå‡½æ•°
 *
 * åŠ¨æ€æ³¨å†Œçš„ä»£ç 
 * @param javaVm
 * @return
 */
JNIEXPORT jint JNI_OnLoad(JavaVM *javaVm, void *) {
    //::javaVm = javaVm;
    JNIEnv *jniEnv = nullptr;
    int result = javaVm-&gt;GetEnv(reinterpret_cast&lt;void **&gt;(&amp;jniEnv), JNI_VERSION_1_6);
    if (result != JNI_OK) {
        return -1;
    }
    return JNI_VERSION_1_6;
}

class MyContext {
public:
    JNIEnv *jniEnv = nullptr;
    jobject instance = nullptr;
};

void *myThreadTaskAction(void *pVoid) {
    //è¿™ä¸ªå‡½æ•°ä¸­æŒ‡é’ˆè¿è¡Œåœ¨å­çº¿ç¨‹ä¸­
    MyContext *myContext = static_cast&lt;MyContext *&gt;(pVoid);
    JNIEnv *jniEnv = nullptr;
    //é€šè¿‡JavaVM.attchCurrentThreadè·å–å­çº¿ç¨‹çš„JNIEnv
    jint result = ::javaVm-&gt;AttachCurrentThread(&amp;jniEnv, nullptr);
    if (result != JNI_OK) {
        return 0;
    }
    jclass activityClass = jniEnv-&gt;GetObjectClass(myContext-&gt;instance);

    jmethodID methodId = jniEnv-&gt;GetMethodID(activityClass, &quot;showAlter&quot;, &quot;()V&quot;);

    jniEnv-&gt;CallVoidMethod(myContext-&gt;instance, methodId);

    ::javaVm-&gt;DetachCurrentThread();
    return nullptr;
}


/**
 * åœ¨C++çš„å­çº¿ç¨‹ä¸­å›æ‰Javaå±‚ä»£ç 
 */
extern &quot;C&quot;
JNIEXPORT void JNICALL
Java_com_arms_ndktest_MainActivity_callJNIAsync(JNIEnv *env, jobject thiz) {
    env-&gt;GetJavaVM(&amp;::javaVm);
    auto *myContext = new MyContext;
    myContext-&gt;jniEnv = env;
    //jobject thiz ä¸èƒ½è·¨è¶Šçº¿ç¨‹å’Œå‡½æ•°  è¿™ä¸ªé€šè¿‡æå‡ä¸ºå…¨å±€å˜é‡æ¥è§£å†³
    myContext-&gt;instance = env-&gt;NewGlobalRef(thiz);
    pthread_t pid;
    //cä¸­çš„åˆ›å»ºå­çº¿ç¨‹
    pthread_create(&amp;pid, nullptr, myThreadTaskAction, myContext);
    pthread_join(pid, nullptr);
}
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[åœ¨ä¸åŒç‰ˆæœ¬ä¸‹é€šè¿‡Hookæ¥å¯åŠ¨æ’ä»¶activityçš„æµç¨‹]]></title>
        <id>https://arms-merchants.github.io/post/zai-bu-tong-ban-ben-xia-tong-guo-hook-lai-qi-dong-cha-jian-activity-de-liu-cheng/</id>
        <link href="https://arms-merchants.github.io/post/zai-bu-tong-ban-ben-xia-tong-guo-hook-lai-qi-dong-cha-jian-activity-de-liu-cheng/">
        </link>
        <updated>2022-03-21T01:16:29.000Z</updated>
        <content type="html"><![CDATA[<p>ä¸è®ºå“ªä¸ªç‰ˆæœ¬åœ¨å¯åŠ¨æ’ä»¶Activityä¹‹å‰éƒ½éœ€è¦é€šè¿‡DexPathLoaderæ¥è¿›è¡Œç›¸åº”çš„åŠ è½½ï¼Œè¿™ä¸ªéƒ¨åˆ†ä¸åœ¨æ­¤æ¬¡å†…å®¹ä¸­ã€‚<br>
ç‰ˆæœ¬åŒºåˆ†çš„è¯è¿™é‡Œæ˜¯æ ¹æ®Activityçš„å¯åŠ¨æµç¨‹å·®å¼‚æ¥è¿›è¡Œç›¸åº”çš„æ›¿æ¢ï¼ŒåŸºæœ¬æ€è·¯ä¸€è‡´ï¼Œç‰ˆæœ¬åˆ’åˆ†çš„è¯ä¸»è¦æ˜¯8.0ä»¥ä¸‹ï¼Œ10.0ä»¥ä¸‹ï¼Œ10.0åŠä»¥ä¸Šç‰ˆæœ¬ã€‚</p>
<h2 id="1hookæ›¿æ¢intent">1.Hookæ›¿æ¢Intent</h2>
<pre><code class="language-java">    private const val TARGET_INTENT = &quot;target_intent&quot;
    fun hookAMS() {
        try {
            LogE(Build.VERSION.SDK_INT.toString())
            //1ã€‚è·å–Singletonå¯¹è±¡
            val singletonFieldParams =
                when {
                    (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.O) -&gt; {
                        //8.0ä»¥ä¸‹
                        &quot;android.app.ActivityManagerNative&quot; to &quot;gDefault&quot;
                    }
                    (Build.VERSION.SDK_INT&lt;Build.VERSION_CODES.Q)-&gt;{
                        //10.0ä»¥ä¸‹
                        &quot;android.app.ActivityManager&quot; to &quot;IActivityManagerSingleton&quot;
                    }
                    else -&gt; {
                        //10.0åŠä»¥ä¸Š
                        &quot;android.app.ActivityTaskManager&quot; to &quot;IActivityTaskManagerSingleton&quot;
                    }
                }
            val aClass = Class.forName(singletonFieldParams.first)
            val singletonField = aClass.getDeclaredField(singletonFieldParams.second)
            singletonField.isAccessible = true
            val singleton = singletonField[null]
            val singletonClazz = Class.forName(&quot;android.util.Singleton&quot;)
            val mInstanceFiled = singletonClazz.getDeclaredField(&quot;mInstance&quot;)
            mInstanceFiled.isAccessible = true
            val mInstance = mInstanceFiled[singleton]

            //2ã€‚è·å–Singletonä¸­çš„IActivityTaskManagerå¯¹è±¡,åŒºåˆ†ç‰ˆæœ¬10ä»¥ä¸‹
            val proxyClass =
                if (Build.VERSION.SDK_INT &lt; Build.VERSION_CODES.Q) {
                    Class.forName(&quot;android.app.IActivityManager&quot;)
                } else {
                    Class.forName(&quot;android.app.IActivityTaskManager&quot;)
                }
            //3.åˆ›å»ºåŠ¨æ€ä»£ç†
            val newProxyInstance = Proxy.newProxyInstance(
                Thread.currentThread().contextClassLoader,
                arrayOf(proxyClass)
            ) { proxy, method, args -&gt; //è¿™é‡Œå·²ç»ä»£ç†äº†IActivityTaskManagerSingleton
                // å¯¹è±¡ï¼Œé‚£ä¹ˆå®ƒçš„æ–¹æ³•æ‰§è¡Œéƒ½ä¼šåˆ°è¿™é‡Œï¼Œé‚£ä¹ˆæˆ‘ä»¬åªè¦è¦è·å–è·å–å¯¹åº”çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå°±å¯ä»¥è·å–æ–¹æ³•ä¸­çš„å‚æ•°
                //å‚æ•°å½“ä¸­æ˜¯æœ‰Intentï¼Œé‚£ä¹ˆè¿™é‡Œå°±å¯ä»¥ä¿®æ”¹ä¸ºå®¿ä¸»ä¸­Activityæ¥æ‰§è¡Œ
                //åªéœ€è¦å¤„ç†startActivitiesçš„æ–¹æ³•
                //è¿™é‡Œä»£ç†çš„å¯¹è±¡æ–¹æ³•æ˜¯åœ¨android8ä»¥åçš„ç‰ˆæœ¬
                try {
                    var index = -1
                    if (&quot;startActivity&quot; == method.name) {
                        index = args.indexOfFirst { it is Intent }
                        val defIntent = args[index] as Intent
                        val proxyIntent = Intent()
                        proxyIntent.setClassName(
                            &quot;com.arm.arount&quot;, &quot;com&quot; +
                                    &quot;.arm.arount.ProxyActivity&quot;
                        )
                        proxyIntent.putExtra(TARGET_INTENT, defIntent)
                        args[index] = proxyIntent
                    }
                    method.invoke(mInstance, *args.orEmpty())
                } catch (e: Exception) {
                    e.printStackTrace()
                }
            }
            //4.ä¿®æ”¹singletonçš„ä»£ç†å¯¹è±¡
            mInstanceFiled[singleton] = newProxyInstance
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
</code></pre>
<p>åˆ°ä¸Šé¢ä¸€æ­¥æˆ‘ä»¬å·²ç»å®Œæˆäº†hook startActivityçš„æµç¨‹ï¼Œå¹¶ä¸”å°†å¯åŠ¨æ’ä»¶çš„Intentæ›¿æ¢ä¸ºäº†å®¿ä¸»ä»£ç†çš„Intentï¼Œå¹¶åœ¨å…¶ä¸­ä¿å­˜äº†åŸå§‹çš„Intentã€‚é‚£ä¹ˆä¸‹ä¸€æ­¥æˆ‘ä»¬å°±éœ€è¦åœ¨åˆé€‚çš„å®é™…æ›¿æ¢å›åŸå§‹çš„Intentã€‚</p>
<h2 id="2æ›¿æ¢å›åŸå§‹intent">2.æ›¿æ¢å›åŸå§‹Intent</h2>
<p>å…ˆä¸Šä»£ç ï¼š</p>
<pre><code class="language-java">fun hookHandleIntent() {
        try {
            //è·å–ActivityThread
            val aClass = Class.forName(&quot;android.app.ActivityThread&quot;)
            //è·å–å®ƒçš„é™æ€å®ä¾‹å¯¹è±¡
            val sCurrentActivityThread = aClass.getDeclaredField(&quot;sCurrentActivityThread&quot;)
            sCurrentActivityThread.isAccessible = true
            val activityThread = sCurrentActivityThread[null]
            val mHField = aClass.getDeclaredField(&quot;mH&quot;)
            mHField.isAccessible = true
            val handler = mHField[activityThread] as Handler
            val mCallbackField = Handler::class.java.getDeclaredField(&quot;mCallback&quot;)
            mCallbackField.isAccessible = true
            val callback = Handler.Callback { msg -&gt;
                try {
                    when (msg.what) {
                        //Android8.0ä»¥ä¸‹çš„å¤„ç†çš„LaunchActivity
                        100 -&gt; {
                            val intentField = msg.obj.javaClass.getDeclaredField(&quot;intent&quot;)
                            intentField.isAccessible = true
                            val proxyIntent: Intent = intentField.get(msg.obj) as Intent
                            val intent = proxyIntent.getParcelableExtra&lt;Intent?&gt;(TARGET_INTENT)
                            intent?.let {
                                intentField.set(msg.obj, it)
                            }
                        }
                        //8.0ä»¥ä¸Šçš„ç”Ÿå‘½å‘¨æœŸå…¥å£
                        159 -&gt; {
                            val mActivityCallbacksField = msg.obj.javaClass.getDeclaredField(
                                &quot;mActivityCallbacks&quot;
                            )
                            mActivityCallbacksField.isAccessible = true
                            val mActivityCallbacks = mActivityCallbacksField[msg.obj] as List&lt;*&gt;
                            val launchActivityItem = mActivityCallbacks.firstOrNull {
                                &quot;android.app.servertransaction.LaunchActivityItem&quot; == it?.javaClass?.name
                            }
                            launchActivityItem?.let {
                                val mIntentField = it.javaClass.getDeclaredField(&quot;mIntent&quot;)
                                mIntentField.isAccessible = true
                                val proxyIntent = mIntentField[launchActivityItem] as Intent
                                val intent =
                                    proxyIntent.getParcelableExtra&lt;Intent&gt;(TARGET_INTENT)
                                if (intent != null) {
                                    mIntentField[launchActivityItem] = intent
                                }
                            }
                        }
                    }
                } catch (e: Exception) {
                    e.printStackTrace()
                }
                //è¿™é‡Œä¸€å®šè¦è¿”å›falseä¸ç„¶æ­£å¸¸æµç¨‹çš„handleMessageå°±æ‰§è¡Œä¸åˆ°äº†
                false
            }
            mCallbackField[handler] = callback
        } catch (e: Exception) {
            e.printStackTrace()
        }
    }
</code></pre>
<p>å±æ€§activityå¯åŠ¨æµç¨‹çš„å› ä¸ºéƒ½å‘ç°æˆ‘ä»¬æ˜¯åœ¨ActivityThreadçš„mhçš„Handlerä¸­æ‹¦æˆªæ¶ˆæ¯çš„ï¼ŒHandlerä¸­æœ‰ä¸€ä¸ªCallBackå¯¹è±¡ï¼Œå¯ä»¥åœ¨handleMessageä¹‹å‰æ‹¿åˆ°msg</p>
<pre><code class="language-java">    public void dispatchMessage(@NonNull Message msg) {
        if (msg.callback != null) {
            handleCallback(msg);
        } else {
            if (mCallback != null) {
                //è¿™é‡Œå°±æ˜¯ä¸€å®šè¦è¿”å›falseçš„åŸå› 
                if (mCallback.handleMessage(msg)) {
                    return;
                }
            }
            handleMessage(msg);
        }
    }
</code></pre>
<p>åœ¨æ‹¿åˆ°msgä¹‹åæˆ‘ä»¬éœ€è¦å¤„ç†ä»¥ä¸‹8.0ä»¥ä¸‹ä»¥åŠ8.0ä»¥ä¸Šçš„åŒºåˆ†ï¼š<br>
Â· åœ¨Android8.0ä»¥ä¸‹æ—¶ï¼Œæ˜¯åœ¨ActivityThreadçš„Handlerä¸­å¤„ç†<br>
100-109è¿™å‡ ä¸ªå€¼æ¥å¤„ç†ä¸åŒçš„ç”Ÿå‘½å‘¨æœŸçš„ï¼Œå¹¶ä¸”åœ¨msgä¸­å¯ä»¥ç›´æ¥è·å–åˆ°Intentå¯¹è±¡ã€‚<br>
Â· è€Œåœ¨Android8.0ä»¥åï¼Œè¿™å‡ ä¸ªå€¼æ²¡æœ‰äº†ï¼Œç»Ÿä¸€ä¸º159çš„å…¥å£ï¼Œå¹¶é€šè¿‡çŠ¶æ€æ¨¡å¼æ¥å¤„ç†ï¼Œå¹¶ä¸”ç›¸åº”çš„å‚æ•°æœ‰å°è£…ï¼Œæˆ‘ä»¬éœ€è¦è·å–ä¸€äº›åŒ…è£…å‚æ•°ä¹‹åæ‰èƒ½è·å–åˆ°Intentã€‚</p>
<p>åˆ°è¿™é‡Œæ’ä»¶çš„Activityå°±å¯ä»¥å¯åŠ¨äº†ï¼Œä½†æ˜¯ä½ ä¼šå‘ç°èµ„æºå¸ƒå±€éƒ½æ²¡æ³•åŠ è½½ï¼Œä¸‹é¢å†è¯´æ’ä»¶èµ„æºçš„åŠ è½½ã€‚</p>
<hr>
<p>Hookçš„æ–¹å¼æ¥è¿›è¡Œæ’ä»¶åŒ–å¼€å‘ï¼Œå¾ˆå—ç³»ç»Ÿç‰ˆæœ¬çš„é™åˆ¶ï¼Œå¹¶ä¸”éšç€Androidç³»ç»Ÿç‰ˆæœ¬çš„å‡çº§è¦åšä¸åŒçš„é€‚é…ã€‚æ‰€ä»¥è¿˜æœ‰å¦å¤–ä¸€ç§æ’ä»¶æ–¹æ¡ˆå°±æ˜¯é€šè¿‡å®¹å™¨æ¥å®ç°æ’ä»¶åŒ–ï¼Œè¿™ç§æ–¹å¼ä¸éœ€è¦hookå¤ªå¤šçš„ç³»ç»Ÿä»£ç ï¼Œè…¾è®¯çš„Shadowæ’ä»¶å°±æ˜¯è¿™ä¸ªæ¥å®ç°çš„ï¼Œå®¿ä¸»çš„appä¸­æœ‰çš„æ˜¯å®¹å™¨çš„activity,ç¼–å†™çš„ä¸šåŠ¡æ’ä»¶æŒ‰åŸæ¥çš„é€»è¾‘ç»§æ‰¿Activityï¼Œä½†æ˜¯åœ¨ç¼–è¯‘æ‰“åŒ…çš„æ—¶å€™é€šè¿‡æ’ä»¶å°†å…¶ç»§æ‰¿æ”¹ä¸ºShadowActivityï¼Œè¿™é‡Œå…¶å®æ˜¯æ”¹ä¸ºäº†æ™®é€šç±»ï¼Œè€Œåœ¨ä»£ç†ç±»ä¸­é€šè¿‡è°ƒç”¨è¿™äº›æ–¹æ³•ï¼Œä»è€Œå®ç°äº†ç”Ÿå‘½å‘¨æœŸæ–¹æ³•çš„è°ƒç”¨ï¼Œä¸è¿‡è¿™é‡Œéƒ½é¿å…ä¸äº†åŠ è½½æ’ä»¶çš„è¿‡ç¨‹ï¼Œæ‰€æœ‰DexClassLoaderè¿˜æ˜¯å¿…é¡»è¦åŠ è½½ä½¿ç”¨çš„ï¼Œè¿™ä¹Ÿæ˜¯çƒ­ä¿®å¤çš„åŸºç¡€ã€‚</p>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[Kotlinåå°„]]></title>
        <id>https://arms-merchants.github.io/post/kotlin-fan-she/</id>
        <link href="https://arms-merchants.github.io/post/kotlin-fan-she/">
        </link>
        <updated>2022-03-15T07:26:22.000Z</updated>
        <content type="html"><![CDATA[<p>kotlinå¯ä»¥ç›´æ¥ä½¿ç”¨javaçš„åå°„ï¼Œå¦‚æœè¦ä½¿ç”¨kotlinçš„åå°„ï¼Œé‚£ä¹ˆéœ€è¦å•ç‹¬å¼•å…¥kotlinçš„åå°„åº“</p>
<pre><code class="language-java">implementation &quot;org.jetbrains.kotlin:kotlin-reflect&quot;  
</code></pre>
<p>é‚£ä¹ˆè¿™å’ŒJavaå¯¹æ¯”çš„è¯æœ‰ä»€ä¹ˆåŒºåˆ«</p>
<h2 id="java">Java</h2>
<ul>
<li>
<p>ä¼˜ç‚¹ï¼šæ— éœ€å¼•å…¥é¢å¤–ä¾èµ–ï¼Œé¦–æ¬¡ä½¿ç”¨é€Ÿåº¦ç›¸å¯¹è¾ƒå¿«(è¿™æ˜¯å› ä¸ºå®ƒçš„ä¿¡æ¯éƒ½åœ¨è™šæ‹Ÿæœºå†…)ã€‚</p>
</li>
<li>
<p>ç¼ºç‚¹ï¼šæ— æ³•è®¿é—®Kotlinè¯­æ³•ç‰¹æ€§ï¼Œéœ€è¦å¯¹Kotlinç”Ÿæˆçš„å­—èŠ‚ç è¶³å¤Ÿäº†è§£(è¿™æ˜¯å› ä¸ºKotlinç¨‹åºç¼–è¯‘å®Œä¹‹åä¹Ÿæ˜¯ä¸ªJavaç±»ï¼Œæ‰€ä»¥åœ¨Javaåå°„è§†è§’ä¸‹çœ‹åˆ°çš„Kotlinç¼–è¯‘çš„çŠ¶æ€å’Œä¸€èˆ¬Javaç±»æ— å¼‚ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœè¦é€šè¿‡åå°„è®¿é—®Kotlinç±»çš„ä¸€äº›æ–¹æ³•å±æ€§ï¼Œå¿…é¡»è¦çŸ¥é“å®ƒç¼–è¯‘ä»€ä¹ˆæ ·çš„å­—èŠ‚ç )</p>
</li>
</ul>
<h2 id="kotlin">kotlin</h2>
<ul>
<li>
<p>ä¼˜ç‚¹ï¼šæ”¯æŒè®¿é—®Kotlinå‡ ä¹æ‰€æœ‰ç‰¹æ€§ï¼ŒAPIè®¾è®¡å…¼å®¹æ€§æ›´å¥½ã€‚</p>
</li>
<li>
<p>ç¼ºç‚¹ï¼šé¢å¤–å¼•å…¥äº†ä¸€ä¸ªKotlinåå°„åº“(è¿™ä¸ªåº“2.5Må·¦å³ï¼Œç¼–è¯‘å400KB)ï¼Œé¦–æ¬¡è°ƒç”¨ä¼šæ…¢ä¸€äº›ï¼Œè¿™æ˜¯å› ä¸ºKotlinçš„åå°„ä¿¡æ¯æ˜¯å†™åˆ°Metadataè¿™ä¸ªæ³¨è§£é‡Œé¢çš„(é€šè¿‡æŸ¥çœ‹å­—èŠ‚ç å¯ä»¥çœ‹åˆ°ï¼Œå¦‚ä¸‹)ï¼Œé‡Œé¢çš„æ•°æ®é€šè¿‡Protobufçš„æ•°æ®æ ¼å¼åºåˆ—åŒ–äºŒè¿›åˆ¶å†™å…¥ï¼Œæ‰€ä»¥é¦–æ¬¡åå°„è°ƒç”¨æœ‰ä¸€ä¸ªè·å–æ³¨è§£å¹¶ååºåˆ—åŒ–çš„è¿‡ç¨‹)ã€‚</p>
</li>
</ul>
<pre><code class="language-kotlin">
@Metadata(
   mv = {1, 6, 0},
   k = 1,
   d1 = {&quot;\u0000\u001a\n\u0002\u0018\u0002\n\u0000\n\u0002\u0018\u0002\n\u0002\u0010\u0000\n\u0002\b\u0002\n\u0002\u0010\u0002\n\u0002\b\u0003\u0018\u0000*\n\b\u0000\u0010\u0001 \u0000*\u00020\u00022\u00020\u0003B\u0005Â¢\u0006\u0002\u0010\u0004J\u0013\u0010\u0005\u001a\u00020\u00062\u0006\u0010\u0007\u001a\u00028\u0000Â¢\u0006\u0002\u0010\bÂ¨\u0006\t&quot;},
   d2 = {&quot;Lcom/qisan/kotlinstu/Dustbin;&quot;, &quot;T&quot;, &quot;Lcom/qisan/kotlinstu/Waste;&quot;, &quot;&quot;, &quot;()V&quot;, &quot;put&quot;, &quot;&quot;, &quot;t&quot;, &quot;(Lcom/qisan/kotlinstu/Waste;)V&quot;, &quot;KotlinStu.app&quot;}
)
</code></pre>
<h2 id="ä¸€äº›åœ¨kotlinåå°„ä¸­çš„å¸¸ç”¨api">ä¸€äº›åœ¨Kotlinåå°„ä¸­çš„å¸¸ç”¨Api:</h2>
<pre><code class="language-java">        var cls: KClass&lt;String&gt; = String::class
        //KClassè½¬ä¸ºjavaçš„Class&lt;String&gt;
        var clsJava: Class&lt;String&gt; = cls.java
        //javaçš„Class&lt;String&gt;è½¬ä¸ºKClass
        cls = clsJava.kotlin
        //è·å–å®šä¹‰åœ¨Stringç±»çš„å±æ€§ï¼Œè¿”å›çš„æ˜¯Collections
        val properties = cls.declaredMemberProperties
        //è¿”å›è¿™ä¸ªç±»ä¸­çš„æ‰€æœ‰æ–¹æ³•
        cls.declaredFunctions
        //è¿”å›è¿™ä¸ªç±»ä¸­çš„æ‰€æœ‰éé™æ€éæ‰©å±•çš„å‡½æ•°
        cls.declaredMemberFunctions
        //è¿”å›è¿™ä¸ªç±»ä¸­ä¸­çš„æ‰©å±•å‡½æ•°,æ³¨æ„çœ‹ä¸‹é¢çš„ç±»A
        cls.declaredMemberExtensionFunctions

        cls.isAbstract//æ˜¯å¦æ˜¯æŠ½è±¡ç±»
        cls.isCompanion//æ˜¯å¦æ˜¯ä¼´ç”Ÿå¯¹è±¡
        cls.nestedClasses//è·å–å½“å‰ç±»çš„å†…éƒ¨ç±»
        cls.objectInstance//å¦‚æœæ˜¯objectï¼Œå¯ä»¥é€šè¿‡è¿™ä¸ªæ–¹æ³•è·å–
</code></pre>
<h3 id="1declaredmemberextensionfunctionsçš„å¼ä¾‹">1.declaredMemberExtensionFunctionsçš„å¼ä¾‹</h3>
<pre><code class="language-java">class A {

    fun test(){
        //è¿™é‡Œçš„åå°„å±æ€§é€šè¿‡è¿™ä¸ªæ˜¯å¯ä»¥è·å–åˆ°è¿™ä¸ªString.passçš„æ‰©å±•æ–¹æ³•
        A::class.declaredMemberExtensionFunctions
        //ä½†æ˜¯é€šè¿‡Stringæ˜¯è·å–ä¸åˆ°
        String::class.declaredMemberExtensionFunctions
        &quot;&quot;.pass()
    }

    fun String.pass(){
    }
}
</code></pre>
<p>åœ¨Açš„æ‰©å±•å‡½æ•°ä¸­èƒ½å¤Ÿè·å–åˆ°String.passçš„æ‰©å±•æ–¹æ³•ï¼Œä½†æ˜¯String::class.declaredMemberExtensionFunctionsæ˜¯æ²¡æœ‰çš„ï¼Œè€Œåœ¨é¡¶çº§çš„æ‰©å±•å‡½æ•°ä¸­æ˜¯æ„å»ºæˆé™æ€æ–¹æ³•çš„.</p>
<pre><code class="language-java">fun String.pass() {
    println(&quot;test&quot;)
}
//ktx.kt å¯¹åº”åˆ°çš„javaä»£ç 
@Metadata(
   mv = {1, 6, 0},
   k = 2,
   d1 = {&quot;\u0000\f\n\u0000\n\u0002\u0010\u0002\n\u0002\u0010\u000e\n\u0000\u001a\n\u0010\u0000\u001a\u00020\u0001*\u00020\u0002Â¨\u0006\u0003&quot;},
   d2 = {&quot;pass&quot;, &quot;&quot;, &quot;&quot;, &quot;Arount.app&quot;}
)
public final class KtxKt {
   public static final void pass(@NotNull String $this$pass) {
      Intrinsics.checkNotNullParameter($this$pass, &quot;$this$pass&quot;);
      String var1 = &quot;test&quot;;
      System.out.println(var1);
   }
}
</code></pre>
<h3 id="2ktypeçš„è·å–">2.KTypeçš„è·å–</h3>
<pre><code class="language-java">   fun testKType(){
        val mapType = typeOf&lt;Map&lt;String,Int&gt;&gt;()
        mapType.arguments.forEach {
            print(it)
        }
        /**
         * è¾“å‡ºç»“æœï¼š
         * kotlin.String
         * kotlin.Int
         * KTypeå¯ä»¥æ‰¾åˆ°æ³›å‹å®å‚
         */
    }
</code></pre>
<h3 id="3è·å–æ¥å£æ–¹æ³•çš„è¿”å›çš„æ³›å‹å®ä¾‹å‚æ•°ç±»å‹">3.è·å–æ¥å£æ–¹æ³•çš„è¿”å›çš„æ³›å‹å®ä¾‹å‚æ•°ç±»å‹</h3>
<pre><code class="language-java">interface Api{
    fun getUsers():List&lt;UserModel&gt;
}

data class UserModel(var id:Int,var name:String)

fun testGetFunParamsType(){
        Api::class.declaredFunctions.first { it.name == &quot;getUsers&quot; }
            .returnType.arguments.forEach {
                print(it)
            }
        //ä¸¤è€…ç›¸åŒ
        Api::getUsers.returnType.arguments.forEach {
            print(it)
        }
    }
</code></pre>
<h3 id="4è·å–å®ä¾‹å¯¹è±¡ä¸Šçš„æ³›å‹çº¦æŸç±»å‹">4.è·å–å®ä¾‹å¯¹è±¡ä¸Šçš„æ³›å‹çº¦æŸç±»å‹</h3>
<pre><code class="language-java">abstract class SuperType&lt;T&gt;{
    val typeParameter by lazy {
        //thisè¡¨ç¤ºçš„æ˜¯å­ç±»çš„å®ä¾‹ï¼Œå› ä¸ºæŠ½è±¡ç±»ä¸èƒ½ç”¨äºåˆ›å»ºå®ä¾‹ï¼Œåªèƒ½èƒŒå½“åšçˆ¶ç±»è¢«å­ç±»ç»§æ‰¿
        this::class.supertypes.first().arguments.first().type
        //å¦‚æœæœ‰å¤šä¸ªå­ç±»ç»§æ‰¿ æ¯”å¦‚class SubType2:SubType(){} 
        //è¿™ä¸ªæ—¶å€™this::class.supertypeä¼šç©ºï¼Œå› ä¸ºSubTypeæ²¡æœ‰æ³›å‹å®å‚è¿™æ—¶å€™è¦ä½¿ç”¨ï¼š
        this::class.allSupertypes.first().arguments.first().type
    }
}

open class SubType:SuperType&lt;String&gt;()

class SubType2:SubType()

fun testGetParentType(){
    val subType = SubType()
    subType.typeParameter.let {
        print(it)
        //kotlin.String
    }
}
</code></pre>
<h2 id="åœºæ™¯å¼•ç”¨-æ·±å±‚æ‹·è´">åœºæ™¯å¼•ç”¨-æ·±å±‚æ‹·è´</h2>
<pre><code class="language-java">    data class Person(val id: Int, val name: String, val group: Group)
    data class Group(val id: Int, val name: String)

/**
 * æ·±å±‚æ•°æ®æ‹·è´
 */
fun &lt;T:Any&gt; T.deepCopy():T{
    if(!this::class.isData){
        return this
    }
    return this::class.primaryConstructor!!.let { primaryConstructor-&gt;
        primaryConstructor.parameters.associate { parameter -&gt;
            val value =
                (this::class as KClass&lt;T&gt;).memberProperties.first { it.name == parameter.name }
                    .get(this)
            if ((parameter.type.classifier as? KClass&lt;*&gt;)?.isData == true) {
                parameter to value?.deepCopy()
            } else {
                parameter to value
            }
        }
            .let {
                primaryConstructor.callBy(it)
                //primaryConstructoræ˜¯KFunction&lt;T&gt;ç±»å‹ KFunction&lt;T&gt;é‡Œé¢æœ‰callByæ–¹æ³• åªè¦ä¼ ä¸€ä¸ªmapï¼Œè¿”å›è°ƒç”¨è€…çš„å‚æ•°ç±»å‹T
            }
    }
}

    private fun testCopy() {
        val group = Group(1, &quot;11111&quot;)
        val person = Person(1, &quot;haha&quot;, group)
        //æµ…å±‚æ‹·è´å®é™…ä¸Šå°±æ˜¯newäº†ä¸€ä¸ªæ–°çš„å¯¹è±¡ï¼Œå¹¶å°†å½“å‰ç±»çš„å±æ€§ä¼ å…¥ï¼Œé‚£ä¹ˆgroupå°±ä¼ å…¥çš„æ˜¯åŒä¸€ä¸ªäº†
        val copyPerson = person.copy()
        //ä¹Ÿå°±æ˜¯è¯´é€šè¿‡copyçš„æ–¹æ³•ï¼Œå®ç°çš„æ‹·è´ä¸­groupè¿˜æ˜¯æŒ‡å‘çš„åŒä¸€ä¸ªï¼Œé‚£ä¹ˆç›¸åº”çš„ä¿®æ”¹å°±ä¼šé€ æˆåŒæ­¥çš„ä¿®æ”¹
        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, (person === copyPerson).toString()) //false
        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, (person.group === copyPerson.group).toString()) //true

        //æ·±å±‚æ‹·è´çš„ç¬¬ä¸€æ¬¡æ˜¯çœŸçš„æ…¢
        val startTime = System.currentTimeMillis()
        val deepCope = person.deepCopy()
        val endTime = System.currentTimeMillis()

        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, &quot;cost time:${endTime - startTime}&quot;)
        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, (person === deepCope).toString()) //false
        Log.e(&quot;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&quot;, (person.group === deepCope.group).toString()) //false
    }
</code></pre>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[ANRä»¥åŠç”µé‡ä¼˜åŒ–]]></title>
        <id>https://arms-merchants.github.io/post/anr-yi-ji-dian-liang-you-hua/</id>
        <link href="https://arms-merchants.github.io/post/anr-yi-ji-dian-liang-you-hua/">
        </link>
        <updated>2022-03-01T01:07:44.000Z</updated>
        <content type="html"><![CDATA[<h1 id="appå¯åŠ¨ä¼˜åŒ–åˆ†æ"><a href="https://mp.weixin.qq.com/s/_8ZzgmmP4Ov66f42sBHslA">Appå¯åŠ¨ä¼˜åŒ–åˆ†æ</a></h1>
<h2 id="1anræ˜¯ä»€ä¹ˆ">1.ANRæ˜¯ä»€ä¹ˆï¼Ÿ</h2>
<p>ANR(Application Not Responding)ç¨‹åºæœªå“åº”ï¼ŒAndroidç³»ç»Ÿä¸­å¦‚æœåœ¨é¢„å®šçš„æ—¶é—´å†…æœªå¾—åˆ°æœ‰æ•ˆçš„å“åº”æˆ–å“åº”æ—¶é—´è¿‡é•¿ï¼Œéƒ½ä¼šäº§ç”ŸANRï¼Œç¨‹åºçš„å“åº”æ€§ç”±ActivityManagerå’ŒWindowManagerç³»ç»ŸæœåŠ¡ç›‘è§†ã€‚</p>
<h2 id="2anrçš„äº§ç”ŸåŸå› ">2.ANRçš„äº§ç”ŸåŸå› ï¼Ÿ</h2>
<ul>
<li>å¯¹äºå‰å°æœåŠ¡ï¼Œåˆ™è¶…æ—¶ä¸ºSERVICE_TIMEOUT = 20sï¼›</li>
<li>å¯¹äºåå°æœåŠ¡ï¼Œåˆ™è¶…æ—¶ä¸ºSERVICE_BACKGROUND_TIMEOUT = 200s</li>
<li>å¯¹äºå‰å°å¹¿æ’­ï¼Œåˆ™è¶…æ—¶ä¸ºBROADCAST_FG_TIMEOUT = 10sï¼›</li>
<li>å¯¹äºåå°å¹¿æ’­ï¼Œåˆ™è¶…æ—¶ä¸ºBROADCAST_BG_TIMEOUT = 60s;</li>
<li>ContentProviderè¶…æ—¶ä¸ºCONTENT_PROVIDER_PUBLISH_TIMEOUT = 10s;</li>
<li>InputDispatching Timeout: è¾“å…¥äº‹ä»¶åˆ†å‘è¶…æ—¶5sï¼ŒåŒ…æ‹¬æŒ‰é”®å’Œè§¦æ‘¸äº‹ä»¶ã€‚</li>
</ul>
<p><code>æ³¨æ„äº‹é¡¹: Inputçš„è¶…æ—¶æœºåˆ¶ä¸å…¶ä»–çš„ä¸åŒï¼Œå¯¹äºinputæ¥è¯´å³ä¾¿æŸæ¬¡äº‹ä»¶æ‰§è¡Œæ—¶é—´è¶…è¿‡timeoutæ—¶é•¿ï¼Œåªè¦ç”¨æˆ·åç»­åœ¨æ²¡æœ‰å†ç”Ÿæˆè¾“å…¥äº‹ä»¶ï¼Œåˆ™ä¸ä¼šè§¦å‘ANR</code></p>
<ul>
<li>
<p>Serviceè¶…æ—¶æ£€æµ‹æœºåˆ¶ï¼š</p>
<ul>
<li>è¶…è¿‡ä¸€å®šæ—¶é—´æ²¡æœ‰æ‰§è¡Œå®Œç›¸åº”æ“ä½œæ¥è§¦å‘ç§»é™¤å»¶æ—¶æ¶ˆæ¯ï¼Œåˆ™ä¼šè§¦å‘anr;</li>
</ul>
</li>
<li>
<p>BroadcastReceiverè¶…æ—¶æ£€æµ‹æœºåˆ¶ï¼š</p>
<ul>
<li>æœ‰åºå¹¿æ’­çš„æ€»æ‰§è¡Œæ—¶é—´è¶…è¿‡ 2* receiverä¸ªæ•° * timeoutæ—¶é•¿ï¼Œåˆ™ä¼šè§¦å‘anr;<br>
æœ‰åºå¹¿æ’­çš„æŸä¸€ä¸ªreceiveræ‰§è¡Œè¿‡ç¨‹è¶…è¿‡ timeoutæ—¶é•¿ï¼Œåˆ™ä¼šè§¦å‘anr;</li>
</ul>
</li>
<li>
<p>å¦å¤–:</p>
<ul>
<li>å¯¹äºService, Broadcast, Inputå‘ç”ŸANRä¹‹å,æœ€ç»ˆéƒ½ä¼šè°ƒç”¨AMS.appNotResponding;</li>
<li>å¯¹äºprovider,åœ¨å…¶è¿›ç¨‹å¯åŠ¨æ—¶publishè¿‡ç¨‹å¯èƒ½ä¼šå‡ºç°ANR, åˆ™ä¼šç›´æ¥æ€è¿›ç¨‹ä»¥åŠæ¸…ç†ç›¸åº”ä¿¡æ¯,è€Œä¸ä¼šå¼¹å‡ºANRçš„å¯¹è¯æ¡†</li>
</ul>
</li>
</ul>
<h2 id="3anrçš„å®šä½åˆ†æ">3.ANRçš„å®šä½åˆ†æ</h2>
<ol>
<li>å‰å°ANRå‘ç”Ÿåï¼Œç³»ç»Ÿä¼šé©¬ä¸Šå»æŠ“å–ç°åœºçš„ä¿¡æ¯ï¼Œç”¨äºè°ƒè¯•åˆ†æï¼Œæ”¶é›†çš„ä¿¡æ¯å¦‚ä¸‹:</li>
</ol>
<ul>
<li>å°†am_anrä¿¡æ¯è¾“å‡ºåˆ°EventLogï¼Œä¹Ÿå°±æ˜¯è¯´ANRè§¦å‘çš„æ—¶é—´ç‚¹æœ€æ¥è¿‘çš„å°±æ˜¯EventLogä¸­è¾“å‡ºçš„am_anrä¿¡æ¯</li>
<li>æ”¶é›†ä»¥ä¸‹é‡è¦è¿›ç¨‹çš„å„ä¸ªçº¿ç¨‹è°ƒç”¨æ ˆtraceä¿¡æ¯ï¼Œä¿å­˜åœ¨data/anr/traces.txtæ–‡ä»¶
<ul>
<li>å½“å‰å‘ç”ŸANRçš„è¿›ç¨‹ï¼Œsystem_serverè¿›ç¨‹ä»¥åŠæ‰€æœ‰persistentè¿›ç¨‹</li>
<li>audioserver, cameraserver, mediaserver, surfaceflingerç­‰é‡è¦çš„nativeè¿›ç¨‹</li>
<li>CPUä½¿ç”¨ç‡æ’åå‰5çš„è¿›ç¨‹</li>
</ul>
</li>
<li>å°†å‘ç”ŸANRçš„reasonä»¥åŠCPUä½¿ç”¨æƒ…å†µä¿¡æ¯è¾“å‡ºåˆ°main log</li>
<li>å°†tracesæ–‡ä»¶å’ŒCPUä½¿ç”¨æƒ…å†µä¿¡æ¯ä¿å­˜åˆ°dropboxï¼Œå³data/system/dropboxç›®å½•</li>
<li>å¯¹ç”¨æˆ·å¯æ„ŸçŸ¥çš„è¿›ç¨‹åˆ™å¼¹å‡ºANRå¯¹è¯æ¡†å‘ŠçŸ¥ç”¨æˆ·ï¼Œå¯¹ç”¨æˆ·ä¸å¯æ„ŸçŸ¥çš„è¿›ç¨‹å‘ç”ŸANRåˆ™ç›´æ¥æ€æ‰</li>
</ul>
<ol start="2">
<li>åˆ†ææ­¥éª¤
<ol>
<li>å®šä½å‘ç”ŸANRæ—¶é—´ç‚¹</li>
<li>æŸ¥çœ‹traceä¿¡æ¯</li>
<li>åˆ†ææ˜¯å¦æœ‰è€—æ—¶çš„message,binderè°ƒç”¨ï¼Œé”çš„ç«äº‰ï¼ŒCPUèµ„æºçš„æŠ¢å </li>
<li>ç»“åˆå…·ä½“çš„ä¸šåŠ¡åœºæ™¯çš„ä¸Šä¸‹æ–‡æ¥åˆ†æ</li>
</ol>
</li>
</ol>
<h2 id="4ç”µé‡ä¼˜åŒ–å·¥å…·">4.ç”µé‡ä¼˜åŒ–å·¥å…·</h2>
<pre><code>Profiler - NetWork(ç½‘ç»œåˆ†æ),CPUï¼ˆCPUä½¿ç”¨åˆ†æï¼ŒæŸ¥çœ‹å½“å‰CPUè¿è¡Œçš„çŠ¶æ€ï¼Œåˆ¤æ–­å¡é¡¿å‘ç”Ÿæ—¶çš„çŠ¶æ€ï¼‰,Memoryï¼ˆå†…å­˜ä½¿ç”¨åˆ†æï¼Œå†…å­˜æŠ–åŠ¨ï¼Œå†…å­˜æ³„æ¼ï¼ŒOOMçš„åˆ†æï¼‰
</code></pre>
<h2 id="5ç”µé‡ä¼˜åŒ–æ–¹æ¡ˆ">5.ç”µé‡ä¼˜åŒ–æ–¹æ¡ˆ</h2>
<p>å‡å°‘æ“ä½œï¼Œä¾‹å¦‚æ•°æ®ä¸‹è½½æ˜¯å¦æ¯æ¬¡éƒ½éœ€è¦å»æ›´æ–°æœ€æ–°çš„æ•°æ®ï¼Œæ˜¯å¦æœ‰ç¼“å­˜çš„å¿…è¦ã€‚<br>
æ¨è¿Ÿæ“ä½œï¼Œä¸€äº›è€—ç”µæ“ä½œæ˜¯å¦åœ¨ç‰¹å®šçš„çŠ¶æ€ä¸‹ï¼ˆç”µé‡æ»¡æˆ–è€…å……ç”µçŠ¶æ€ä¸‹ï¼‰è¿›è¡Œï¼Œä¾‹å¦‚æŒç»­çš„å®šä½<br>
åˆå¹¶æ“ä½œ<br>
DNSçš„ä¼˜åŒ–ï¼šHTTPDNSï¼Œå¯ä»¥æ¥å…¥ä¸‰æ–¹æä¾›çš„dnsè§£æï¼Œ<a href="https://help.aliyun.com/product/30100.html"><code>é˜¿é‡Œäº‘HTTPDNS</code></a><br>
æ•°æ®å‹ç¼©ï¼šPtotobuf</p>
<h3 id="é˜¿é‡Œmavne"><a href="https://developer.aliyun.com/mvn/view"><code>é˜¿é‡ŒMavne</code></a></h3>
]]></content>
    </entry>
    <entry>
        <title type="html"><![CDATA[å¸¸ç”¨çš„æ•°æ®ç»“æ„åˆ†æ]]></title>
        <id>https://arms-merchants.github.io/post/chang-yong-de-shu-ju-jie-gou-fen-xi/</id>
        <link href="https://arms-merchants.github.io/post/chang-yong-de-shu-ju-jie-gou-fen-xi/">
        </link>
        <updated>2022-02-22T01:37:02.000Z</updated>
        <content type="html"><![CDATA[<p>å¸¸ç”¨çš„æ•°æ®ç»“æ„<br>
ArrayListï¼šåº•å±‚ç”±æ•°ç»„å®ç°ï¼Œæ‰€ä»¥å®ƒåœ¨å†…å­˜ä¸­æ˜¯ä¸€å—è¿ç»­çš„ç©ºé—´</p>
<pre><code class="language-java">/**
ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ç›´æ¥åœ¨æ·»åŠ ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ·»åŠ åœ¨æ•°ç»„çš„æœ€åï¼Œè¿™ä¸ªæ—¶å€™åªéœ€è¦è®©size++çš„å…ƒç´ å¡«å……ä¸ºe
*/
    public boolean add(E e) {
        ensureCapacityInternal(size + 1);  // Increments modCount!!
        elementData[size++] = e;
        return true;
    }
/**
åœ¨æŒ‡å®šçš„ä½ç½®æ’å…¥ï¼ŒSystem.arraycopyé¦–å…ˆä¼šå°†å½“å‰indexåˆ°æ•°ç»„æœ€åçš„å…ƒç´ åç§»æ‹·è´ä¸€ä»½ï¼Œå†å°†æ’å…¥çš„å…ƒç´ æ’å…¥index
*/
    public void add(int index, E element) {
        if (index &gt; size || index &lt; 0)
            throw new IndexOutOfBoundsException(outOfBoundsMsg(index));

        ensureCapacityInternal(size + 1);  // Increments modCount!!
        System.arraycopy(elementData, index, elementData, index + 1,
                         size - index);
        elementData[index] = element;
        size++;
    }
</code></pre>
<p>æ‰€ä»¥åœ¨addçš„æ—¶å€™å¦‚æœæ˜¯å‘ç”Ÿåœ¨ä¸­é—´çš„æƒ…å†µä¸‹ï¼Œé‚£ä¹ˆä¼šå‘ç”Ÿä¸€æ¬¡æ•°æ®æ‹·è´</p>
<pre><code class="language-java">  public E remove(int index) {
        if (index &gt;= size)
            throw new IndexOutOfBoundsException(outOfBoundsMsg(index));

        modCount++;
        E oldValue = (E) elementData[index];

        int numMoved = size - index - 1;
        if (numMoved &gt; 0)
            System.arraycopy(elementData, index+1, elementData, index,
                             numMoved);
        elementData[--size] = null; // clear to let GC do its work

        return oldValue;
    }
</code></pre>
<p>removeçš„æ“ä½œåŒç†ï¼Œå–å‡ºindexåæ ‡ä¸‹çš„å¯¹è±¡ï¼Œç„¶åé€šè¿‡æ•°æ®æ‹·è´å°†index+1åˆ°æœ«å°¾çš„æ•°æ®å‘å‰æ‹·è´ä¸€ä½ï¼Œå¹¶å°†æ•°ç»„ä¸­æœ€åä¸€ä½ç½®ä¸ºnullï¼Œç­‰å¾…GCã€‚</p>
<pre><code class="language-java">        public E get(int index) {
            if (index &lt; 0 || index &gt;= this.size)
              throw new IndexOutOfBoundsException(outOfBoundsMsg(index));
            if (ArrayList.this.modCount != this.modCount)
                throw new ConcurrentModificationException();
            return (E) ArrayList.this.elementData[offset + index];
        }
</code></pre>
<p>è€Œå› ä¸ºArrayListåœ¨å†…å­˜ä¸­æ˜¯ä¸€ä¸ªè¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥å½“å®ƒå£°æ˜åå®ƒçš„åœ°å€æ˜¯å·²çŸ¥çš„ï¼Œå¦‚æœåœ¨å†…éƒ¨å­˜å…¥ä¸€ä¸ªObjectçš„å¯¹è±¡ï¼ˆ4ä¸ªå­—èŠ‚ï¼‰é‚£ä¹ˆåªéœ€è¦åœ¨è¿™ä¸ªåœ°å€ä¸ŠåŠ 4å°±èƒ½æŸ¥è¯¢åˆ°å¯¹åº”çš„æ•°æ®ã€‚<br>
æ‰€ä»¥ArrayListåœ¨è¿›è¡ŒæŸ¥è¯¢ï¼Œå’Œç›´æ¥æ·»åŠ æ—¶æ•ˆç‡é«˜ï¼Œä½†æ˜¯åœ¨è¿›è¡Œä¸­é—´æ’å…¥ä»¥åŠåˆ é™¤æ—¶ä¼šå› ä¸ºè¦è¿›è¡Œä¸€æ¬¡æ•°æ®æ‹·è´ï¼Œæ•ˆç‡ä¸é«˜ã€‚<br>
ä¸ArrayListé€šå¸¸è¿›è¡Œæ¯”è¾ƒçš„æ˜¯LinkedListï¼Œä¸€ä¸ªç”±é“¾è¡¨æœºæ„æ„æˆçš„æ•°æ®ç»“æ„ï¼Œå®ƒåœ¨å†…å­˜ä¸­ä¸æ˜¯ä¸€å—è¿ç»­çš„ç©ºé—´ï¼ŒåŒå‘é“¾è¡¨ã€‚</p>
<pre><code class="language-java">    private static class Node&lt;E&gt; {
        //å½“å‰èŠ‚ç‚¹
        E item;
        //å‰é©±
        Node&lt;E&gt; next;
        //åé©±
        Node&lt;E&gt; prev;

        Node(Node&lt;E&gt; prev, E element, Node&lt;E&gt; next) {
            this.item = element;
            this.next = next;
            this.prev = prev;
        }
    }
</code></pre>
<p>é“¾è¡¨ç»“æ„å¸¦æ¥çš„å¥½å¤„æ˜¯ï¼Œåœ¨è¿›è¡Œæ•°æ®æ’å…¥å’Œåˆ é™¤æ—¶ï¼Œåªéœ€è¦ä¿®æ”¹èŠ‚ç‚¹çš„å‰é©±å’Œåé©±æŒ‡å‘å°±å¯ä»¥å®ç°ï¼Œå¹¶ä¸éœ€è¦è¿›è¡Œæ•°æ®çš„æ‹·è´ï¼Œä½†æ˜¯å¦‚æœè¦è¿›è¡Œæ•°æ®æŸ¥è¯¢çš„è¯</p>
<pre><code class="language-java">    public void add(int index, E element) {
        checkPositionIndex(index);

        if (index == size)
            linkLast(element);
        else
            linkBefore(element, node(index));
    }
    //è¿”å›æŒ‡å®šä¸‹æ ‡çš„å¯¹è±¡,getçš„å®ç°ä¹Ÿæ˜¯é€šè¿‡è¿™ä¸ªæ–¹æ³•æ¥è¿›è¡Œï¼Œæ‰€ä»¥æˆ‘ä»¬æ²¡æœ‰åŠæ³•é€šè¿‡ç¬¬ä¸€ä¸ªèŠ‚ç‚¹çŸ¥é“ç¬¬10èŠ‚ç‚¹çš„å¯¹è±¡ï¼Œå¿…é¡»è¦è¿›è¡Œå¾ªç¯æŸ¥è¯¢ã€‚
    Node&lt;E&gt; node(int index) {
        // assert isElementIndex(index);

        if (index &lt; (size &gt;&gt; 1)) {
            Node&lt;E&gt; x = first;
            for (int i = 0; i &lt; index; i++)
                x = x.next;
            return x;
        } else {
            Node&lt;E&gt; x = last;
            for (int i = size - 1; i &gt; index; i--)
                x = x.prev;
            return x;
        }
    }
    //åœ¨succä¹‹å‰æ’å…¥ä¸€ä¸ªå…ƒç´ ï¼Œå°±æ˜¯æŠŠsuccçš„å‰é©±èŠ‚ç‚¹è®¾ç½®ç»™eï¼Œpredçš„åé©±æŒ‡å‘eï¼Œsuccçš„å‰é©±æŒ‡å‘eï¼Œè¿™æ ·å°±å®Œæˆäº†æ•°æ®æ’å…¥çš„æ“ä½œã€‚åˆ é™¤åä¹‹ã€‚
    void linkBefore(E e, Node&lt;E&gt; succ) {
        // assert succ != null;
        final Node&lt;E&gt; pred = succ.prev;
        final Node&lt;E&gt; newNode = new Node&lt;&gt;(pred, e, succ);
        succ.prev = newNode;
        if (pred == null)
            first = newNode;
        else
            pred.next = newNode;
        size++;
        modCount++;
    }
</code></pre>
<p>æ‰€ä»¥LinkedListæ˜¯ä¸€ç§å¢åˆ æ•ˆç‡å¿«ï¼Œä½†æ˜¯æŸ¥è¯¢æ…¢çš„æ•°æ®ç»“æ„ã€‚<br>
é‚£ä¹ˆæœ‰æ²¡æœ‰ä¸€ç§æ•°æ®ç»“æ„æ˜¯åŒæ—¶å…·æœ‰ä¸¤è€…ä¼˜ç‚¹çš„ï¼ŒHashMap<br>
HashMapåœ¨1.7ä¹‹å‰åä¹‹åçš„ç‰ˆæœ¬æ˜¯ä¸åŒçš„å®ç°<br>
ä¹‹å‰çš„HashMapç»“æ„æ˜¯ç”±æ•°ç»„â•é“¾è¡¨æ„æˆçš„<br>
ä¹‹åçš„HashMapæ˜¯ç”±æ•°ç»„â•é“¾è¡¨â•çº¢é»‘æ ‘æ„æˆçš„</p>
<p>hashç¢°æ’çš„å‡ºç°ï¼Œä»¥åŠè§£å†³æ–¹æ³•ï¼Ÿ<br>
HashMapçš„é»˜è®¤å¤§å°-ã€‹16</p>
<pre><code class="language-java">  static final int DEFAULT_INITIAL_CAPACITY = 1 &lt;&lt; 4; // aka 16
</code></pre>
<p>HashMapä»€ä¹ˆæ—¶å€™æ‰©å®¹ï¼Ÿç”±ä»€ä¹ˆå†³å®šçš„ï¼Ÿ</p>
<p>é•¿åº¦ä¸º2çš„æ¬¡å¹‚çš„æ„ä¹‰ï¼Ÿ<br>
å‡å°ç¢°æ’çš„å¯èƒ½<br>
ä¾‹å­ï¼š<br>
Length1 =10<br>
Length2= 16</p>
<p>H1  110 = 6<br>
H2 111 = 7</p>
<p>L1 ï¼š9 = 1001<br>
L2 ï¼š15 = 1111</p>
<p>åˆ†åˆ«æ±‚æ¨¡<br>
110<br>
1001   0000</p>
<p>111<br>
1001 0001</p>
<p>110<br>
1111   0110</p>
<p>111<br>
1111 0111<br>
å¯ä»¥å‘ç°é2æ¬¡å¹‚çš„æƒ…å†µä¸‹ï¼Œä¸­é—´ä¸¤ä½ä¸º0ï¼Œé‚£ä¹ˆå®ƒå°±æ²¡æœ‰è®¡ç®—çš„æ„ä¹‰ï¼Œåªæœ‰é«˜ä½å’Œä½ä½æœ‰å†³å®šä½œç”¨ï¼Œè€Œåœ¨2æ¬¡å¹‚çš„æƒ…å†µä¸‹ï¼Œéƒ½ä¸º1é‚£ä¹ˆéƒ½å‚ä¸è¿ç®—ï¼Œå‡å°‘äº†hashcodeçš„å†²çªå¯èƒ½ã€‚</p>
<p>åŠ è½½å› å­ï¼š</p>
<pre><code class="language-java">    static final float DEFAULT_LOAD_FACTOR = 0.75f;
</code></pre>
<p>é˜™å€¼ï¼š0.75*16ï¼ˆlengthï¼‰ = 12ï¼Œå°±æ˜¯å¦‚æœæ˜¯é»˜è®¤é•¿åº¦çš„æƒ…å†µä¸‹ï¼Œå¦‚æœæ•°ç»„é•¿åº¦ã€‹=12çš„è¯ï¼Œé‚£ä¹ˆå°±æ‰©å®¹ã€‚</p>
<p>æ‰©å®¹çš„æ„ä¹‰ï¼šå‡åŒ€åˆ†å¸ƒï¼Œå‡å°å†²çª</p>
<p>Androidç‰¹æœ‰çš„æ•°æ®ç»“æ„ï¼š<br>
SparseArray:åŒæ•°ç»„åˆ†åˆ«å­˜å‚¨keyå’Œvalueï¼Œä½†keyå¿…é¡»ä¸ºintç±»å‹çš„æ•°æ®ï¼Œé€šè¿‡äºŒåˆ†æŸ¥æ‰¾çš„æ–¹å¼å»æŸ¥è¯¢keyçš„ä½ç½®ã€‚<br>
ArrayMap:</p>
<pre><code class="language-java">        mHashes[index] = hash;
        mArray[index&lt;&lt;1] = key;
        mArray[(index&lt;&lt;1)+1] = value;
</code></pre>
<p>é€šè¿‡keyçš„hashå€¼æŸ¥æ‰¾åœ¨mHashesä¸­çš„ä¸‹æ ‡ä½ç½®ï¼Œå¹¶å°†keyå’Œvalueå­˜å…¥å¯¹åº”è§„åˆ™çš„indxä¸‹æ ‡å¯¹åº”çš„ä½ç½®ã€‚<br>
è¿™é‡Œè§£å†³äº†SparseArrayçš„keyåªèƒ½ä¸ºintç±»å‹çš„é™åˆ¶ï¼Œä¹Ÿæ˜¯é€šè¿‡ä¸¤ä¸ªæ•°ç»„å®ç°ï¼Œä¸¤ä¸ªæ•°ç»„åˆ†åˆ«å­˜å‚¨çš„æ˜¯keyçš„Hashå€¼ï¼Œå¦å¤–ä¸€ä¸ªæ•°ç»„å­˜å‚¨çš„æ˜¯keyå’Œvalueï¼Œæ‰€ä»¥mArrayçš„é•¿åº¦æ˜¯mHashesçš„2å€ï¼Œåœ¨mArrayçš„ä¸‹æ ‡ä¹Ÿæ˜¯2å€ä¸ºkeyï¼Œ2å€åŠ 1ä¸ºvalueã€‚<br>
ArrayMapæ˜¯å¦‚ä½•è§£å†³Hashç¢°æ’çš„ï¼š</p>
<pre><code class="language-java">int indexOf(Object key, int hash) {
        final int N = mSize;

        // Important fast case: if nothing is in here, nothing to look for.
        if (N == 0) {
            return ~0;
        }

        int index = binarySearchHashes(mHashes, N, hash);

        // If the hash code wasn't found, then we have no entry for this key.
        if (index &lt; 0) {
            return index;
        }

        // If the key at the returned index matches, that's what we want.
        //é€šè¿‡hashè·å–ä¸€ä¸ªä¸‹æ ‡åï¼Œåœ¨å®é™…å­˜å‚¨keyå’Œvalueçš„æ•°ç»„ä¸­æ‹¿å‡ºæ¥è·Ÿå®é™…çš„keyæ¯”è¾ƒä¸€ä¸‹ï¼Œ
        //å¦‚æœä¸€æ ·è¯´æ˜å°±æ˜¯æˆ‘ä»¬éœ€è¦æŸ¥æ‰¾çš„ä¸‹æ ‡ä½ç½®
        if (key.equals(mArray[index&lt;&lt;1])) {
            return index;
        }

        // Search for a matching key after the index.
        int end;
        //å› ä¸ºå¦‚æœå‡ºç°hashç¢°æ’çš„æƒ…å†µä¸‹ï¼Œä¼šå°†mHashesä¸­å­˜å‚¨çš„indexåŠ 1ç›´åˆ°æ²¡æœ‰å†²çªä¸ºæ­¢
        //ä¸Šä¸€æ­¥è·å–åˆ°çš„keyå’Œå®é™…çš„keyä¸ä¸€æ ·ï¼Œå°±æ˜¯å‡ºç°äº†hashç¢°æ’ï¼Œé‚£ä¹ˆåœ¨ä»¥è¿™ä¸ªindex+1çš„èµ·ç‚¹å‘å³æŸ¥æ‰¾,å› ä¸ºhashå‘ç”Ÿäº†ç¢°æ’ï¼Œé‚£ä¹ˆåœ¨ä¸€ä¸ªèŒƒå›´å†…å­˜å‚¨çš„hashæ˜¯ä¸€æ ·çš„ï¼Œæˆ‘ä»¬åªéœ€è¦åœ¨è¿™ä¸ªä¸€æ ·hashèŒƒå›´å†…æŸ¥æ‰¾
        for (end = index + 1; end &lt; N &amp;&amp; mHashes[end] == hash; end++) {
            if (key.equals(mArray[end &lt;&lt; 1])) return end;
        }
        //å‘å‰æŸ¥æ‰¾
        // Search for a matching key before the index.
        for (int i = index - 1; i &gt;= 0 &amp;&amp; mHashes[i] == hash; i--) {
            if (key.equals(mArray[i &lt;&lt; 1])) return i;
        }

        // Key not found -- return negative value indicating where a
        // new entry for this key should go.  We use the end of the
        // hash chain to reduce the number of array entries that will
        // need to be copied when inserting.
        return ~end;
    }
</code></pre>
<p>æ‰€ä»¥ç›¸å¯¹äºHashMapï¼Œè¿™ä¸¤è€…éƒ½æ˜¯ä¼˜åŒ–äº†å†…å­˜ç©ºé—´çš„ä½¿ç”¨ï¼Œå› ä¸ºHashMapæ˜¯é‡‡ç”¨ç©ºé—´æ¢æ—¶é—´çš„ç­–ç•¥ï¼Œåªè¦åˆ°è¾¾75%çš„å®¹é‡å°±ä¼šç¿»å€æ‰©å®¹ï¼Œå“ªæ€•æ˜¯åªå­˜å‚¨ä¸€ä¸ªæ•°æ®ã€‚</p>
<p>ä½è¿ç®—ï¼š</p>
<ul>
<li>&lt;&lt;: å·¦ç§»è¿ç®—ç¬¦å·ï¼š num&lt;&lt;1 ,ç›¸å½“äºnumä¹˜ä»¥2</li>
<li>
<blockquote>
<blockquote>
<p>: å³ç§»è¿ç®—ç¬¦å·ï¼š num&gt;&gt;1 ,ç›¸å½“äºnumé™¤ä»¥2</p>
</blockquote>
</blockquote>
</li>
<li>
<blockquote>
<blockquote>
<blockquote>
<p>:æ— ç¬¦å·å³ç§»ï¼Œå¿½ç•¥ç¬¦å·ä½ï¼Œç©ºä½éƒ½ä»¥0è¡¥é½</p>
</blockquote>
</blockquote>
</blockquote>
</li>
</ul>
]]></content>
    </entry>
</feed>